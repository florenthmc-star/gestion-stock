<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMC ‚Äî Gestion de Stock</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg:#f5f7fa;--white:#fff;--border:#e2e7ef;--border2:#d0d7e3;
            --blue:#3b6ef8;--blue-dark:#2952d9;--blue-soft:#eff3fe;
            --green:#16a34a;--green-soft:#f0fdf4;--green-border:#bbf7d0;
            --orange:#d97706;--orange-soft:#fffbeb;--orange-border:#fde68a;
            --red:#dc2626;--red-soft:#fef2f2;--red-border:#fecaca;
            --purple:#7c3aed;--purple-soft:#f5f3ff;
            --teal:#0891b2;--teal-soft:#ecfeff;--teal-border:#a5f3fc;
            --text:#111827;--text2:#374151;--text3:#6b7280;
            --r:12px;--r2:8px;
            --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
            --shadow-md:0 4px 12px rgba(0,0,0,.10);
            --shadow-lg:0 10px 30px rgba(0,0,0,.13);
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
        main{flex:1;}

        /* HEADER */
        .header{background:var(--white);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
        .brand{display:flex;align-items:center;gap:12px;}
        .brand-icon{width:36px;height:36px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
        .brand-name{font-size:17px;font-weight:800;}
        .brand-sub{font-size:12px;color:var(--text3);}
        .pill{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:5px;}
        .pill.ok{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border);}
        .pill.loading{background:var(--orange-soft);color:var(--orange);border:1px solid var(--orange-border);}
        .pill.err{background:var(--red-soft);color:var(--red);border:1px solid var(--red-border);}
        .btn-sm{padding:7px 14px;border-radius:var(--r2);font-size:13px;font-weight:600;border:1px solid var(--border2);background:var(--white);color:var(--text2);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
        .btn-sm:hover{background:var(--bg);border-color:var(--blue);color:var(--blue);}

        /* TABS */
        .tabs{background:var(--white);border-bottom:1px solid var(--border);padding:0 28px;display:flex;gap:2px;overflow-x:auto;}
        .tab{padding:0 18px;height:48px;font-size:14px;font-weight:600;color:var(--text3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;gap:7px;}
        .tab:hover{color:var(--text2);background:var(--bg);}
        .tab.active{color:var(--blue);border-bottom-color:var(--blue);}
        .tab-badge{background:var(--red);color:white;padding:1px 6px;border-radius:10px;font-size:10px;font-weight:700;}

        /* PAGE */
        .page{max-width:1100px;margin:0 auto;padding:28px 24px;}
        .pane{display:none;}
        .pane.active{display:block;}
        .page-title{font-size:22px;font-weight:800;margin-bottom:24px;display:flex;align-items:center;gap:10px;}

        /* STATS */
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:24px;}
        .stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:20px 18px;box-shadow:var(--shadow);}
        .stat-card .num{font-size:2em;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1;margin-bottom:6px;}
        .stat-card .lbl{font-size:12px;font-weight:600;color:var(--text3);}
        .stat-card.blue .num{color:var(--blue);}
        .stat-card.green .num{color:var(--green);}
        .stat-card.orange .num{color:var(--orange);}
        .stat-card.red .num{color:var(--red);}
        .stat-card.purple .num{color:var(--purple);}
        .stat-card.teal .num{color:var(--teal);}

        /* CARD */
        .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:24px;box-shadow:var(--shadow);margin-bottom:16px;}

        /* FORM */
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;}
        .fg{display:flex;flex-direction:column;gap:6px;}
        .fg.full{grid-column:1/-1;}
        .fg label{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;}
        .fg input,.fg select,.fg textarea{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:11px 14px;color:var(--text);font-size:14px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;transition:border-color .2s,box-shadow .2s;}
        .fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,110,248,.12);background:var(--white);}

        /* BUTTONS */
        .btn{padding:11px 20px;border-radius:var(--r2);font-size:14px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:7px;}
        .btn:disabled{opacity:.5;cursor:not-allowed;}
        .btn-primary{background:var(--blue);color:white;box-shadow:0 2px 8px rgba(59,110,248,.3);}
        .btn-primary:hover:not(:disabled){background:var(--blue-dark);transform:translateY(-1px);}
        .btn-success{background:var(--green);color:white;}
        .btn-success:hover{opacity:.9;}
        .btn-warning{background:var(--orange);color:white;}
        .btn-warning:hover{opacity:.9;}
        .btn-danger{background:var(--red);color:white;}
        .btn-danger:hover{opacity:.9;}
        .btn-purple{background:var(--purple);color:white;}
        .btn-purple:hover{opacity:.9;}
        .btn-teal{background:var(--teal);color:white;}
        .btn-teal:hover{opacity:.9;}
        .btn-outline{background:white;color:var(--text2);border:1.5px solid var(--border2);}
        .btn-outline:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-soft);}
        .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;}

        /* FILTER */
        .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px 20px;display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px;box-shadow:var(--shadow);}
        .filter-bar select,.filter-bar input{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:9px 14px;color:var(--text);font-size:13px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;min-width:150px;}

        /* ITEMS */
        .article-item{background:var(--white);border:1.5px solid var(--border);border-radius:var(--r);padding:18px 20px;margin-bottom:10px;cursor:pointer;transition:all .18s;box-shadow:var(--shadow);}
        .article-item:hover{border-color:var(--blue);box-shadow:var(--shadow-md);transform:translateY(-1px);}
        .item-head{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:10px;}
        .item-title{font-size:15px;font-weight:700;}
        .item-ref{font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:2px;}
        .item-meta{display:flex;flex-wrap:wrap;gap:14px;}
        .meta{font-size:12px;color:var(--text3);display:flex;align-items:center;gap:4px;}
        .meta strong{color:var(--text2);font-weight:600;}

        /* BADGES */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
        .b-stock{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border);}
        .b-mad{background:var(--blue-soft);color:var(--blue);border:1px solid #c7d7fd;}
        .b-pret{background:var(--orange-soft);color:var(--orange);border:1px solid var(--orange-border);}
        .b-sorti{background:#f3f4f6;color:var(--text3);border:1px solid var(--border2);}
        .b-sav{background:var(--red-soft);color:var(--red);border:1px solid var(--red-border);}
        .b-retard{background:var(--red);color:white;}
        .b-purple{background:var(--purple-soft);color:var(--purple);border:1px solid #ddd6fe;}
        .b-teal{background:var(--teal-soft);color:var(--teal);border:1px solid var(--teal-border);}

        /* MODAL */
        .overlay{display:none;position:fixed;inset:0;background:rgba(17,24,39,.4);z-index:200;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
        .overlay.active{display:flex;}
        .modal{background:var(--white);border-radius:16px;max-width:640px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);}
        .modal-top{padding:22px 28px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;position:sticky;top:0;background:white;z-index:2;}
        .modal-close{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text3);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
        .modal-close:hover{background:var(--red-soft);color:var(--red);border-color:var(--red-border);}
        .modal-body{padding:24px 28px;}

        /* DETAIL GRID */
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
        .detail-field{background:var(--bg);border-radius:var(--r2);padding:12px 14px;border:1px solid var(--border);}
        .detail-field .k{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;}
        .detail-field .v{font-size:14px;font-weight:600;}
        .detail-field.full{grid-column:1/-1;}

        /* HISTO */
        .histo{padding:13px 15px;border-left:3px solid var(--blue);background:var(--bg);border-radius:0 var(--r2) var(--r2) 0;margin-bottom:8px;}
        .histo-date{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
        .histo-action{font-size:13px;font-weight:700;margin:3px 0;}
        .histo-detail{font-size:12px;color:var(--text3);}

        /* ALERTS */
        .alert-item{padding:14px 18px;border-radius:var(--r2);margin-bottom:10px;cursor:pointer;transition:all .15s;display:flex;gap:12px;align-items:flex-start;}
        .alert-item:hover{transform:translateX(3px);}
        .alert-item.danger{background:var(--red-soft);border:1.5px solid var(--red-border);}
        .alert-item.warning{background:var(--orange-soft);border:1.5px solid var(--orange-border);}

        /* PRENOM BAR */
        .prenom-bar{background:var(--blue-soft);border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:16px;}
        .prenom-bar label{font-size:13px;font-weight:700;color:var(--blue);white-space:nowrap;}
        .prenom-bar input{flex:1;background:white;border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:9px 14px;color:var(--text);font-size:14px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;}
        .prenom-bar input:focus{outline:none;border-color:var(--blue);}

        .divider{height:1px;background:var(--border);margin:20px 0;}

        .empty{text-align:center;padding:48px 20px;color:var(--text3);}
        .empty .ico{font-size:40px;margin-bottom:12px;}

        /* QTY */
        .qty-big{font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;}
        .qty-big.ok{color:var(--green);}
        .qty-big.low{color:var(--orange);}
        .qty-big.empty{color:var(--red);}

        /* SUB TABS */
        .sub-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;}
        .sub-tab{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--white);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
        .sub-tab:hover{border-color:var(--blue);color:var(--blue);}
        .sub-tab.active{background:var(--blue);color:white;border-color:var(--blue);}
        .sub-tab.warn.active{background:var(--orange);border-color:var(--orange);}
        .sub-tab.danger.active{background:var(--red);border-color:var(--red);}
        .sub-tab.purple.active{background:var(--purple);border-color:var(--purple);}

        /* FOOTER */
        footer{background:var(--white);border-top:1px solid var(--border);text-align:center;padding:14px;font-size:12px;color:var(--text3);}

        /* ALERT SETTINGS */
        .settings-section{margin-bottom:24px;}
        .settings-section h3{font-size:14px;font-weight:700;color:var(--text2);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
        .setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--white);border:1px solid var(--border);border-radius:var(--r2);margin-bottom:8px;gap:16px;flex-wrap:wrap;}
        .setting-row label{font-size:13px;font-weight:600;color:var(--text2);}
        .setting-row .setting-input{display:flex;align-items:center;gap:8px;}
        .setting-row input[type=number]{width:70px;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--r2);font-size:14px;font-weight:600;text-align:center;background:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;}
        .setting-row input[type=number]:focus{outline:none;border-color:var(--blue);}
        .setting-row span{font-size:12px;color:var(--text3);}

        /* EDIT MODE TOGGLE */
        .edit-toggle{background:var(--orange-soft);border:1.5px solid var(--orange-border);border-radius:var(--r2);padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
        .edit-toggle span{font-size:13px;font-weight:600;color:var(--orange);}

        /* ARTICLE EDIT FORM */
        .edit-form{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:16px;margin-bottom:16px;}
        .edit-form .form-grid{gap:12px;}
        .edit-form input,.edit-form select{background:white;border:1.5px solid var(--border);border-radius:var(--r2);padding:9px 12px;color:var(--text);font-size:13px;font-family:'Plus Jakarta Sans',sans-serif;width:100%;}
        .edit-form input:focus,.edit-form select:focus{outline:none;border-color:var(--blue);}

        @media(max-width:640px){
            .page{padding:16px;}
            .header{padding:0 16px;}
            .tabs{padding:0 16px;}
            .detail-grid{grid-template-columns:1fr;}
            .brand-sub{display:none;}
            .stats-row{grid-template-columns:repeat(2,1fr);}
            .modal-body{padding:16px 18px;}
        }

        /* QR PRINT STYLES ‚Äî uniquement dans fen√™tre impression */
        @media print {
            .no-print{display:none!important;}
        }
    </style>
</head>
<body>
<main>

<!-- HEADER -->
<div class="header">
    <div class="brand">
        <div class="brand-icon">üì¶</div>
        <div>
            <div class="brand-name">HMC Stock</div>
            <div class="brand-sub">Gestion multi-magasins</div>
        </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
        <div class="pill loading" id="statusPill">üîÑ Connexion...</div>
        <button class="btn-sm" onclick="loadData()">‚Üª Actualiser</button>
    </div>
</div>

<!-- TABS -->
<div class="tabs">
    <button class="tab active" onclick="switchTab('reception',this)">üì• R√©ception</button>
    <button class="tab" onclick="switchTab('mad',this)">üöö Mises √† dispo <span class="tab-badge" id="madBadge" style="display:none">0</span></button>
    <button class="tab" onclick="switchTab('stock',this)">üì¶ Stock</button>
    <button class="tab" onclick="switchTab('prets',this)">üîÑ Pr√™ts <span class="tab-badge" id="retardBadge" style="display:none">0</span></button>
    <button class="tab" onclick="switchTab('alertes',this)">üîî Alertes <span class="tab-badge" id="alertBadge" style="display:none">0</span></button>
    <button class="tab" onclick="switchTab('parametres',this)">‚öôÔ∏è Param√®tres</button>
</div>

<div class="page">

    <!-- ‚ïê‚ïê‚ïê R√âCEPTION ‚ïê‚ïê‚ïê -->
    <div id="reception" class="pane active">
        <div class="page-title">üì• R√©ception d'Article</div>
        <div class="card">
            <form id="receptionForm">
                <div class="form-grid">
                    <div class="fg">
                        <label>Magasin *</label>
                        <select id="f_magasin" required onchange="onMagasinChange()">
                            <option value="">S√©lectionner...</option>
                            <option>Lattes</option><option>Ved√®ne</option>
                            <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Type *</label>
                        <select id="f_type" required onchange="toggleFormFields()">
                            <option value="">S√©lectionner...</option>
                            <option value="Mise √† disposition">üöö Mise √† disposition (client/SAV)</option>
                            <option value="Stock">üì¶ Stock</option>
                            <option value="Article de pr√™t">üîÑ Article de pr√™t</option>
                        </select>
                    </div>

                    <!-- Client : masqu√© pour Stock -->
                    <div class="fg" id="clientGroup">
                        <label id="clientLabel">Nom du Client *</label>
                        <input id="f_client" type="text" placeholder="Nom du client">
                    </div>

                    <!-- N¬∞ AR : masqu√© pour Stock -->
                    <div class="fg" id="arGroup">
                        <label>N¬∞ AR</label>
                        <input id="f_ar" type="text" placeholder="Num√©ro AR">
                    </div>

                    <div class="fg">
                        <label>Article *</label>
                        <input id="f_article" type="text" required placeholder="Nom de l'article">
                    </div>
                    <div class="fg">
                        <label>R√©f√©rence *</label>
                        <input id="f_ref" type="text" required placeholder="R√©f√©rence">
                    </div>

                    <!-- Colis : masqu√© pour Stock -->
                    <div class="fg" id="colisGroup">
                        <label>Nombre de Colis *</label>
                        <input id="f_colis" type="number" min="1" value="1">
                    </div>

                    <!-- Quantit√© : visible pour Stock uniquement -->
                    <div class="fg" id="qtyGroup" style="display:none">
                        <label>Quantit√© en Stock *</label>
                        <input id="f_qty" type="number" min="1" value="1">
                    </div>

                    <!-- Seuil alerte : visible pour Stock uniquement -->
                    <div class="fg" id="seuilGroup" style="display:none">
                        <label>Seuil d'alerte stock faible</label>
                        <input id="f_seuil" type="number" min="0" value="5" placeholder="Ex: 5">
                        <span style="font-size:11px;color:var(--text3);">Alerte si quantit√© ‚â§ ce nombre</span>
                    </div>

                    <!-- Emplacement : texte libre sauf Lattes -->
                    <div class="fg" id="emplacementGroup">
                        <label>Emplacement *</label>
                        <input id="f_emplacement_text" type="text" placeholder="Ex: Rayon A, √âtag√®re 3">
                        <select id="f_emplacement_select" style="display:none">
                            <option value="">S√©lectionner...</option>
                            <option>R√©serve</option>
                            <option>Bureau en haut</option>
                            <option>Accueil</option>
                        </select>
                    </div>

                    <div class="fg">
                        <label>Votre Pr√©nom *</label>
                        <input id="f_prenom" type="text" required placeholder="Votre pr√©nom">
                    </div>
                    <div class="fg full">
                        <label>Notes</label>
                        <textarea id="f_notes" rows="2" placeholder="Observations..."></textarea>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit" class="btn btn-primary" id="submitBtn">‚úÖ G√©n√©rer le QR Code</button>
                </div>
            </form>
        </div>

        <!-- QR R√âSULTAT -->
        <div id="qrResult" style="display:none">
            <div class="card" style="text-align:center;padding:32px 24px;border:1.5px solid #c7d7fd;background:var(--blue-soft);">
                <div style="font-size:16px;font-weight:800;margin-bottom:4px;">‚úÖ Article enregistr√©</div>
                <p style="font-size:13px;color:var(--text3);margin-bottom:20px;">Le QR code est pr√™t √† imprimer et coller sur le colis</p>
                <div id="qrcode" style="display:inline-block;background:white;padding:16px;border-radius:var(--r2);box-shadow:var(--shadow-md);margin-bottom:20px;"></div>
                <div id="qrInfos" style="margin-bottom:20px;font-size:14px;color:var(--text2);line-height:1.8;"></div>
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="printQR()">üñ®Ô∏è Imprimer l'√©tiquette</button>
                    <button class="btn btn-outline" onclick="resetForm()">‚ûï Nouvel article</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MISES √Ä DISPO ‚ïê‚ïê‚ïê -->
    <div id="mad" class="pane">
        <div class="page-title">üöö Mises √† Disposition</div>
        <div class="stats-row" id="madStats"></div>
        <div class="filter-bar">
            <select id="m_mag" onchange="renderMAD()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>Ved√®ne</option>
                <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
            </select>
            <select id="m_stat" onchange="renderMAD()">
                <option value="">Tous les statuts</option>
                <option value="Stock">En stock</option>
                <option value="Sorti">Sorti</option>
                <option value="SAV">SAV</option>
            </select>
            <input id="m_search" placeholder="üîç Rechercher..." oninput="renderMAD()" style="flex:1;min-width:200px;">
        </div>
        <div id="madList"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STOCK ‚ïê‚ïê‚ïê -->
    <div id="stock" class="pane">
        <div class="page-title">üì¶ Gestion du Stock</div>
        <div class="stats-row" id="stockStats"></div>
        <div class="filter-bar">
            <select id="s_mag" onchange="renderStock()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>Ved√®ne</option>
                <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
            </select>
            <input id="s_search" placeholder="üîç Rechercher..." oninput="renderStock()" style="flex:1;min-width:200px;">
        </div>
        <div id="stockList"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PR√äTS ‚ïê‚ïê‚ïê -->
    <div id="prets" class="pane">
        <div class="page-title">üîÑ Gestion des Pr√™ts</div>
        <div class="stats-row" id="pretsStats"></div>
        <div class="filter-bar">
            <select id="p_mag" onchange="renderPrets()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>Ved√®ne</option>
                <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
            </select>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab purple active" id="stab_dispo" onclick="setPretTab('dispo')">üü£ Disponibles</button>
            <button class="sub-tab active" id="stab_encours" onclick="setPretTab('encours')">üîµ En cours</button>
            <button class="sub-tab warn" id="stab_bientot" onclick="setPretTab('bientot')">üü° Bient√¥t</button>
            <button class="sub-tab danger" id="stab_retard" onclick="setPretTab('retard')">üî¥ En retard</button>
        </div>
        <div id="pretsList"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê ALERTES ‚ïê‚ïê‚ïê -->
    <div id="alertes" class="pane">
        <div class="page-title">üîî Alertes</div>
        <div class="filter-bar">
            <select id="a_mag" onchange="renderAlertes()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>Ved√®ne</option>
                <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
            </select>
        </div>
        <div id="alertList"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PARAM√àTRES ALERTES ‚ïê‚ïê‚ïê -->
    <div id="parametres" class="pane">
        <div class="page-title">‚öôÔ∏è Param√®tres des Alertes</div>

        <div class="card">
            <div class="settings-section">
                <h3>üìÖ Alertes pr√™ts ‚Äî D√©lai avant retour</h3>
                <div class="setting-row">
                    <label>Alerte "Retour bient√¥t" √† partir de</label>
                    <div class="setting-input">
                        <input type="number" id="param_alerte_bientot" min="1" max="30" value="3">
                        <span>jours avant la date de retour</span>
                    </div>
                </div>
                <div class="setting-row">
                    <label>Alerte "Urgence" √† partir de</label>
                    <div class="setting-input">
                        <input type="number" id="param_alerte_urgent" min="0" max="10" value="1">
                        <span>jours avant (0 = le jour m√™me)</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>üì¶ Alertes stock ‚Äî Seuil par d√©faut</h3>
                <div class="setting-row">
                    <label>Alerte stock faible si quantit√© ‚â§</label>
                    <div class="setting-input">
                        <input type="number" id="param_stock_faible" min="1" max="100" value="5">
                        <span>unit√©s (d√©faut pour tous les articles)</span>
                    </div>
                </div>
                <p style="font-size:12px;color:var(--text3);margin-top:8px;">üí° Vous pouvez d√©finir un seuil personnalis√© par article en ouvrant sa fiche et en cliquant sur "‚öôÔ∏è Seuil d'alerte"</p>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveParams()">üíæ Enregistrer les param√®tres</button>
                <button class="btn btn-outline" onclick="resetParams()">‚Ü∫ R√©initialiser</button>
            </div>
        </div>

        <div class="card">
            <div class="settings-section">
                <h3>üìã Seuils personnalis√©s par article Stock</h3>
                <p style="font-size:13px;color:var(--text3);margin-bottom:16px;">Ouvrez la fiche d'un article Stock pour d√©finir son seuil d'alerte individuel.</p>
                <div id="seuilsListe"></div>
            </div>
        </div>
    </div>

</div><!-- /page -->

</main>

<!-- MODAL -->
<div class="overlay" id="overlay">
    <div class="modal">
        <div class="modal-top">
            <div>
                <div style="font-size:18px;font-weight:800;" id="mTitle">Article</div>
                <div style="font-size:12px;color:var(--text3);margin-top:3px;" id="mSub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="mBody"></div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    ¬© 2026 Florent Amendola ‚Äî HMC Stock ¬∑ Tous droits r√©serv√©s
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ö†Ô∏è  REMPLACEZ VOTRE_URL_ICI  ‚ö†Ô∏è
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL = 'https://script.google.com/macros/s/AKfycbw4iOVF_nKgOsFhdXDdJRGziUPDKw-qAj4QLU3CadpeqBYVyTLiUxa9WM5bGFUDsFmAiA/exec';
const APP_URL = window.location.origin + window.location.pathname;

let articles = [];
let histoCache = {};
let currentPretTab = 'dispo';
let lastQRData = null; // pour impression

// Param√®tres alertes (localStorage)
let params = { alerteBientot: 3, alerteUrgent: 1, stockFaible: 5 };
let seuilsPerso = {}; // { articleId: nombre }

function loadParams() {
    // Charger depuis localStorage en attendant (sera surcharg√© par l'API)
    try {
        const p = localStorage.getItem('hmc_params');
        if (p) params = { ...params, ...JSON.parse(p) };
        const s = localStorage.getItem('hmc_seuils');
        if (s) seuilsPerso = JSON.parse(s);
    } catch(e) {}
    document.getElementById('param_alerte_bientot').value = params.alerteBientot;
    document.getElementById('param_alerte_urgent').value = params.alerteUrgent;
    document.getElementById('param_stock_faible').value = params.stockFaible;
    // Tenter de charger depuis Google Sheets
    loadParamsFromAPI();
}

async function loadParamsFromAPI() {
    const data = await apiCall({ action: 'getParams' });
    if (data && !data.error && data.params) {
        try {
            const p = typeof data.params === 'string' ? JSON.parse(data.params) : data.params;
            params = { ...params, ...p };
            document.getElementById('param_alerte_bientot').value = params.alerteBientot;
            document.getElementById('param_alerte_urgent').value = params.alerteUrgent;
            document.getElementById('param_stock_faible').value = params.stockFaible;
        } catch(e) {}
    }
    if (data && !data.error && data.seuils) {
        try {
            const s = typeof data.seuils === 'string' ? JSON.parse(data.seuils) : data.seuils;
            seuilsPerso = { ...seuilsPerso, ...s };
        } catch(e) {}
    }
}

async function saveParamsToAPI() {
    await apiCall({
        action: 'saveParams',
        params: JSON.stringify(params),
        seuils: JSON.stringify(seuilsPerso)
    });
    // Aussi en local comme backup
    localStorage.setItem('hmc_params', JSON.stringify(params));
    localStorage.setItem('hmc_seuils', JSON.stringify(seuilsPerso));
}

async function saveSeuilsToAPI() {
    localStorage.setItem('hmc_seuils', JSON.stringify(seuilsPerso));
    await apiCall({ action: 'saveParams', params: JSON.stringify(params), seuils: JSON.stringify(seuilsPerso) });
}

function saveParams() {
    params.alerteBientot = parseInt(document.getElementById('param_alerte_bientot').value) || 3;
    params.alerteUrgent = parseInt(document.getElementById('param_alerte_urgent').value) || 1;
    params.stockFaible = parseInt(document.getElementById('param_stock_faible').value) || 5;
    saveParamsToAPI().then(() => {
        alert('‚úÖ Param√®tres enregistr√©s et synchronis√©s sur tous les appareils !');
        renderAlertes();
    });
}

function resetParams() {
    params = { alerteBientot: 3, alerteUrgent: 1, stockFaible: 5 };
    saveParamsToAPI().then(() => {
        loadParams();
        alert('‚úÖ Param√®tres r√©initialis√©s');
    });
}

function renderSeuilsListe() {
    const stocks = articles.filter(a => a.type === 'Stock');
    if (!stocks.length) { document.getElementById('seuilsListe').innerHTML = '<p style="color:var(--text3);font-size:13px;">Aucun article en stock.</p>'; return; }
    document.getElementById('seuilsListe').innerHTML = stocks.map(a => {
        const seuil = seuilsPerso[a.id] !== undefined ? seuilsPerso[a.id] : params.stockFaible;
        return `<div class="setting-row">
            <div><div style="font-size:13px;font-weight:600;">${a.article}</div><div style="font-size:11px;color:var(--text3);">${a.reference} ¬∑ ${a.magasin}</div></div>
            <div class="setting-input">
                <input type="number" min="0" value="${seuil}" style="width:60px;padding:7px;border:1.5px solid var(--border);border-radius:var(--r2);text-align:center;font-family:'Plus Jakarta Sans',sans-serif;" onchange="setSeuil('${a.id}', this.value)">
                <span>unit√©s</span>
            </div>
        </div>`;
    }).join('');
}

function setSeuil(id, val) {
    seuilsPerso[id] = parseInt(val) || 0;
    saveSeuilsToAPI();
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
    loadParams();
    if (API_URL === 'VOTRE_URL_ICI') {
        alert('‚ö†Ô∏è Configurez votre URL Google Apps Script dans le code.');
        return;
    }
    const p = new URLSearchParams(window.location.search).get('article');
    if (p) loadData().then(() => openModal(p));
    else loadData();
});

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function apiCall(params_) {
    return new Promise(resolve => {
        const cb = 'cb' + Date.now() + Math.random().toString(36).slice(2,7);
        let done = false;
        const cleanup = () => { done=true; delete window[cb]; const s=document.getElementById(cb); if(s) s.remove(); };
        window[cb] = data => { cleanup(); resolve(data || {}); };
        const qs = new URLSearchParams({ ...params_, callback: cb }).toString();
        const s = document.createElement('script');
        s.id = cb; s.src = `${API_URL}?${qs}`;
        s.onerror = () => { cleanup(); resolve({ error: 'Network error' }); };
        setTimeout(() => { if (!done) { cleanup(); resolve({ error: 'Timeout' }); } }, 20000);
        document.body.appendChild(s);
    });
}

function loadData() {
    setStatus('loading','üîÑ Chargement...');
    return new Promise(async (resolve,reject) => {
        const data = await apiCall({ action:'getAllArticles', t: Date.now() });
        if (data.error) { setStatus('err','‚ùå D√©connect√©'); reject(); return; }
        articles = parseArticles(Array.isArray(data) ? data : []);
        setStatus('ok', `‚úÖ ${articles.length} articles`);
        refreshBadges();
        refreshCurrentPane();
        resolve();
    });
}

function parseArticles(data) {
    return data.map(r => ({
        id: r.ID||'', magasin: r.Magasin||'', type: r.Type||'',
        client: r.Client||'', numeroAR: r.NumeroAR||'',
        article: r.Article||'', reference: r.Reference||'',
        nombreColis: parseInt(r.NombreColis)||1,
        quantiteStock: (r.QuantiteStock!==null&&r.QuantiteStock!=='') ? parseInt(r.QuantiteStock) : null,
        quantiteInitiale: (r.QuantiteInitiale!==null&&r.QuantiteInitiale!=='') ? parseInt(r.QuantiteInitiale) : null,
        emplacement: r.Emplacement||'', kitchener: r.Kitchener||'',
        notes: r.Notes||'', statut: r.Statut||'Stock',
        dateReception: r.DateReception||'', datePret: r.DatePret||'',
        prenomEmprunteur: r.PrenomEmprunteur||'',
        dateRetourPrevue: r.DateRetourPrevue||'',
        dateRetourReel: r.DateRetourReel||'',
        dateSortie: r.DateSortie||'', raisonSortie: r.RaisonSortie||''
    }));
}

function setStatus(cls,msg) { const e=document.getElementById('statusPill'); e.className='pill '+cls; e.textContent=msg; }

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name,el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById(name).classList.add('active');
    refreshCurrentPane();
}

function refreshCurrentPane() {
    const a = document.querySelector('.pane.active');
    if (!a) return;
    const id = a.id;
    if (id==='mad') renderMAD();
    if (id==='stock') renderStock();
    if (id==='prets') renderPrets();
    if (id==='alertes') renderAlertes();
    if (id==='parametres') renderSeuilsListe();
}

function refreshBadges() {
    const retards = articles.filter(a=>a.statut==='Pr√™t'&&a.dateRetourPrevue&&new Date(a.dateRetourPrevue)<new Date()).length;
    const rb=document.getElementById('retardBadge'); rb.textContent=retards; rb.style.display=retards>0?'inline':'none';
    const madSAV = articles.filter(a=>a.type==='Mise √† disposition'&&a.statut==='SAV').length;
    const mb=document.getElementById('madBadge'); mb.textContent=madSAV; mb.style.display=madSAV>0?'inline':'none';
    const alertCnt = retards + articles.filter(a=>{
        const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        return a.type==='Stock'&&a.quantiteStock!==null&&a.quantiteStock<=s;
    }).length;
    const ab=document.getElementById('alertBadge'); ab.textContent=alertCnt; ab.style.display=alertCnt>0?'inline':'none';
}

// ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onMagasinChange() {
    const mag = document.getElementById('f_magasin').value;
    const txt = document.getElementById('f_emplacement_text');
    const sel = document.getElementById('f_emplacement_select');
    if (mag === 'Lattes') {
        txt.style.display = 'none'; txt.required = false;
        sel.style.display = 'block'; sel.required = true;
    } else {
        txt.style.display = 'block'; txt.required = true;
        sel.style.display = 'none'; sel.required = false;
    }
}

function getEmplacement() {
    const mag = document.getElementById('f_magasin').value;
    return mag === 'Lattes'
        ? document.getElementById('f_emplacement_select').value
        : document.getElementById('f_emplacement_text').value;
}

function toggleFormFields() {
    const t = document.getElementById('f_type').value;
    const isStock = t === 'Stock';
    document.getElementById('qtyGroup').style.display = isStock ? 'flex' : 'none';
    document.getElementById('f_qty').required = isStock;
    document.getElementById('seuilGroup').style.display = isStock ? 'flex' : 'none';
    document.getElementById('clientGroup').style.display = isStock ? 'none' : 'flex';
    document.getElementById('f_client').required = !isStock;
    document.getElementById('arGroup').style.display = isStock ? 'none' : 'flex';
    document.getElementById('colisGroup').style.display = isStock ? 'none' : 'flex';
    document.getElementById('f_colis').required = !isStock;
    if (isStock) document.getElementById('f_colis').value = '1';
}

function resetForm() {
    document.getElementById('receptionForm').reset();
    document.getElementById('receptionForm').style.display = 'block';
    document.getElementById('qrResult').style.display = 'none';
    document.getElementById('qtyGroup').style.display = 'none';
    document.getElementById('seuilGroup').style.display = 'none';
    document.getElementById('clientGroup').style.display = 'flex';
    document.getElementById('arGroup').style.display = 'flex';
    document.getElementById('colisGroup').style.display = 'flex';
    document.getElementById('f_client').required = true;
    document.getElementById('f_colis').required = true;
    document.getElementById('f_emplacement_text').style.display = 'block';
    document.getElementById('f_emplacement_select').style.display = 'none';
}

document.getElementById('receptionForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled=true; btn.textContent='‚è≥ Enregistrement...';

    const type = document.getElementById('f_type').value;
    const isStock = type === 'Stock';
    const id = 'ART-' + Date.now();
    const now = new Date().toISOString();
    const emplacement = getEmplacement();
    const client = isStock ? 'Stock interne' : document.getElementById('f_client').value;
    const article = document.getElementById('f_article').value;
    const reference = document.getElementById('f_ref').value;
    const colis = isStock ? '1' : document.getElementById('f_colis').value;
    const magasin = document.getElementById('f_magasin').value;

    const r = await apiCall({
        action:'addArticle', ID:id, Magasin:magasin, Type:type, Client:client,
        NumeroAR: isStock ? '' : (document.getElementById('f_ar').value||''),
        Article:article, Reference:reference, NombreColis:colis,
        QuantiteStock: isStock ? document.getElementById('f_qty').value : '',
        QuantiteInitiale: isStock ? document.getElementById('f_qty').value : '',
        Emplacement:emplacement, Kitchener:document.getElementById('f_prenom').value,
        Notes:document.getElementById('f_notes').value||'',
        Statut:'Stock', DateReception:now, Historique:'true'
    });

    btn.disabled=false; btn.textContent='‚úÖ G√©n√©rer le QR Code';

    if (r.error) { alert('‚ùå Erreur : '+r.error); return; }

    // Sauvegarder le seuil d'alerte personnalis√© si Stock
    if (isStock) {
        const seuilVal = parseInt(document.getElementById('f_seuil').value) || params.stockFaible;
        seuilsPerso[id] = seuilVal;
        saveSeuilsToAPI();
    }

    // Donn√©es pour l'impression
    lastQRData = { id, article, reference, client, magasin, type, colis, emplacement };

    // Afficher QR
    const url = `${APP_URL}?article=${id}`;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text:url, width:200, height:200 });

    // Infos sous le QR
    document.getElementById('qrInfos').innerHTML = `
        <strong>${article}</strong><br>
        ${type !== 'Stock' ? `Client : <strong>${client}</strong><br>` : ''}
        ${type === 'Mise √† disposition' && colis > 1 ? `Colis : <strong>${colis}</strong><br>` : ''}
        R√©f : ${reference} &nbsp;¬∑&nbsp; ${magasin}
    `;

    document.getElementById('receptionForm').style.display = 'none';
    document.getElementById('qrResult').style.display = 'block';
    setTimeout(() => loadData(), 2000);
});

// ‚îÄ‚îÄ‚îÄ IMPRESSION QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function printQR() {
    if (!lastQRData) return;
    const { id, article, reference, client, magasin, type, colis } = lastQRData;
    const url = `${APP_URL}?article=${id}`;
    const w = window.open('', '_blank', 'width=380,height=520');
    w.document.write(`<!DOCTYPE html><html><head>
        <meta charset="UTF-8">
        <title>√âtiquette ‚Äî ${article}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
        <style>
            @page { size: 10cm 14cm; margin: 0; }
            body { font-family: 'Segoe UI', Arial, sans-serif; background: white; margin: 0; padding: 20px; box-sizing: border-box; width: 10cm; }
            .top { border-bottom: 2px solid #1e40af; padding-bottom: 10px; margin-bottom: 12px; }
            .brand { font-size: 11px; font-weight: 700; color: #1e40af; letter-spacing: 1px; text-transform: uppercase; }
            .type-badge { display: inline-block; background: #1e40af; color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-top: 4px; }
            .article-name { font-size: 17px; font-weight: 800; color: #111827; margin: 12px 0 4px; line-height: 1.2; }
            .info-line { font-size: 12px; color: #374151; margin: 3px 0; }
            .info-line strong { color: #111827; }
            #qr { text-align: center; margin: 14px 0; }
            .id-line { font-size: 9px; color: #9ca3af; font-family: monospace; text-align: center; margin-top: 4px; }
            .footer { border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 10px; font-size: 10px; color: #6b7280; text-align: center; }
        </style>
        </head><body>
        <div class="top">
            <div class="brand">HMC ‚Äî Gestion de Stock</div>
            <span class="type-badge">${type}</span>
        </div>
        <div class="article-name">${article}</div>
        ${type !== 'Stock' && client && client !== 'Stock interne' ? `<div class="info-line">üë§ Client : <strong>${client}</strong></div>` : ''}
        ${type === 'Mise √† disposition' && parseInt(colis) > 1 ? `<div class="info-line">üì¶ Nombre de colis : <strong>${colis}</strong></div>` : ''}
        <div class="info-line">üè∑Ô∏è R√©f : <strong>${reference}</strong></div>
        <div class="info-line">üè™ Magasin : <strong>${magasin}</strong></div>
        <div id="qr"></div>
        <div class="id-line">${id}</div>
        <div class="footer">Scannez avec l'appareil photo ¬∑ ¬© 2026 Florent Amendola</div>
        <script>
            new QRCode(document.getElementById('qr'), { text: '${url}', width: 180, height: 180 });
            setTimeout(() => { window.print(); }, 800);
        <\/script>
        </body></html>`);
    w.document.close();
}

// ‚îÄ‚îÄ‚îÄ IMPRESSION QR depuis fiche ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function printArticleQR(id) {
    const a = articles.find(x=>x.id===id);
    if (!a) return;
    const url = `${APP_URL}?article=${id}`;
    const w = window.open('', '_blank', 'width=380,height=520');
    w.document.write(`<!DOCTYPE html><html><head>
        <meta charset="UTF-8"><title>√âtiquette ‚Äî ${a.article}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
        <style>
            @page { size: 10cm 14cm; margin: 0; }
            body { font-family: 'Segoe UI', Arial, sans-serif; background: white; margin: 0; padding: 20px; box-sizing: border-box; width: 10cm; }
            .top { border-bottom: 2px solid #1e40af; padding-bottom: 10px; margin-bottom: 12px; }
            .brand { font-size: 11px; font-weight: 700; color: #1e40af; letter-spacing: 1px; text-transform: uppercase; }
            .type-badge { display: inline-block; background: #1e40af; color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-top: 4px; }
            .article-name { font-size: 17px; font-weight: 800; color: #111827; margin: 12px 0 4px; line-height: 1.2; }
            .info-line { font-size: 12px; color: #374151; margin: 3px 0; }
            .info-line strong { color: #111827; }
            #qr { text-align: center; margin: 14px 0; }
            .id-line { font-size: 9px; color: #9ca3af; font-family: monospace; text-align: center; margin-top: 4px; }
            .footer { border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 10px; font-size: 10px; color: #6b7280; text-align: center; }
        </style></head><body>
        <div class="top">
            <div class="brand">HMC ‚Äî Gestion de Stock</div>
            <span class="type-badge">${a.type}</span>
        </div>
        <div class="article-name">${a.article}</div>
        ${a.type !== 'Stock' && a.client && a.client !== 'Stock interne' ? `<div class="info-line">üë§ Client : <strong>${a.client}</strong></div>` : ''}
        ${a.type === 'Mise √† disposition' && a.nombreColis > 1 ? `<div class="info-line">üì¶ Colis : <strong>${a.nombreColis}</strong></div>` : ''}
        <div class="info-line">üè∑Ô∏è R√©f : <strong>${a.reference}</strong></div>
        <div class="info-line">üè™ Magasin : <strong>${a.magasin}</strong></div>
        <div id="qr"></div>
        <div class="id-line">${id}</div>
        <div class="footer">Scannez avec l'appareil photo ¬∑ ¬© 2026 Florent Amendola</div>
        <script>
            new QRCode(document.getElementById('qr'), { text: '${url}', width: 180, height: 180 });
            setTimeout(() => window.print(), 800);
        <\/script>
        </body></html>`);
    w.document.close();
}

// ‚îÄ‚îÄ‚îÄ MISES √Ä DISPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMAD() {
    const mag = document.getElementById('m_mag').value;
    const stat = document.getElementById('m_stat').value;
    const q = document.getElementById('m_search').value.toLowerCase();

    // Stats filtr√©es par magasin s√©lectionn√©
    const allFiltered = mag ? articles.filter(a=>a.type==='Mise √† disposition'&&a.magasin===mag) : articles.filter(a=>a.type==='Mise √† disposition');

    document.getElementById('madStats').innerHTML = `
        <div class="stat-card blue"><div class="num">${allFiltered.length}</div><div class="lbl">Total${mag?' ‚Äî '+mag:''}</div></div>
        <div class="stat-card green"><div class="num">${allFiltered.filter(a=>a.statut==='Stock').length}</div><div class="lbl">En stock</div></div>
        <div class="stat-card orange"><div class="num">${allFiltered.filter(a=>a.statut==='Sorti').length}</div><div class="lbl">Sortis</div></div>
        <div class="stat-card red"><div class="num">${allFiltered.filter(a=>a.statut==='SAV').length}</div><div class="lbl">SAV</div></div>
    `;

    let list = allFiltered.slice();
    if (stat) list = list.filter(a => a.statut === stat);
    if (q) list = list.filter(a =>
        (a.article||'').toLowerCase().includes(q) ||
        (a.client||'').toLowerCase().includes(q) ||
        (a.reference||'').toLowerCase().includes(q) ||
        (a.numeroAR||'').toLowerCase().includes(q) ||
        (a.emplacement||'').toLowerCase().includes(q) ||
        (a.kitchener||'').toLowerCase().includes(q)
    );

    if (!list.length) { document.getElementById('madList').innerHTML='<div class="empty"><div class="ico">üì≠</div><p>Aucun article</p></div>'; return; }

    const bMap={Stock:'b-stock',Pr√™t:'b-pret',Sorti:'b-sorti',SAV:'b-sav'};
    document.getElementById('madList').innerHTML = list.map(a=>`
        <div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div>
                    <div class="item-title">${a.article}</div>
                    <div class="item-ref">${a.reference}</div>
                    ${a.client&&a.client!=='Stock interne'?`<div style="font-size:14px;font-weight:800;color:var(--text);margin-top:4px;">üë§ ${a.client}</div>`:''}
                </div>
                <span class="badge ${bMap[a.statut]||'b-stock'}">${a.statut}</span>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                ${a.numeroAR?`<span class="meta">AR: <strong>${a.numeroAR}</strong></span>`:''}
                ${a.nombreColis>1?`<span class="meta">üì¶ <strong>${a.nombreColis} colis</strong></span>`:''}
            </div>
        </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ STOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStock() {
    const mag = document.getElementById('s_mag').value;
    const q = document.getElementById('s_search').value.toLowerCase();

    const allFiltered = mag ? articles.filter(a=>a.type==='Stock'&&a.magasin===mag) : articles.filter(a=>a.type==='Stock');

    document.getElementById('stockStats').innerHTML = `
        <div class="stat-card green"><div class="num">${allFiltered.filter(a=>a.statut==='Stock').length}</div><div class="lbl">R√©f√©rences${mag?' ‚Äî '+mag:''}</div></div>
        <div class="stat-card blue"><div class="num">${allFiltered.reduce((s,a)=>s+(a.quantiteStock||0),0)}</div><div class="lbl">Quantit√© totale</div></div>
        <div class="stat-card orange"><div class="num">${allFiltered.filter(a=>{const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;return a.quantiteStock!==null&&a.quantiteStock>0&&a.quantiteStock<=s;}).length}</div><div class="lbl">Stocks faibles</div></div>
        <div class="stat-card red"><div class="num">${allFiltered.filter(a=>a.quantiteStock===0).length}</div><div class="lbl">√âpuis√©s</div></div>
    `;

    let list = allFiltered.slice();
    if (q) list = list.filter(a =>
        (a.article||'').toLowerCase().includes(q) ||
        (a.reference||'').toLowerCase().includes(q) ||
        (a.emplacement||'').toLowerCase().includes(q) ||
        (a.notes||'').toLowerCase().includes(q)
    );

    if (!list.length) { document.getElementById('stockList').innerHTML='<div class="empty"><div class="ico">üì¶</div><p>Aucun article en stock</p></div>'; return; }

    document.getElementById('stockList').innerHTML = list.map(a => {
        const qty = a.quantiteStock;
        const seuil = seuilsPerso[a.id] !== undefined ? seuilsPerso[a.id] : params.stockFaible;
        const qCls = qty===null?'':(qty===0?'empty':qty<=seuil?'low':'ok');
        return `<div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                    <span class="badge ${a.statut==='Sorti'?'b-sorti':'b-stock'}">${a.statut==='Sorti'?'√âpuis√©':'En stock'}</span>
                    ${qty!==null?`<span class="qty-big ${qCls}">${qty}<span style="font-size:13px;font-weight:500;color:var(--text3)"> / ${a.quantiteInitiale}</span></span>`:''}
                </div>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                ${seuil>0?`<span class="meta">‚öôÔ∏è Seuil: <strong>${seuil}</strong></span>`:''}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ PR√äTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPretTab(tab) {
    currentPretTab = tab;
    document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('stab_'+tab).classList.add('active');
    renderPrets();
}

function renderPrets() {
    const mag = document.getElementById('p_mag').value;

    // Stats filtr√©es par magasin
    const base = mag ? articles.filter(a=>a.magasin===mag) : articles;
    const dispo = base.filter(a => a.type==='Article de pr√™t'&&a.statut==='Stock');
    const encours = base.filter(a => a.statut==='Pr√™t');
    const retards = encours.filter(a => a.dateRetourPrevue&&new Date(a.dateRetourPrevue)<new Date());
    const bientot = encours.filter(a => {
        if (!a.dateRetourPrevue) return false;
        const d=(new Date(a.dateRetourPrevue)-new Date())/86400000;
        return d>=0&&d<=params.alerteBientot;
    });

    document.getElementById('pretsStats').innerHTML = `
        <div class="stat-card purple"><div class="num">${dispo.length}</div><div class="lbl">Disponibles${mag?' ‚Äî '+mag:''}</div></div>
        <div class="stat-card blue"><div class="num">${encours.length}</div><div class="lbl">En cours</div></div>
        <div class="stat-card orange"><div class="num">${bientot.length}</div><div class="lbl">Retour bient√¥t</div></div>
        <div class="stat-card red"><div class="num">${retards.length}</div><div class="lbl">En retard</div></div>
    `;

    document.getElementById('stab_dispo').textContent = `üü£ Disponibles (${dispo.length})`;
    document.getElementById('stab_dispo').classList.toggle('active', currentPretTab==='dispo');
    document.getElementById('stab_encours').textContent = `üîµ En cours (${encours.length})`;
    document.getElementById('stab_encours').classList.toggle('active', currentPretTab==='encours');
    document.getElementById('stab_bientot').textContent = `üü° Bient√¥t (${bientot.length})`;
    document.getElementById('stab_bientot').classList.toggle('active', currentPretTab==='bientot');
    document.getElementById('stab_retard').textContent = `üî¥ Retard (${retards.length})`;
    document.getElementById('stab_retard').classList.toggle('active', currentPretTab==='retard');

    let list = { dispo, encours, bientot, retard: retards }[currentPretTab] || [];
    if (mag) list = list.filter(a=>a.magasin===mag);

    const msgs = { dispo:'Aucun article disponible', encours:'Aucun pr√™t en cours', bientot:'Aucun retour imminent', retard:'‚úÖ Aucun retard !' };
    if (!list.length) { document.getElementById('pretsList').innerHTML=`<div class="empty"><div class="ico">${currentPretTab==='retard'?'‚úÖ':'üìã'}</div><p>${msgs[currentPretTab]}</p></div>`; return; }

    document.getElementById('pretsList').innerHTML = list.map(a => {
        if (currentPretTab==='dispo') return `
        <div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <span class="badge b-purple">Disponible</span>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
            </div>
        </div>`;

        const retard = a.dateRetourPrevue&&new Date(a.dateRetourPrevue)<new Date();
        const diff = a.dateRetourPrevue?Math.ceil((new Date(a.dateRetourPrevue)-new Date())/86400000):null;
        return `<div class="article-item" onclick="openModal('${a.id}')" style="${retard?'border-color:var(--red-border);background:var(--red-soft)':''}">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <span class="badge ${retard?'b-retard':'b-pret'}">${retard?`‚ö†Ô∏è +${Math.abs(diff)}j`:diff!==null?`‚Ü©Ô∏è J-${diff}`:'En pr√™t'}</span>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üë§ Pr√™t√© √† <strong>${a.prenomEmprunteur}</strong></span>
                <span class="meta">üìÖ <strong>${a.datePret?new Date(a.datePret).toLocaleDateString('fr-FR'):'?'}</strong></span>
                ${a.dateRetourPrevue?`<span class="meta">‚Ü©Ô∏è <strong>${new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR')}</strong></span>`:''}
                ${a.client&&a.client!=='Stock interne'?`<span class="meta">üì¶ <strong>${a.client}</strong></span>`:''}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlertes() {
    const mag = document.getElementById('a_mag').value;
    const list = mag ? articles.filter(a=>a.magasin===mag) : articles;
    let alertes = [];

    list.filter(a=>a.statut==='Pr√™t'&&a.dateRetourPrevue&&new Date(a.dateRetourPrevue)<new Date())
        .forEach(a => {
            const j=Math.floor((new Date()-new Date(a.dateRetourPrevue))/86400000);
            alertes.push({type:'danger',t:`Pr√™t en retard ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ ${a.prenomEmprunteur} ¬∑ ${j}j de retard`,id:a.id});
        });

    list.filter(a => {
        if (a.statut!=='Pr√™t'||!a.dateRetourPrevue) return false;
        const d=(new Date(a.dateRetourPrevue)-new Date())/86400000;
        return d>=0&&d<=params.alerteBientot;
    }).forEach(a => {
        const j=Math.ceil((new Date(a.dateRetourPrevue)-new Date())/86400000);
        alertes.push({type:'warning',t:`Retour bient√¥t ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ ${a.prenomEmprunteur} ¬∑ dans ${j}j`,id:a.id});
    });

    list.filter(a => {
        if (a.type!=='Stock'||a.quantiteStock===null) return false;
        const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        return a.quantiteStock>0&&a.quantiteStock<=s;
    }).forEach(a => {
        const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        alertes.push({type:'warning',t:`Stock faible ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ ${a.quantiteStock} unit√©(s) (seuil: ${s})`,id:a.id});
    });

    list.filter(a=>a.type==='Stock'&&a.quantiteStock===0)
        .forEach(a=>alertes.push({type:'danger',t:`Stock √©puis√© ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ √Ä r√©approvisionner`,id:a.id}));

    if (!alertes.length) { document.getElementById('alertList').innerHTML='<div class="empty"><div class="ico">‚úÖ</div><p>Aucune alerte ‚Äî tout est en ordre !</p></div>'; return; }

    document.getElementById('alertList').innerHTML = alertes.map(al=>`
        <div class="alert-item ${al.type}" onclick="openModal('${al.id}')">
            <span style="font-size:20px">${al.type==='danger'?'üî¥':'üü°'}</span>
            <div>
                <div style="font-size:14px;font-weight:700;">${al.t}</div>
                <div style="font-size:12px;color:var(--text3);margin-top:3px;">${al.m}</div>
            </div>
        </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ LISTE G√âN√âRIQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(list, containerId, showClient=true) {
    if (!list.length) { document.getElementById(containerId).innerHTML='<div class="empty"><div class="ico">üì≠</div><p>Aucun article</p></div>'; return; }
    const bMap={Stock:'b-stock',Pr√™t:'b-pret',Sorti:'b-sorti',SAV:'b-sav'};
    document.getElementById(containerId).innerHTML = list.map(a=>`
        <div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <span class="badge ${bMap[a.statut]||'b-stock'}">${a.statut}</span>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                ${showClient&&a.client&&a.client!=='Stock interne'?`<span class="meta">üë§ <strong>${a.client}</strong></span>`:''}
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                ${a.numeroAR?`<span class="meta">AR: <strong>${a.numeroAR}</strong></span>`:''}
                ${a.nombreColis>1?`<span class="meta">üì¶ <strong>${a.nombreColis} colis</strong></span>`:''}
            </div>
        </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openModal(id) {
    const a = articles.find(x=>x.id===id);
    if (!a) { alert('Article non trouv√©'); return; }
    document.getElementById('mTitle').textContent = a.article;
    document.getElementById('mSub').textContent = `${a.reference} ¬∑ ${a.magasin} ¬∑ ${a.type}`;
    document.getElementById('mBody').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3)">‚è≥ Chargement...</div>';
    document.getElementById('overlay').classList.add('active');

    const histo = await loadHisto(id);
    renderModal(a, histo);
}

function renderModal(a, histo) {
    const bClass = {Stock:'b-stock',Pr√™t:'b-pret',Sorti:'b-sorti',SAV:'b-sav'}[a.statut]||'b-stock';
    const typeClass = {'Mise √† disposition':'b-mad','Stock':'b-stock','Article de pr√™t':'b-purple'}[a.type]||'b-mad';

    let html = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
        <span class="badge ${typeClass}">${a.type}</span>
        <span class="badge ${bClass}">${a.statut}</span>
    </div>
    <div class="detail-grid">
        <div class="detail-field"><div class="k">Magasin</div><div class="v">${a.magasin}</div></div>
        ${a.client&&a.client!=='Stock interne'?`<div class="detail-field"><div class="k">Client</div><div class="v">${a.client}</div>`:'<div class="detail-field"><div class="k">Type</div><div class="v">Stock interne</div>'}
        </div>
        <div class="detail-field"><div class="k">R√©f√©rence</div><div class="v">${a.reference}</div></div>
        <div class="detail-field"><div class="k">Emplacement</div><div class="v">${a.emplacement}</div></div>
        ${a.numeroAR?`<div class="detail-field"><div class="k">N¬∞ AR</div><div class="v">${a.numeroAR}</div></div>`:''}
        ${a.quantiteStock!==null?`<div class="detail-field"><div class="k">Quantit√©</div><div class="v" style="font-size:18px;font-weight:800;color:${a.quantiteStock===0?'var(--red)':a.quantiteStock<=(seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible)?'var(--orange)':'var(--green)'}">${a.quantiteStock} <span style="font-size:13px;font-weight:400;color:var(--text3)">/ ${a.quantiteInitiale}</span></div></div>`:''}
        ${a.nombreColis>1?`<div class="detail-field"><div class="k">Colis</div><div class="v">${a.nombreColis}</div></div>`:''}
        <div class="detail-field"><div class="k">R√©ceptionn√© par</div><div class="v">${a.kitchener}</div></div>
        <div class="detail-field"><div class="k">Date r√©ception</div><div class="v">${a.dateReception?new Date(a.dateReception).toLocaleDateString('fr-FR'):'?'}</div></div>
        ${a.notes?`<div class="detail-field full"><div class="k">Notes</div><div class="v">${a.notes}</div></div>`:''}
    </div>`;

    if (a.statut==='Pr√™t') {
        const retard = a.dateRetourPrevue && new Date(a.dateRetourPrevue)<new Date();
        html += `
        <div style="background:${retard?'var(--red-soft)':'var(--orange-soft)'};border:1.5px solid ${retard?'var(--red-border)':'var(--orange-border)'};border-radius:var(--r2);padding:14px;margin-bottom:16px;">
            <div style="font-weight:700;color:${retard?'var(--red)':'var(--orange)'}">üîÑ En pr√™t${retard?' ‚Äî ‚ö†Ô∏è EN RETARD':''}</div>
            <div style="font-size:13px;color:var(--text2);margin-top:6px;">
                Pr√™t√© √† <strong>${a.prenomEmprunteur}</strong> depuis le <strong>${a.datePret?new Date(a.datePret).toLocaleDateString('fr-FR'):'?'}</strong><br>
                Retour pr√©vu le <strong>${a.dateRetourPrevue?new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR'):'?'}</strong>
            </div>
        </div>`;
    }

    // QR Print
    html += `
    <div style="background:var(--blue-soft);border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
        <div style="font-size:13px;font-weight:600;color:var(--blue)">üî≥ Imprimer l'√©tiquette QR</div>
        <button class="btn btn-primary" style="padding:8px 16px;font-size:13px;" onclick="printArticleQR('${a.id}')">üñ®Ô∏è Imprimer</button>
    </div>`;

    // Pr√©nom + actions
    html += `
    <div class="prenom-bar">
        <label>üë§ Votre pr√©nom</label>
        <input type="text" id="actPrenom" placeholder="Obligatoire pour toute action">
    </div>
    <div class="btn-row">`;

    if (a.statut==='Stock') {
        html += `<button class="btn btn-success" onclick="actSortir('${a.id}')">üì§ Sortir</button>`;
        html += `<button class="btn btn-warning" onclick="actPreter('${a.id}')">üîÑ Pr√™ter</button>`;
        html += `<button class="btn btn-outline" onclick="actEmplacement('${a.id}')">üìç Emplacement</button>`;
        if (a.type==='Stock') {
            html += `<button class="btn btn-primary" onclick="actSortirQte('${a.id}')">üì¶ Sortir quantit√©</button>`;
            html += `<button class="btn btn-teal" onclick="actAjouterQte('${a.id}')">‚ûï Ajouter stock</button>`;
            html += `<button class="btn btn-outline" onclick="actSetSeuil('${a.id}')">‚öôÔ∏è Seuil alerte</button>`;
        }
    }
    if (a.statut==='Pr√™t') {
        html += `<button class="btn btn-success" onclick="actRetour('${a.id}')">‚Ü©Ô∏è Retour de pr√™t</button>`;
        html += `<button class="btn btn-warning" onclick="actModifierDateRetour('${a.id}')">üìÖ Modifier retour</button>`;
    }
    html += `</div>`;

    // Modifier l'article (section √©dition)
    html += `
    <div class="divider"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="font-size:13px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;">‚úèÔ∏è Modifier cet article</div>
        <button class="btn btn-outline" style="padding:7px 14px;font-size:12px;" onclick="toggleEdit('${a.id}')">Modifier</button>
    </div>
    <div id="editSection_${a.id}" style="display:none;">
        <div class="edit-form">
            <div class="form-grid">
                <div class="fg"><label>Article</label><input id="e_article" value="${a.article}"></div>
                <div class="fg"><label>R√©f√©rence</label><input id="e_reference" value="${a.reference}"></div>
                <div class="fg"><label>Emplacement</label><input id="e_emplacement" value="${a.emplacement}"></div>
                <div class="fg">
                    <label>Cat√©gorie</label>
                    <select id="e_type">
                        <option value="Mise √† disposition" ${a.type==='Mise √† disposition'?'selected':''}>üöö Mise √† disposition</option>
                        <option value="Stock" ${a.type==='Stock'?'selected':''}>üì¶ Stock</option>
                        <option value="Article de pr√™t" ${a.type==='Article de pr√™t'?'selected':''}>üîÑ Article de pr√™t</option>
                    </select>
                </div>
                ${a.client&&a.client!=='Stock interne'?`<div class="fg"><label>Client</label><input id="e_client" value="${a.client}"></div>`:''}
                ${a.numeroAR?`<div class="fg"><label>N¬∞ AR</label><input id="e_ar" value="${a.numeroAR}"></div>`:''}
                ${a.quantiteStock!==null?`<div class="fg"><label>Quantit√©</label><input id="e_qty" type="number" value="${a.quantiteStock}"></div>`:''}
                ${a.nombreColis>0?`<div class="fg"><label>Nb Colis</label><input id="e_colis" type="number" value="${a.nombreColis}"></div>`:''}
                <div class="fg full"><label>Notes</label><textarea id="e_notes" rows="2">${a.notes||''}</textarea></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="actSaveEdit('${a.id}')">üíæ Enregistrer les modifications</button>
                <button class="btn btn-outline" onclick="toggleEdit('${a.id}')">Annuler</button>
            </div>
        </div>
    </div>`;

    // Historique
    html += `
    <div class="divider"></div>
    <div style="font-size:13px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px;">üìú Historique</div>`;
    if (!histo.length) {
        html += '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px;">Aucun historique</div>';
    } else {
        html += histo.map(h=>`
        <div class="histo">
            <div class="histo-date">${h.date?new Date(h.date).toLocaleString('fr-FR'):'?'}</div>
            <div class="histo-action">${h.action} ‚Äî ${h.utilisateur}</div>
            ${h.details?`<div class="histo-detail">${h.details}</div>`:''}
        </div>`).join('');
    }

    document.getElementById('mBody').innerHTML = html;
}

function toggleEdit(id) {
    const el = document.getElementById('editSection_'+id);
    el.style.display = el.style.display==='none' ? 'block' : 'none';
}

function closeModal() { document.getElementById('overlay').classList.remove('active'); }

// ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getPrenom() {
    const v=(document.getElementById('actPrenom')?.value||'').trim();
    if (!v) { alert('‚ö†Ô∏è Entrez votre pr√©nom'); return null; }
    return v;
}

async function actSortir(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const raison=prompt('Raison de la sortie :'); if(!raison)return;
    const a=articles.find(x=>x.id===id);
    a.statut='Sorti'; a.dateSortie=new Date().toISOString(); a.raisonSortie=raison;
    await doUpdate(a); doHisto(id,'Sortie',prenom,`Raison: ${raison}`);
    closeModal(); alert('‚úÖ Article sorti'); loadData();
}

async function actSortirQte(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const s=prompt(`Quantit√© √† sortir (disponible: ${a.quantiteStock}) :`); if(!s)return;
    const qte=parseInt(s);
    if (isNaN(qte)||qte<=0) { alert('Quantit√© invalide'); return; }
    if (qte>a.quantiteStock) { alert(`Stock insuffisant ‚Äî disponible: ${a.quantiteStock}`); return; }
    a.quantiteStock-=qte;
    if (a.quantiteStock===0) a.statut='Sorti';
    await doUpdate(a); doHisto(id,'Sortie stock',prenom,`${qte} unit√©(s) ‚Äî Reste: ${a.quantiteStock}`);
    closeModal(); alert(`‚úÖ ${qte} unit√©(s) sortie(s) ‚Äî Reste: ${a.quantiteStock}`); loadData();
}

async function actAjouterQte(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const s=prompt(`Quantit√© √† ajouter (actuel: ${a.quantiteStock||0}) :`); if(!s)return;
    const qte=parseInt(s);
    if (isNaN(qte)||qte<=0) { alert('Quantit√© invalide'); return; }
    a.quantiteStock=(a.quantiteStock||0)+qte;
    a.quantiteInitiale=Math.max(a.quantiteInitiale||0,a.quantiteStock);
    if (a.statut==='Sorti') a.statut='Stock';
    await doUpdate(a); doHisto(id,'Ajout stock',prenom,`+${qte} ‚Äî Nouveau: ${a.quantiteStock}`);
    closeModal(); alert(`‚úÖ Stock: ${a.quantiteStock}`); loadData();
}

async function actPreter(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const emp=prompt('Pr√©nom emprunteur :'); if(!emp)return;
    const dateStr=prompt('Date retour (JJ/MM/AAAA) :'); if(!dateStr)return;
    const [j,m,y]=dateStr.split('/');
    if (!j||!m||!y) { alert('Format de date invalide. Utilisez JJ/MM/AAAA'); return; }
    const a=articles.find(x=>x.id===id);
    // Le statut passe √† "Pr√™t" ‚Äî l'article dispara√Æt du stock et appara√Æt dans les pr√™ts
    a.statut='Pr√™t'; a.datePret=new Date().toISOString();
    a.prenomEmprunteur=emp; a.dateRetourPrevue=new Date(y,m-1,j).toISOString();
    await doUpdate(a); doHisto(id,'Pr√™t',prenom,`√Ä ${emp} ‚Äî Retour: ${dateStr}`);
    closeModal(); alert('‚úÖ Pr√™t enregistr√© ‚Äî l\'article a √©t√© retir√© du stock'); loadData();
}

async function actRetour(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const emp=a.prenomEmprunteur;
    // Retour : repasse en Stock
    a.statut='Stock'; a.dateRetourReel=new Date().toISOString();
    await doUpdate(a); doHisto(id,'Retour pr√™t',prenom,`Retourn√© par ${emp}`);
    closeModal(); alert('‚úÖ Retour enregistr√© ‚Äî l\'article est de nouveau en stock'); loadData();
}

async function actModifierDateRetour(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const actuelle = a.dateRetourPrevue ? new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR') : '?';
    const dateStr=prompt(`Nouvelle date de retour (actuelle: ${actuelle})\nFormat: JJ/MM/AAAA :`);
    if (!dateStr) return;
    const [j,m,y]=dateStr.split('/');
    const ancienne = actuelle;
    a.dateRetourPrevue=new Date(y,m-1,j).toISOString();
    await doUpdate(a); doHisto(id,'Modification date retour',prenom,`${ancienne} ‚Üí ${dateStr}`);
    closeModal(); alert('‚úÖ Date de retour modifi√©e'); loadData();
}

async function actEmplacement(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const n=prompt(`Nouvel emplacement (actuel: ${a.emplacement}) :`); if(!n)return;
    const ancien=a.emplacement; a.emplacement=n;
    await doUpdate(a); doHisto(id,'Changement emplacement',prenom,`${ancien} ‚Üí ${n}`);
    closeModal(); alert('‚úÖ Emplacement mis √† jour'); loadData();
}

function actSetSeuil(id) {
    const a=articles.find(x=>x.id===id);
    const actuel=seuilsPerso[id]!==undefined?seuilsPerso[id]:params.stockFaible;
    const val=prompt(`Seuil d'alerte pour "${a.article}" (actuel: ${actuel} unit√©s) :\nEntrez 0 pour d√©sactiver.`);
    if (val===null) return;
    const n=parseInt(val);
    if (isNaN(n)||n<0) { alert('Valeur invalide'); return; }
    seuilsPerso[id]=n;
    saveSeuilsToAPI();
    alert(`‚úÖ Seuil d√©fini √† ${n} unit√©s pour "${a.article}" ‚Äî synchronis√© sur tous les appareils`);
    refreshBadges();
}

async function actSaveEdit(id) {
    const prenom=getPrenom(); if(!prenom)return;
    const a=articles.find(x=>x.id===id);
    const changes=[];
    const get=(elId,fallback)=>{ const el=document.getElementById(elId); return el?el.value.trim():fallback; };

    const newArticle=get('e_article',a.article);
    const newRef=get('e_reference',a.reference);
    const newEmp=get('e_emplacement',a.emplacement);
    const newClient=get('e_client',a.client)||a.client;
    const newAR=get('e_ar',a.numeroAR)||a.numeroAR;
    const newNotes=get('e_notes',a.notes);
    const newTypeEl=document.getElementById('e_type');
    const newType=newTypeEl?newTypeEl.value:a.type;
    const newQtyEl=document.getElementById('e_qty');
    const newQty=newQtyEl?parseInt(newQtyEl.value):a.quantiteStock;
    const newColisEl=document.getElementById('e_colis');
    const newColis=newColisEl?parseInt(newColisEl.value):a.nombreColis;

    if (newArticle!==a.article) changes.push(`Article: "${a.article}" ‚Üí "${newArticle}"`);
    if (newRef!==a.reference) changes.push(`R√©f: ${a.reference} ‚Üí ${newRef}`);
    if (newEmp!==a.emplacement) changes.push(`Emplacement: ${a.emplacement} ‚Üí ${newEmp}`);
    if (newType!==a.type) changes.push(`Cat√©gorie: ${a.type} ‚Üí ${newType}`);
    if (newQtyEl&&newQty!==a.quantiteStock) changes.push(`Quantit√©: ${a.quantiteStock} ‚Üí ${newQty}`);
    if (newColisEl&&newColis!==a.nombreColis) changes.push(`Colis: ${a.nombreColis} ‚Üí ${newColis}`);

    // Si changement de type vers Stock interne
    if (newType==='Stock' && a.type!=='Stock') {
        a.client='Stock interne';
        a.quantiteStock = a.quantiteStock || 1;
        a.quantiteInitiale = a.quantiteInitiale || 1;
    }
    // Si changement depuis Stock vers autre chose, on garde les infos
    if (newType!=='Stock' && a.type==='Stock' && (!newClient||newClient==='Stock interne')) {
        a.client = prompt('Ce type n√©cessite un client. Entrez le nom du client :') || 'Client';
    }

    a.article=newArticle; a.reference=newRef; a.emplacement=newEmp;
    a.client=newClient; a.numeroAR=newAR; a.notes=newNotes; a.type=newType;
    if (newQtyEl) a.quantiteStock=newQty;
    if (newColisEl) a.nombreColis=newColis;

    await doUpdate(a);
    if (changes.length) doHisto(id,'Modification',prenom,changes.join(' ¬∑ '));
    closeModal(); alert('‚úÖ Article modifi√©'); loadData();
}

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doUpdate(a) {
    return apiCall({
        action:'updateArticle', ID:a.id, Magasin:a.magasin, Type:a.type,
        Client:a.client, NumeroAR:a.numeroAR||'', Article:a.article,
        Reference:a.reference, NombreColis:a.nombreColis,
        QuantiteStock:a.quantiteStock!==null?a.quantiteStock:'',
        QuantiteInitiale:a.quantiteInitiale!==null?a.quantiteInitiale:'',
        Emplacement:a.emplacement, Kitchener:a.kitchener, Notes:a.notes||'',
        Statut:a.statut, DateReception:a.dateReception,
        DatePret:a.datePret||'', PrenomEmprunteur:a.prenomEmprunteur||'',
        DateRetourPrevue:a.dateRetourPrevue||'', DateRetourReel:a.dateRetourReel||'',
        DateSortie:a.dateSortie||'', RaisonSortie:a.raisonSortie||''
    });
}

function doHisto(id,action,user,details='') {
    delete histoCache[id];
    apiCall({action:'addHistorique',ArticleID:id,Action:action,Date:new Date().toISOString(),Utilisateur:user,Details:details});
}

async function loadHisto(id) {
    if (histoCache[id]) return histoCache[id];
    const data = await apiCall({action:'getHistorique',articleId:id});
    histoCache[id] = Array.isArray(data)?data:[];
    return histoCache[id];
}

setInterval(()=>loadData(),60000);
</script>
</body>
</html>
