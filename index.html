<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMC - Gestion de Stock</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --navy: #0f1923;
            --navy-light: #1a2a3a;
            --navy-mid: #243447;
            --blue: #2563eb;
            --blue-light: #3b82f6;
            --cyan: #06b6d4;
            --green: #10b981;
            --orange: #f59e0b;
            --red: #ef4444;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --text-dim: #94a3b8;
            --border: #1e3a5f;
            --card: #131f2e;
            --card-hover: #1a2a3a;
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--navy);
            color: var(--text);
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 38px;
            height: 38px;
            background: var(--blue);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
        }

        .brand-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-pill.connected { background: rgba(16,185,129,.15); color: var(--green); border: 1px solid rgba(16,185,129,.3); }
        .status-pill.loading { background: rgba(245,158,11,.15); color: var(--orange); border: 1px solid rgba(245,158,11,.3); }
        .status-pill.disconnected { background: rgba(239,68,68,.15); color: var(--red); border: 1px solid rgba(239,68,68,.3); }

        .btn-reload {
            padding: 8px 14px;
            background: var(--navy-mid);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all .2s;
        }
        .btn-reload:hover { background: var(--navy-light); color: var(--text); }

        /* TABS */
        .tabs-wrapper {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            gap: 4px;
            overflow-x: auto;
        }

        .tab {
            padding: 16px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all .2s;
            white-space: nowrap;
            font-family: 'DM Sans', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover { color: var(--text-dim); }
        .tab.active { color: var(--blue-light); border-bottom-color: var(--blue-light); }

        .tab-badge {
            background: var(--red);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }

        /* CONTENT */
        .content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 28px 24px;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* CARDS */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* STATS */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .stat-box .num {
            font-size: 2.2em;
            font-weight: 700;
            font-family: 'DM Mono', monospace;
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-box .lbl {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-box.blue .num { color: var(--blue-light); }
        .stat-box.green .num { color: var(--green); }
        .stat-box.orange .num { color: var(--orange); }
        .stat-box.red .num { color: var(--red); }
        .stat-box.cyan .num { color: var(--cyan); }

        /* FORM */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full { grid-column: 1 / -1; }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--navy-mid);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            transition: border-color .2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .form-group select option { background: var(--navy-mid); }

        /* BUTTONS */
        .btn {
            padding: 11px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: 'DM Sans', sans-serif;
            transition: all .2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--blue-light); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover { opacity: .9; }
        .btn-warning { background: var(--orange); color: white; }
        .btn-warning:hover { opacity: .9; }
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { opacity: .9; }
        .btn-ghost { background: var(--navy-mid); color: var(--text-dim); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--navy-light); color: var(--text); }
        .btn-cyan { background: var(--cyan); color: var(--navy); }
        .btn-cyan:hover { opacity: .9; }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* ARTICLE ITEMS */
        .article-item {
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all .2s;
        }

        .article-item:hover { border-color: var(--blue); background: var(--navy-mid); }

        .article-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .article-item-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }

        .article-item-ref {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'DM Mono', monospace;
            margin-top: 2px;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .meta-chip {
            font-size: 12px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-chip strong { color: var(--text); }

        /* BADGES */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
        }

        .badge-navette { background: rgba(6,182,212,.15); color: var(--cyan); border: 1px solid rgba(6,182,212,.3); }
        .badge-stock { background: rgba(16,185,129,.15); color: var(--green); border: 1px solid rgba(16,185,129,.3); }
        .badge-pret { background: rgba(245,158,11,.15); color: var(--orange); border: 1px solid rgba(245,158,11,.3); }
        .badge-sorti { background: rgba(100,116,139,.15); color: var(--text-muted); border: 1px solid rgba(100,116,139,.3); }
        .badge-sav { background: rgba(239,68,68,.15); color: var(--red); border: 1px solid rgba(239,68,68,.3); }
        .badge-retard { background: var(--red); color: white; }

        /* FILTER BAR */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .filter-bar select, .filter-bar input {
            background: var(--navy-mid);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 9px 14px;
            color: var(--text);
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            min-width: 160px;
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            max-width: 580px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--navy-mid);
            color: var(--text-dim);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover { background: var(--navy-light); color: var(--text); }

        /* ARTICLE DETAIL IN MODAL */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .detail-field {
            background: var(--navy-mid);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
        }

        .detail-field .key {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 4px;
        }

        .detail-field .val {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .detail-field.full { grid-column: 1 / -1; }

        /* HISTORIQUE */
        .histo-item {
            padding: 12px 14px;
            border-left: 3px solid var(--blue);
            background: var(--navy-mid);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 8px;
        }

        .histo-date { font-size: 11px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
        .histo-action { font-size: 13px; font-weight: 600; color: var(--text); margin: 3px 0; }
        .histo-detail { font-size: 12px; color: var(--text-dim); }

        /* QR CODE */
        .qr-box {
            text-align: center;
            padding: 28px;
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-top: 20px;
        }

        #qrcode {
            display: inline-block;
            background: white;
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
        }

        /* ALERT */
        .alert-box {
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            cursor: pointer;
            transition: opacity .2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .alert-box:hover { opacity: .85; }
        .alert-box.danger { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); color: #fca5a5; }
        .alert-box.warning { background: rgba(245,158,11,.1); border: 1px solid rgba(245,158,11,.3); color: #fde68a; }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }

        .prenom-bar {
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .prenom-bar label { font-size: 13px; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        .prenom-bar input {
            flex: 1;
            background: var(--navy-mid);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 9px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
        }

        .stock-qty {
            font-size: 22px;
            font-weight: 700;
            font-family: 'DM Mono', monospace;
            color: var(--green);
        }

        .stock-qty.low { color: var(--orange); }
        .stock-qty.empty { color: var(--red); }

        @media (max-width: 640px) {
            .content { padding: 16px; }
            .detail-grid { grid-template-columns: 1fr; }
            .header { padding: 12px 16px; }
            .tabs-wrapper { padding: 0 16px; }
            .brand-sub { display: none; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-brand">
        <div class="brand-icon">üì¶</div>
        <div>
            <div class="brand-name">HMC Stock</div>
            <div class="brand-sub">Multi-Magasins</div>
        </div>
    </div>
    <div class="header-right">
        <div class="status-pill loading" id="connectionStatus">üîÑ Connexion...</div>
        <button class="btn-reload" onclick="loadData()">‚Üª Recharger</button>
    </div>
</div>

<div class="tabs-wrapper">
    <button class="tab active" onclick="switchTab('reception')">üì• R√©ception</button>
    <button class="tab" onclick="switchTab('navettes')">üöö Navettes</button>
    <button class="tab" onclick="switchTab('stock')">üì¶ Stock</button>
    <button class="tab" onclick="switchTab('prets')">üîÑ Pr√™ts <span class="tab-badge" id="pretsBadge" style="display:none">0</span></button>
    <button class="tab" onclick="switchTab('alertes')">üîî Alertes <span class="tab-badge" id="alertesBadge" style="display:none">0</span></button>
</div>

<div class="content">

    <!-- ===== R√âCEPTION ===== -->
    <div id="reception" class="tab-pane active">
        <div class="section-title">R√©ception d'Article</div>

        <div class="card">
            <form id="receptionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Magasin *</label>
                        <select id="magasin" required>
                            <option value="">S√©lectionner...</option>
                            <option value="Lattes">Lattes</option>
                            <option value="Ved√®ne">Ved√®ne</option>
                            <option value="Aix">Aix</option>
                            <option value="N√Æmes">N√Æmes</option>
                            <option value="Vitrolles">Vitrolles</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="typeArticle" required onchange="toggleTypeFields()">
                            <option value="">S√©lectionner...</option>
                            <option value="Navette">Navette (commande client)</option>
                            <option value="Stock">Stock (consommables / RAB)</option>
                            <option value="SAV">SAV</option>
                            <option value="Pr√™t">Article Pr√™t</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nom du Client *</label>
                        <input type="text" id="nomClient" required placeholder="Nom du client">
                    </div>
                    <div class="form-group">
                        <label>N¬∞ AR</label>
                        <input type="text" id="numeroAR" placeholder="Num√©ro AR">
                    </div>
                    <div class="form-group">
                        <label>Article *</label>
                        <input type="text" id="article" required placeholder="Nom de l'article">
                    </div>
                    <div class="form-group">
                        <label>R√©f√©rence *</label>
                        <input type="text" id="reference" required placeholder="R√©f√©rence">
                    </div>
                    <div class="form-group">
                        <label>Nombre de Colis *</label>
                        <input type="number" id="nombreColis" min="1" value="1" required>
                    </div>
                    <div class="form-group" id="quantiteGroup" style="display:none">
                        <label>Quantit√© en Stock *</label>
                        <input type="number" id="quantiteStock" min="1" value="1" placeholder="Quantit√©">
                    </div>
                    <div class="form-group">
                        <label>Emplacement *</label>
                        <input type="text" id="emplacement" required placeholder="Ex: Rayon A, √âtag√®re 3">
                    </div>
                    <div class="form-group">
                        <label>Votre Pr√©nom *</label>
                        <input type="text" id="prenomKitchener" required placeholder="Votre pr√©nom">
                    </div>
                    <div class="form-group full">
                        <label>Notes</label>
                        <textarea id="notes" rows="2" placeholder="Observations..."></textarea>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit" class="btn btn-primary" id="submitBtn">‚úÖ G√©n√©rer le QR Code</button>
                </div>
            </form>
        </div>

        <div id="qrCodeResult" style="display:none">
            <div class="qr-box">
                <div style="font-size:15px;font-weight:600;margin-bottom:8px;">‚úÖ QR Code g√©n√©r√© !</div>
                <p style="font-size:13px;color:var(--text-muted);">Scannez avec l'appareil photo pour acc√©der directement √† l'article</p>
                <div id="qrcode"></div>
                <div class="btn-row" style="justify-content:center;">
                    <button class="btn btn-primary" onclick="printQRCode()">üñ®Ô∏è Imprimer</button>
                    <button class="btn btn-ghost" onclick="resetForm()">‚ûï Nouveau</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== NAVETTES ===== -->
    <div id="navettes" class="tab-pane">
        <div class="section-title">Suivi des Navettes</div>

        <div class="stats-row" id="navetteStats"></div>

        <div class="filter-bar">
            <select id="navMagasin" onchange="filterNavettes()">
                <option value="">Tous les magasins</option>
                <option value="Lattes">Lattes</option>
                <option value="Ved√®ne">Ved√®ne</option>
                <option value="Aix">Aix</option>
                <option value="N√Æmes">N√Æmes</option>
                <option value="Vitrolles">Vitrolles</option>
            </select>
            <select id="navStatut" onchange="filterNavettes()">
                <option value="">Tous les statuts</option>
                <option value="Stock">En stock</option>
                <option value="Sorti">Sorti</option>
                <option value="SAV">SAV</option>
            </select>
            <input type="text" id="navSearch" placeholder="üîç Rechercher..." oninput="filterNavettes()">
        </div>

        <div id="navettesList"></div>
    </div>

    <!-- ===== STOCK ===== -->
    <div id="stock" class="tab-pane">
        <div class="section-title">Gestion du Stock</div>

        <div class="stats-row" id="stockStats"></div>

        <div class="filter-bar">
            <select id="stockMagasin" onchange="filterStockItems()">
                <option value="">Tous les magasins</option>
                <option value="Lattes">Lattes</option>
                <option value="Ved√®ne">Ved√®ne</option>
                <option value="Aix">Aix</option>
                <option value="N√Æmes">N√Æmes</option>
                <option value="Vitrolles">Vitrolles</option>
            </select>
            <input type="text" id="stockSearch" placeholder="üîç Rechercher..." oninput="filterStockItems()">
        </div>

        <div id="stockList"></div>
    </div>

    <!-- ===== PR√äTS ===== -->
    <div id="prets" class="tab-pane">
        <div class="section-title">Gestion des Pr√™ts</div>

        <div class="stats-row" id="pretsStats"></div>

        <div class="filter-bar">
            <select id="pretMagasin" onchange="filterPrets()">
                <option value="">Tous les magasins</option>
                <option value="Lattes">Lattes</option>
                <option value="Ved√®ne">Ved√®ne</option>
                <option value="Aix">Aix</option>
                <option value="N√Æmes">N√Æmes</option>
                <option value="Vitrolles">Vitrolles</option>
            </select>
            <select id="pretStatut" onchange="filterPrets()">
                <option value="">Tous</option>
                <option value="Pr√™t">En cours</option>
                <option value="retard">En retard</option>
                <option value="bientot">Retour bient√¥t</option>
            </select>
        </div>

        <div id="pretsList"></div>
    </div>

    <!-- ===== ALERTES ===== -->
    <div id="alertes" class="tab-pane">
        <div class="section-title">Alertes</div>

        <div class="filter-bar">
            <select id="alerteMagasin" onchange="displayAlertes()">
                <option value="">Tous les magasins</option>
                <option value="Lattes">Lattes</option>
                <option value="Ved√®ne">Ved√®ne</option>
                <option value="Aix">Aix</option>
                <option value="N√Æmes">N√Æmes</option>
                <option value="Vitrolles">Vitrolles</option>
            </select>
        </div>

        <div id="alertesList"></div>
    </div>
</div>

<!-- MODAL ARTICLE -->
<div class="modal-overlay" id="articleModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">D√©tails</div>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// =============================================
// ‚ö†Ô∏è  REMPLACEZ PAR VOTRE URL GOOGLE APPS SCRIPT
// =============================================
const API_URL = 'VOTRE_URL_ICI';
const APP_URL = window.location.origin + window.location.pathname;

let articles = [];
let historiquesCache = {};

// D√©marrage
window.addEventListener('DOMContentLoaded', () => {
    if (API_URL === 'https://script.google.com/macros/s/AKfycbw4iOVF_nKgOsFhdXDdJRGziUPDKw-qAj4QLU3CadpeqBYVyTLiUxa9WM5bGFUDsFmAiA/exec') {
        alert('‚ö†Ô∏è Remplacez VOTRE_URL_ICI par votre URL de d√©ploiement Google Apps Script dans le code.');
    }
    const params = new URLSearchParams(window.location.search);
    const artId = params.get('article');
    if (artId) {
        loadData().then(() => openArticleModal(artId));
    } else {
        loadData();
    }
});

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function loadData() {
    setStatus('loading', 'üîÑ Chargement...');
    return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now();
        window[cb] = (data) => {
            cleanup(cb);
            if (data.error) { setStatus('disconnected', '‚ùå Erreur'); reject(); return; }
            articles = parseArticles(data);
            setStatus('connected', `‚úÖ ${articles.length} articles`);
            refreshAllViews();
            resolve();
        };
        const s = makeScript(`${API_URL}?action=getAllArticles&callback=${cb}&t=${Date.now()}`);
        s.onerror = () => { setStatus('disconnected', '‚ùå D√©connect√©'); reject(); };
    });
}

function apiCall(params) {
    return new Promise((resolve) => {
        const cb = 'cb_' + Date.now();
        window[cb] = (data) => { cleanup(cb); resolve(data || {}); };
        const url = new URLSearchParams({ ...params, callback: cb });
        const s = makeScript(`${API_URL}?${url.toString()}`);
        s.onerror = () => { cleanup(cb); resolve({ error: 'Network error' }); };
        setTimeout(() => { if (window[cb]) { cleanup(cb); resolve({ error: 'timeout' }); } }, 15000);
    });
}

function cleanup(name) {
    delete window[name];
    const s = document.getElementById(name);
    if (s) s.remove();
}

function makeScript(src) {
    const s = document.createElement('script');
    s.src = src;
    document.body.appendChild(s);
    return s;
}

// ‚îÄ‚îÄ‚îÄ PARSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function parseArticles(data) {
    if (!Array.isArray(data)) return [];
    return data.map(r => ({
        id: r.ID, magasin: r.Magasin, type: r.Type,
        client: r.Client, numeroAR: r.NumeroAR,
        article: r.Article, reference: r.Reference,
        nombreColis: parseInt(r.NombreColis) || 1,
        quantiteStock: (r.QuantiteStock !== null && r.QuantiteStock !== '') ? parseInt(r.QuantiteStock) : null,
        quantiteInitiale: (r.QuantiteInitiale !== null && r.QuantiteInitiale !== '') ? parseInt(r.QuantiteInitiale) : null,
        emplacement: r.Emplacement, kitchener: r.Kitchener,
        notes: r.Notes, statut: r.Statut,
        dateReception: r.DateReception, datePret: r.DatePret,
        prenomEmprunteur: r.PrenomEmprunteur,
        dateRetourPrevue: r.DateRetourPrevue, dateRetourReel: r.DateRetourReel,
        dateSortie: r.DateSortie, raisonSortie: r.RaisonSortie
    }));
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(name).classList.add('active');
    if (name === 'navettes') displayNavettes();
    if (name === 'stock') displayStock();
    if (name === 'prets') displayPrets();
    if (name === 'alertes') displayAlertes();
}

function setStatus(cls, msg) {
    const el = document.getElementById('connectionStatus');
    el.className = 'status-pill ' + cls;
    el.textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ FORM R√âCEPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleTypeFields() {
    const type = document.getElementById('typeArticle').value;
    const qg = document.getElementById('quantiteGroup');
    if (type === 'Stock') {
        qg.style.display = 'flex';
        document.getElementById('quantiteStock').required = true;
    } else {
        qg.style.display = 'none';
        document.getElementById('quantiteStock').required = false;
    }
}

document.getElementById('receptionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = '‚è≥ Enregistrement...';

    const type = document.getElementById('typeArticle').value;
    const artData = {
        id: 'ART-' + Date.now(),
        magasin: document.getElementById('magasin').value,
        type,
        client: document.getElementById('nomClient').value,
        numeroAR: document.getElementById('numeroAR').value,
        article: document.getElementById('article').value,
        reference: document.getElementById('reference').value,
        nombreColis: parseInt(document.getElementById('nombreColis').value),
        quantiteStock: type === 'Stock' ? parseInt(document.getElementById('quantiteStock').value) : null,
        quantiteInitiale: type === 'Stock' ? parseInt(document.getElementById('quantiteStock').value) : null,
        emplacement: document.getElementById('emplacement').value,
        kitchener: document.getElementById('prenomKitchener').value,
        notes: document.getElementById('notes').value,
        statut: 'Stock',
        dateReception: new Date().toISOString()
    };

    const r = await apiCall({
        action: 'addArticle', ID: artData.id, Magasin: artData.magasin,
        Type: artData.type, Client: artData.client, NumeroAR: artData.numeroAR || '',
        Article: artData.article, Reference: artData.reference, NombreColis: artData.nombreColis,
        QuantiteStock: artData.quantiteStock !== null ? artData.quantiteStock : '',
        QuantiteInitiale: artData.quantiteInitiale !== null ? artData.quantiteInitiale : '',
        Emplacement: artData.emplacement, Kitchener: artData.kitchener,
        Notes: artData.notes || '', Statut: artData.statut,
        DateReception: artData.dateReception, Historique: 'true'
    });

    btn.disabled = false; btn.textContent = '‚úÖ G√©n√©rer le QR Code';

    if (r.error) { alert('Erreur: ' + r.error); return; }

    const articleUrl = `${APP_URL}?article=${artData.id}`;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: articleUrl, width: 220, height: 220 });
    document.getElementById('receptionForm').style.display = 'none';
    document.getElementById('qrCodeResult').style.display = 'block';
    setTimeout(() => loadData(), 1500);
});

function resetForm() {
    document.getElementById('receptionForm').reset();
    document.getElementById('receptionForm').style.display = 'block';
    document.getElementById('qrCodeResult').style.display = 'none';
    document.getElementById('quantiteGroup').style.display = 'none';
}

function printQRCode() {
    const w = window.open('', '', 'height=600,width=400');
    w.document.write('<html><body style="text-align:center;padding:40px;">');
    w.document.write(document.getElementById('qrCodeResult').innerHTML);
    w.document.write('</body></html>');
    w.document.close(); w.print();
}

// ‚îÄ‚îÄ‚îÄ NAVETTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function displayNavettes() {
    const navettes = articles.filter(a => a.type === 'Navette');
    const stats = {
        total: navettes.length,
        enStock: navettes.filter(a => a.statut === 'Stock').length,
        sortis: navettes.filter(a => a.statut === 'Sorti').length,
        sav: navettes.filter(a => a.statut === 'SAV').length
    };

    document.getElementById('navetteStats').innerHTML = `
        <div class="stat-box cyan"><div class="num">${stats.total}</div><div class="lbl">Total Navettes</div></div>
        <div class="stat-box green"><div class="num">${stats.enStock}</div><div class="lbl">En Stock</div></div>
        <div class="stat-box blue"><div class="num">${stats.sortis}</div><div class="lbl">Sorties</div></div>
        <div class="stat-box red"><div class="num">${stats.sav}</div><div class="lbl">SAV</div></div>
    `;
    filterNavettes();
}

function filterNavettes() {
    const mag = document.getElementById('navMagasin').value;
    const stat = document.getElementById('navStatut').value;
    const search = document.getElementById('navSearch').value.toLowerCase();

    let list = articles.filter(a => a.type === 'Navette');
    if (mag) list = list.filter(a => a.magasin === mag);
    if (stat) list = list.filter(a => a.statut === stat);
    if (search) list = list.filter(a =>
        (a.article||'').toLowerCase().includes(search) ||
        (a.client||'').toLowerCase().includes(search) ||
        (a.reference||'').toLowerCase().includes(search)
    );

    renderArticleList(list, 'navettesList', 'navette');
}

// ‚îÄ‚îÄ‚îÄ STOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function displayStock() {
    const stocks = articles.filter(a => a.type === 'Stock' && a.statut === 'Stock');
    const totalQty = stocks.reduce((s, a) => s + (a.quantiteStock || 0), 0);
    const faibles = stocks.filter(a => a.quantiteStock !== null && a.quantiteStock < 5 && a.quantiteStock > 0).length;
    const epuises = stocks.filter(a => a.quantiteStock === 0).length;

    document.getElementById('stockStats').innerHTML = `
        <div class="stat-box green"><div class="num">${stocks.length}</div><div class="lbl">Articles en Stock</div></div>
        <div class="stat-box blue"><div class="num">${totalQty}</div><div class="lbl">Quantit√© Totale</div></div>
        <div class="stat-box orange"><div class="num">${faibles}</div><div class="lbl">Stocks Faibles</div></div>
        <div class="stat-box red"><div class="num">${epuises}</div><div class="lbl">√âpuis√©s</div></div>
    `;
    filterStockItems();
}

function filterStockItems() {
    const mag = document.getElementById('stockMagasin').value;
    const search = document.getElementById('stockSearch').value.toLowerCase();

    let list = articles.filter(a => a.type === 'Stock');
    if (mag) list = list.filter(a => a.magasin === mag);
    if (search) list = list.filter(a =>
        (a.article||'').toLowerCase().includes(search) ||
        (a.reference||'').toLowerCase().includes(search)
    );

    if (list.length === 0) {
        document.getElementById('stockList').innerHTML = '<div class="empty-state"><div class="icon">üì¶</div>Aucun article en stock</div>';
        return;
    }

    const html = list.map(a => {
        const qty = a.quantiteStock !== null ? a.quantiteStock : a.nombreColis;
        const qtyClass = qty === 0 ? 'empty' : (qty < 5 ? 'low' : '');
        const badge = a.statut === 'Sorti' ? 'badge-sorti' : 'badge-stock';
        const statutLabel = a.statut === 'Sorti' ? '√âpuis√©' : 'En stock';
        return `
        <div class="article-item" onclick="openArticleModal('${a.id}')">
            <div class="article-item-header">
                <div>
                    <div class="article-item-title">${a.article}</div>
                    <div class="article-item-ref">${a.reference} ‚Äî ${a.magasin}</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                    <span class="badge ${badge}">${statutLabel}</span>
                    ${a.quantiteStock !== null ? `<span class="stock-qty ${qtyClass}">${a.quantiteStock} <span style="font-size:12px;font-weight:400;color:var(--text-muted)">/ ${a.quantiteInitiale}</span></span>` : ''}
                </div>
            </div>
            <div class="article-meta">
                <span class="meta-chip">üìç <strong>${a.emplacement}</strong></span>
                <span class="meta-chip">üë§ <strong>${a.client}</strong></span>
                ${a.nombreColis > 1 ? `<span class="meta-chip">üì¶ <strong>${a.nombreColis} colis</strong></span>` : ''}
            </div>
        </div>`;
    }).join('');

    document.getElementById('stockList').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ PR√äTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function displayPrets() {
    const prets = articles.filter(a => a.statut === 'Pr√™t');
    const retards = prets.filter(a => new Date(a.dateRetourPrevue) < new Date());
    const bientot = prets.filter(a => {
        const diff = (new Date(a.dateRetourPrevue) - new Date()) / 86400000;
        return diff >= 0 && diff <= 3;
    });

    document.getElementById('pretsStats').innerHTML = `
        <div class="stat-box orange"><div class="num">${prets.length}</div><div class="lbl">Pr√™ts Actifs</div></div>
        <div class="stat-box red"><div class="num">${retards.length}</div><div class="lbl">En Retard</div></div>
        <div class="stat-box blue"><div class="num">${bientot.length}</div><div class="lbl">Retour Bient√¥t</div></div>
    `;

    document.getElementById('pretsBadge').textContent = retards.length;
    document.getElementById('pretsBadge').style.display = retards.length > 0 ? 'inline' : 'none';

    filterPrets();
}

function filterPrets() {
    const mag = document.getElementById('pretMagasin').value;
    const stat = document.getElementById('pretStatut').value;

    let list = articles.filter(a => a.statut === 'Pr√™t');
    if (mag) list = list.filter(a => a.magasin === mag);

    if (stat === 'retard') list = list.filter(a => new Date(a.dateRetourPrevue) < new Date());
    else if (stat === 'bientot') list = list.filter(a => {
        const diff = (new Date(a.dateRetourPrevue) - new Date()) / 86400000;
        return diff >= 0 && diff <= 3;
    });
    else if (stat === 'Pr√™t') list = list.filter(a => new Date(a.dateRetourPrevue) >= new Date());

    if (list.length === 0) {
        document.getElementById('pretsList').innerHTML = '<div class="empty-state"><div class="icon">üîÑ</div>Aucun pr√™t en cours</div>';
        return;
    }

    const html = list.map(a => {
        const retard = new Date(a.dateRetourPrevue) < new Date();
        const diff = Math.ceil((new Date(a.dateRetourPrevue) - new Date()) / 86400000);
        return `
        <div class="article-item" onclick="openArticleModal('${a.id}')" style="${retard ? 'border-color:var(--red)' : ''}">
            <div class="article-item-header">
                <div>
                    <div class="article-item-title">${a.article}</div>
                    <div class="article-item-ref">${a.reference} ‚Äî ${a.magasin}</div>
                </div>
                <span class="badge ${retard ? 'badge-retard' : 'badge-pret'}">
                    ${retard ? `‚ö†Ô∏è +${Math.abs(diff)}j` : `‚Ü©Ô∏è J-${diff}`}
                </span>
            </div>
            <div class="article-meta">
                <span class="meta-chip">üë§ Pr√™t√© √† <strong>${a.prenomEmprunteur}</strong></span>
                <span class="meta-chip">üìÖ <strong>${new Date(a.datePret).toLocaleDateString()}</strong></span>
                <span class="meta-chip">‚Ü©Ô∏è Retour <strong>${new Date(a.dateRetourPrevue).toLocaleDateString()}</strong></span>
                <span class="meta-chip">üë• Client: <strong>${a.client}</strong></span>
            </div>
        </div>`;
    }).join('');

    document.getElementById('pretsList').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function displayAlertes() {
    const mag = document.getElementById('alerteMagasin').value;
    const list = mag ? articles.filter(a => a.magasin === mag) : articles;
    let alertes = [];

    list.filter(a => a.statut === 'Pr√™t' && new Date(a.dateRetourPrevue) < new Date())
        .forEach(a => {
            const j = Math.floor((new Date() - new Date(a.dateRetourPrevue)) / 86400000);
            alertes.push({ type: 'danger', t: `Pr√™t en retard ‚Äî ${a.article}`, m: `${a.magasin} ¬∑ ${a.prenomEmprunteur} ¬∑ ${j}j de retard`, id: a.id });
        });

    list.filter(a => { if (a.statut !== 'Pr√™t') return false; const d = (new Date(a.dateRetourPrevue)-new Date())/86400000; return d>=0&&d<=3; })
        .forEach(a => {
            const j = Math.ceil((new Date(a.dateRetourPrevue)-new Date())/86400000);
            alertes.push({ type: 'warning', t: `Retour bient√¥t ‚Äî ${a.article}`, m: `${a.magasin} ¬∑ ${a.prenomEmprunteur} ¬∑ dans ${j}j`, id: a.id });
        });

    list.filter(a => a.type === 'Stock' && a.quantiteStock !== null && a.quantiteStock > 0 && a.quantiteStock < 5)
        .forEach(a => alertes.push({ type: 'warning', t: `Stock faible ‚Äî ${a.article}`, m: `${a.magasin} ¬∑ ${a.quantiteStock} unit√©(s) restante(s)`, id: a.id }));

    list.filter(a => a.type === 'Stock' && a.quantiteStock === 0)
        .forEach(a => alertes.push({ type: 'danger', t: `Stock √©puis√© ‚Äî ${a.article}`, m: `${a.magasin} ¬∑ R√©approvisionner`, id: a.id }));

    document.getElementById('alertesBadge').textContent = alertes.filter(a=>a.type==='danger').length;
    document.getElementById('alertesBadge').style.display = alertes.filter(a=>a.type==='danger').length > 0 ? 'inline' : 'none';

    if (!alertes.length) {
        document.getElementById('alertesList').innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div>Aucune alerte</div>';
        return;
    }

    document.getElementById('alertesList').innerHTML = alertes.map(al => `
        <div class="alert-box ${al.type}" onclick="openArticleModal('${al.id}')">
            <span>${al.type==='danger'?'üî¥':'üü°'}</span>
            <div><strong>${al.t}</strong><br><span style="font-size:12px;opacity:.8">${al.m}</span></div>
        </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL ARTICLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function openArticleModal(articleId) {
    const a = articles.find(x => x.id === articleId);
    if (!a) { alert('Article introuvable'); return; }

    document.getElementById('modalTitle').textContent = a.article;

    const histo = await loadHistorique(articleId);

    // D√©tecter le type de badge
    let badgeClass = 'badge-stock', badgeLabel = a.statut;
    if (a.statut === 'Pr√™t') { badgeClass = 'badge-pret'; }
    if (a.statut === 'Sorti') { badgeClass = 'badge-sorti'; }
    if (a.statut === 'SAV' || a.type === 'SAV') { badgeClass = 'badge-sav'; }

    let html = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
            <span class="badge ${badgeClass}">${badgeLabel}</span>
            <span class="badge badge-navette">${a.type}</span>
        </div>
        <div class="detail-grid">
            <div class="detail-field"><div class="key">Magasin</div><div class="val">${a.magasin}</div></div>
            <div class="detail-field"><div class="key">Client</div><div class="val">${a.client}</div></div>
            <div class="detail-field"><div class="key">R√©f√©rence</div><div class="val">${a.reference}</div></div>
            <div class="detail-field"><div class="key">Emplacement</div><div class="val">${a.emplacement}</div></div>
            ${a.numeroAR ? `<div class="detail-field"><div class="key">N¬∞ AR</div><div class="val">${a.numeroAR}</div></div>` : ''}
            ${a.quantiteStock !== null ? `<div class="detail-field"><div class="key">Quantit√©</div><div class="val">${a.quantiteStock} / ${a.quantiteInitiale}</div></div>` : ''}
            ${a.nombreColis > 1 ? `<div class="detail-field"><div class="key">Colis</div><div class="val">${a.nombreColis}</div></div>` : ''}
            <div class="detail-field"><div class="key">R√©ceptionn√© par</div><div class="val">${a.kitchener}</div></div>
            <div class="detail-field"><div class="key">Date R√©ception</div><div class="val">${new Date(a.dateReception).toLocaleDateString('fr-FR')}</div></div>
            ${a.notes ? `<div class="detail-field full"><div class="key">Notes</div><div class="val">${a.notes}</div></div>` : ''}
        </div>
    `;

    if (a.statut === 'Pr√™t') {
        html += `
        <div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:14px;margin-bottom:16px;">
            <div style="font-size:13px;color:var(--orange);font-weight:600;">En pr√™t depuis le ${new Date(a.datePret).toLocaleDateString('fr-FR')}</div>
            <div style="font-size:12px;color:var(--text-dim);margin-top:4px;">Pr√™t√© √† ${a.prenomEmprunteur} ¬∑ Retour pr√©vu le ${new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR')}</div>
        </div>`;
    }

    // Actions
    html += `
    <div class="prenom-bar">
        <label>üë§ Votre pr√©nom</label>
        <input type="text" id="actionPrenom" placeholder="Obligatoire pour toute action">
    </div>
    <div class="btn-row">`;

    if (a.statut === 'Stock') {
        html += `<button class="btn btn-success" onclick="actionSortir('${a.id}')">üì§ Sortir</button>`;
        html += `<button class="btn btn-warning" onclick="actionPreter('${a.id}')">üîÑ Pr√™ter</button>`;
        html += `<button class="btn btn-ghost" onclick="actionEmplacement('${a.id}')">üìç Emplacement</button>`;
        if (a.type === 'Stock') {
            html += `<button class="btn btn-cyan" onclick="actionSortirQte('${a.id}')">üì¶ Sortir quantit√©</button>`;
            html += `<button class="btn btn-primary" onclick="actionAjouterQte('${a.id}')">‚ûï Ajouter stock</button>`;
        }
    }

    if (a.statut === 'Pr√™t') {
        html += `<button class="btn btn-success" onclick="actionRetourPret('${a.id}')">‚Ü©Ô∏è Retour de pr√™t</button>`;
    }

    html += `</div>`;

    // Historique
    html += `
    <div class="divider"></div>
    <div style="font-size:14px;font-weight:600;margin-bottom:12px;">üìú Historique</div>`;

    if (histo.length === 0) {
        html += '<div style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px;">Aucun historique</div>';
    } else {
        html += histo.map(h => `
            <div class="histo-item">
                <div class="histo-date">${new Date(h.date).toLocaleString('fr-FR')}</div>
                <div class="histo-action">${h.action} ‚Äî ${h.utilisateur}</div>
                ${h.details ? `<div class="histo-detail">${h.details}</div>` : ''}
            </div>`).join('');
    }

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('articleModal').classList.add('active');
}

function closeModal() {
    document.getElementById('articleModal').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getPrenom() {
    const p = document.getElementById('actionPrenom').value.trim();
    if (!p) { alert('Entrez votre pr√©nom pour effectuer cette action'); return null; }
    return p;
}

async function actionSortir(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const raison = prompt('Raison de la sortie (ex: TLE, Poseur, Client) :');
    if (!raison) return;
    const a = articles.find(x => x.id === id);
    a.statut = 'Sorti'; a.dateSortie = new Date().toISOString(); a.raisonSortie = raison;
    await doUpdate(a);
    doHistorique(id, 'Sortie', prenom, `Raison: ${raison}`);
    closeModal(); alert('‚úÖ Article sorti'); loadData();
}

async function actionSortirQte(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const qteStr = prompt(`Quantit√© √† sortir (stock actuel : ${a.quantiteStock}) :`);
    if (!qteStr) return;
    const qte = parseInt(qteStr);
    if (isNaN(qte) || qte <= 0) { alert('Quantit√© invalide'); return; }
    if (qte > a.quantiteStock) { alert(`Quantit√© insuffisante (${a.quantiteStock} disponible)`); return; }
    a.quantiteStock -= qte;
    if (a.quantiteStock === 0) a.statut = 'Sorti';
    await doUpdate(a);
    doHistorique(id, 'Sortie stock', prenom, `${qte} unit√©(s) sortie(s) ‚Äî Reste: ${a.quantiteStock}`);
    closeModal(); alert(`‚úÖ ${qte} unit√©(s) sortie(s). Reste : ${a.quantiteStock}`); loadData();
}

async function actionAjouterQte(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const qteStr = prompt(`Quantit√© √† ajouter (stock actuel : ${a.quantiteStock || 0}) :`);
    if (!qteStr) return;
    const qte = parseInt(qteStr);
    if (isNaN(qte) || qte <= 0) { alert('Quantit√© invalide'); return; }
    a.quantiteStock = (a.quantiteStock || 0) + qte;
    a.quantiteInitiale = Math.max(a.quantiteInitiale || 0, a.quantiteStock);
    if (a.statut === 'Sorti') a.statut = 'Stock';
    await doUpdate(a);
    doHistorique(id, 'Ajout stock', prenom, `+${qte} unit√©(s) ‚Äî Nouveau stock: ${a.quantiteStock}`);
    closeModal(); alert(`‚úÖ Stock mis √† jour : ${a.quantiteStock} unit√©(s)`); loadData();
}

async function actionPreter(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const emprunteur = prompt('Pr√©nom de l\'emprunteur :');
    if (!emprunteur) return;
    const dateStr = prompt('Date de retour pr√©vue (JJ/MM/AAAA) :');
    if (!dateStr) return;
    const [j, m, y] = dateStr.split('/');
    const a = articles.find(x => x.id === id);
    a.statut = 'Pr√™t';
    a.datePret = new Date().toISOString();
    a.prenomEmprunteur = emprunteur;
    a.dateRetourPrevue = new Date(y, m-1, j).toISOString();
    await doUpdate(a);
    doHistorique(id, 'Pr√™t', prenom, `√Ä ${emprunteur} ‚Äî Retour: ${dateStr}`);
    closeModal(); alert('‚úÖ Pr√™t enregistr√©'); loadData();
}

async function actionRetourPret(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const emprunteur = a.prenomEmprunteur;
    a.statut = 'Stock'; a.dateRetourReel = new Date().toISOString();
    await doUpdate(a);
    doHistorique(id, 'Retour pr√™t', prenom, `Retourn√© par ${emprunteur}`);
    closeModal(); alert('‚úÖ Retour enregistr√©'); loadData();
}

async function actionEmplacement(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const nouvel = prompt(`Nouvel emplacement (actuel: ${a.emplacement}) :`);
    if (!nouvel) return;
    const ancien = a.emplacement;
    a.emplacement = nouvel;
    await doUpdate(a);
    doHistorique(id, 'Changement emplacement', prenom, `${ancien} ‚Üí ${nouvel}`);
    closeModal(); alert('‚úÖ Emplacement mis √† jour'); loadData();
}

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function doUpdate(a) {
    return apiCall({
        action: 'updateArticle',
        ID: a.id, Magasin: a.magasin, Type: a.type, Client: a.client,
        NumeroAR: a.numeroAR || '', Article: a.article, Reference: a.reference,
        NombreColis: a.nombreColis,
        QuantiteStock: a.quantiteStock !== null ? a.quantiteStock : '',
        QuantiteInitiale: a.quantiteInitiale !== null ? a.quantiteInitiale : '',
        Emplacement: a.emplacement, Kitchener: a.kitchener, Notes: a.notes || '',
        Statut: a.statut, DateReception: a.dateReception,
        DatePret: a.datePret || '', PrenomEmprunteur: a.prenomEmprunteur || '',
        DateRetourPrevue: a.dateRetourPrevue || '', DateRetourReel: a.dateRetourReel || '',
        DateSortie: a.dateSortie || '', RaisonSortie: a.raisonSortie || ''
    });
}

function doHistorique(id, action, user, details = '') {
    delete historiquesCache[id];
    apiCall({ action: 'addHistorique', ArticleID: id, Action: action,
        Date: new Date().toISOString(), Utilisateur: user, Details: details });
}

async function loadHistorique(id) {
    if (historiquesCache[id]) return historiquesCache[id];
    return new Promise(resolve => {
        const cb = 'hcb_' + Date.now();
        window[cb] = (data) => { cleanup(cb); historiquesCache[id] = data || []; resolve(historiquesCache[id]); };
        makeScript(`${API_URL}?action=getHistorique&articleId=${encodeURIComponent(id)}&callback=${cb}`);
    });
}

// ‚îÄ‚îÄ‚îÄ RENDER LISTE G√âN√âRIQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderArticleList(list, containerId, context) {
    if (list.length === 0) {
        document.getElementById(containerId).innerHTML = '<div class="empty-state"><div class="icon">üì≠</div>Aucun article</div>';
        return;
    }
    document.getElementById(containerId).innerHTML = list.map(a => {
        let badgeClass = 'badge-stock', badgeLabel = a.statut;
        if (a.statut === 'Pr√™t') badgeClass = 'badge-pret';
        if (a.statut === 'Sorti') badgeClass = 'badge-sorti';
        if (a.statut === 'SAV' || a.type === 'SAV') { badgeClass = 'badge-sav'; badgeLabel = 'SAV'; }
        return `
        <div class="article-item" onclick="openArticleModal('${a.id}')">
            <div class="article-item-header">
                <div>
                    <div class="article-item-title">${a.article}</div>
                    <div class="article-item-ref">${a.reference}</div>
                </div>
                <span class="badge ${badgeClass}">${badgeLabel}</span>
            </div>
            <div class="article-meta">
                <span class="meta-chip">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta-chip">üë§ <strong>${a.client}</strong></span>
                <span class="meta-chip">üìç <strong>${a.emplacement}</strong></span>
                ${a.numeroAR ? `<span class="meta-chip">N¬∞AR <strong>${a.numeroAR}</strong></span>` : ''}
                ${a.nombreColis > 1 ? `<span class="meta-chip">üì¶ <strong>${a.nombreColis} colis</strong></span>` : ''}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function refreshAllViews() {
    if (document.getElementById('navettes').classList.contains('active')) displayNavettes();
    if (document.getElementById('stock').classList.contains('active')) displayStock();
    if (document.getElementById('prets').classList.contains('active')) displayPrets();
    if (document.getElementById('alertes').classList.contains('active')) displayAlertes();
    // Badges
    const retards = articles.filter(a => a.statut === 'Pr√™t' && new Date(a.dateRetourPrevue) < new Date()).length;
    document.getElementById('pretsBadge').textContent = retards;
    document.getElementById('pretsBadge').style.display = retards > 0 ? 'inline' : 'none';
}

// Recharger toutes les 60s
setInterval(() => loadData(), 60000);
</script>
</body>
</html>
