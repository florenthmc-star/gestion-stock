<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMC ‚Äî Gestion de Stock</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root{
            --bg:#f5f7fa;--white:#fff;--border:#e2e7ef;--border2:#d0d7e3;
            --blue:#3b6ef8;--blue-dark:#2952d9;--blue-soft:#eff3fe;
            --green:#16a34a;--green-soft:#f0fdf4;--green-border:#bbf7d0;
            --orange:#d97706;--orange-soft:#fffbeb;--orange-border:#fde68a;
            --red:#dc2626;--red-soft:#fef2f2;--red-border:#fecaca;
            --purple:#7c3aed;--purple-soft:#f5f3ff;--purple-border:#ddd6fe;
            --teal:#0891b2;--teal-soft:#ecfeff;--teal-border:#a5f3fc;
            --text:#111827;--text2:#374151;--text3:#6b7280;
            --r:12px;--r2:8px;
            --shadow:0 1px 3px rgba(0,0,0,.07),0 1px 2px rgba(0,0,0,.05);
            --shadow-md:0 4px 16px rgba(0,0,0,.09);
            --shadow-lg:0 12px 32px rgba(0,0,0,.12);
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
        main{flex:1;}

        .header{background:var(--white);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:60px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
        .brand{display:flex;align-items:center;gap:10px;}
        .brand-icon{width:34px;height:34px;background:var(--blue);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
        .brand-name{font-size:16px;font-weight:800;}
        .brand-sub{font-size:11px;color:var(--text3);margin-top:1px;}
        .pill{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
        .pill.ok{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border);}
        .pill.loading{background:var(--orange-soft);color:var(--orange);border:1px solid var(--orange-border);}
        .pill.err{background:var(--red-soft);color:var(--red);border:1px solid var(--red-border);}
        .btn-sm{padding:6px 13px;border-radius:var(--r2);font-size:12px;font-weight:600;border:1px solid var(--border2);background:var(--white);color:var(--text2);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
        .btn-sm:hover{background:var(--bg);border-color:var(--blue);color:var(--blue);}

        .tabs{background:var(--white);border-bottom:1px solid var(--border);padding:0 28px;display:flex;gap:2px;overflow-x:auto;scrollbar-width:none;}
        .tabs::-webkit-scrollbar{display:none;}
        .tab{padding:0 16px;height:46px;font-size:13px;font-weight:600;color:var(--text3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .18s;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;gap:6px;}
        .tab:hover{color:var(--text2);}
        .tab.active{color:var(--blue);border-bottom-color:var(--blue);}
        .tab-badge{background:var(--red);color:white;padding:1px 5px;border-radius:10px;font-size:10px;font-weight:700;line-height:1.4;}

        .page{max-width:1060px;margin:0 auto;padding:24px 20px;}
        .pane{display:none;animation:fadeIn .15s ease;}
        .pane.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
        .page-title{font-size:20px;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:8px;}

        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;}
        .stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px 15px;box-shadow:var(--shadow);transition:box-shadow .15s;}
        .stat-card:hover{box-shadow:var(--shadow-md);}
        .stat-card .num{font-size:1.8em;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1;margin-bottom:5px;}
        .stat-card .lbl{font-size:11px;font-weight:600;color:var(--text3);}
        .stat-card.blue .num{color:var(--blue);}
        .stat-card.green .num{color:var(--green);}
        .stat-card.orange .num{color:var(--orange);}
        .stat-card.red .num{color:var(--red);}
        .stat-card.purple .num{color:var(--purple);}

        .card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);margin-bottom:14px;}

        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
        .fg{display:flex;flex-direction:column;gap:5px;}
        .fg.full{grid-column:1/-1;}
        .fg label{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;}
        .fg input,.fg select,.fg textarea{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:10px 13px;color:var(--text);font-size:14px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;transition:border-color .15s,box-shadow .15s;}
        .fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,110,248,.1);background:var(--white);}
        .fg .hint{font-size:11px;color:var(--text3);margin-top:2px;}

        .btn{padding:10px 18px;border-radius:var(--r2);font-size:13px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all .18s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
        .btn:disabled{opacity:.45;cursor:not-allowed;}
        .btn-primary{background:var(--blue);color:white;box-shadow:0 2px 8px rgba(59,110,248,.25);}
        .btn-primary:hover:not(:disabled){background:var(--blue-dark);box-shadow:0 4px 12px rgba(59,110,248,.35);}
        .btn-success{background:var(--green);color:white;}
        .btn-success:hover:not(:disabled){filter:brightness(1.08);}
        .btn-warning{background:var(--orange);color:white;}
        .btn-warning:hover:not(:disabled){filter:brightness(1.08);}
        .btn-danger{background:var(--red);color:white;}
        .btn-danger:hover:not(:disabled){filter:brightness(1.08);}
        .btn-purple{background:var(--purple);color:white;}
        .btn-purple:hover:not(:disabled){filter:brightness(1.08);}
        .btn-teal{background:var(--teal);color:white;}
        .btn-teal:hover:not(:disabled){filter:brightness(1.08);}
        .btn-outline{background:white;color:var(--text2);border:1.5px solid var(--border2);}
        .btn-outline:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-soft);}
        .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;}

        .filter-bar{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px;box-shadow:var(--shadow);}
        .filter-bar select,.filter-bar input{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:8px 12px;color:var(--text);font-size:13px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;}
        .filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--blue);}

        .article-item{background:var(--white);border:1.5px solid var(--border);border-radius:var(--r);padding:16px 18px;margin-bottom:9px;cursor:pointer;transition:border-color .15s,box-shadow .15s,transform .15s;box-shadow:var(--shadow);}
        .article-item:hover{border-color:var(--blue);box-shadow:var(--shadow-md);transform:translateY(-1px);}
        .item-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
        .item-title{font-size:14px;font-weight:700;}
        .item-client{font-size:15px;font-weight:800;color:var(--text);margin-top:3px;}
        .item-ref{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:2px;}
        .item-meta{display:flex;flex-wrap:wrap;gap:12px;}
        .meta{font-size:12px;color:var(--text3);display:flex;align-items:center;gap:3px;}
        .meta strong{color:var(--text2);font-weight:600;}

        .badge{padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
        .b-stock{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border);}
        .b-mad{background:var(--blue-soft);color:var(--blue);border:1px solid #c7d7fd;}
        .b-pret{background:var(--orange-soft);color:var(--orange);border:1px solid var(--orange-border);}
        .b-sorti{background:#f3f4f6;color:var(--text3);border:1px solid var(--border2);}
        .b-sav{background:var(--red-soft);color:var(--red);border:1px solid var(--red-border);}
        .b-retard{background:var(--red);color:white;}
        .b-purple{background:var(--purple-soft);color:var(--purple);border:1px solid var(--purple-border);}
        .b-dispo{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border);}

        /* Pr√™t individuel */
        .loan-item{background:var(--bg);border:1px solid var(--border);border-radius:var(--r2);padding:13px 15px;margin-bottom:8px;}
        .loan-item.retard{background:var(--red-soft);border-color:var(--red-border);}
        .loan-item.bientot{background:var(--orange-soft);border-color:var(--orange-border);}
        .loan-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;}
        .loan-client{font-size:14px;font-weight:800;color:var(--text);}
        .loan-meta{display:flex;flex-wrap:wrap;gap:10px;}
        .loan-meta span{font-size:12px;color:var(--text3);}
        .loan-meta strong{color:var(--text2);}

        .overlay{display:none;position:fixed;inset:0;background:rgba(17,24,39,.35);z-index:200;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(3px);}
        .overlay.active{display:flex;}
        .modal{background:var(--white);border-radius:14px;max-width:620px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);display:flex;flex-direction:column;}
        .modal-top{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;position:sticky;top:0;background:white;z-index:2;flex-shrink:0;}
        .modal-close{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:var(--bg);color:var(--text3);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
        .modal-close:hover{background:var(--red-soft);color:var(--red);border-color:var(--red-border);}
        .modal-body{padding:20px 24px;overflow-y:auto;}

        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:16px;}
        .detail-field{background:var(--bg);border-radius:var(--r2);padding:11px 13px;border:1px solid var(--border);}
        .detail-field .k{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px;}
        .detail-field .v{font-size:13px;font-weight:600;}
        .detail-field.full{grid-column:1/-1;}

        .histo{padding:10px 13px;border-left:3px solid var(--blue);background:var(--bg);border-radius:0 var(--r2) var(--r2) 0;margin-bottom:7px;}
        .histo-date{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
        .histo-action{font-size:12px;font-weight:700;margin:2px 0;}
        .histo-detail{font-size:11px;color:var(--text3);}

        .alert-item{padding:12px 16px;border-radius:var(--r2);margin-bottom:9px;cursor:pointer;transition:transform .15s;display:flex;gap:10px;align-items:flex-start;}
        .alert-item:hover{transform:translateX(3px);}
        .alert-item.danger{background:var(--red-soft);border:1.5px solid var(--red-border);}
        .alert-item.warning{background:var(--orange-soft);border:1.5px solid var(--orange-border);}

        .prenom-bar{background:var(--blue-soft);border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:12px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px;}
        .prenom-bar label{font-size:12px;font-weight:700;color:var(--blue);white-space:nowrap;}
        .prenom-bar input{flex:1;background:white;border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:8px 12px;color:var(--text);font-size:13px;font-weight:500;font-family:'Plus Jakarta Sans',sans-serif;}
        .prenom-bar input:focus{outline:none;border-color:var(--blue);}

        .divider{height:1px;background:var(--border);margin:16px 0;}
        .section-lbl{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px;}

        .sub-tabs{display:flex;gap:7px;margin-bottom:16px;flex-wrap:wrap;}
        .sub-tab{padding:7px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--white);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
        .sub-tab:hover{border-color:var(--blue);color:var(--blue);}
        .sub-tab.active{background:var(--blue);color:white;border-color:var(--blue);}
        .sub-tab.s-warn.active{background:var(--orange);border-color:var(--orange);}
        .sub-tab.s-danger.active{background:var(--red);border-color:var(--red);}
        .sub-tab.s-purple.active{background:var(--purple);border-color:var(--purple);}

        .empty{text-align:center;padding:44px 20px;color:var(--text3);}
        .empty .ico{font-size:36px;margin-bottom:10px;}

        .qty-big{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;}
        .qty-big.ok{color:var(--green);}
        .qty-big.low{color:var(--orange);}
        .qty-big.empty{color:var(--red);}

        /* Compteur disponible/pr√™t√© */
        .dispo-counter{display:flex;gap:10px;align-items:center;padding:10px 14px;background:var(--purple-soft);border:1px solid var(--purple-border);border-radius:var(--r2);margin-bottom:14px;}
        .dispo-num{font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;}
        .dispo-num.ok{color:var(--green);}
        .dispo-num.low{color:var(--orange);}
        .dispo-num.empty{color:var(--red);}
        .dispo-label{font-size:12px;color:var(--text3);line-height:1.4;}
        .dispo-label strong{color:var(--text2);display:block;}

        .settings-section{margin-bottom:20px;}
        .settings-section h3{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);}
        .setting-row{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--white);border:1px solid var(--border);border-radius:var(--r2);margin-bottom:7px;gap:14px;flex-wrap:wrap;}
        .setting-row label{font-size:13px;font-weight:600;color:var(--text2);}
        .setting-row .si{display:flex;align-items:center;gap:7px;}
        .setting-row input[type=number]{width:65px;padding:7px 9px;border:1.5px solid var(--border);border-radius:var(--r2);font-size:14px;font-weight:600;text-align:center;background:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;}
        .setting-row input[type=number]:focus{outline:none;border-color:var(--blue);}
        .setting-row span{font-size:12px;color:var(--text3);}

        .edit-form{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r2);padding:14px;margin-bottom:14px;}
        .edit-form .form-grid{gap:10px;}
        .edit-form input,.edit-form select,.edit-form textarea{background:white;border:1.5px solid var(--border);border-radius:var(--r2);padding:8px 11px;color:var(--text);font-size:13px;font-family:'Plus Jakarta Sans',sans-serif;width:100%;}
        .edit-form input:focus,.edit-form select:focus,.edit-form textarea:focus{outline:none;border-color:var(--blue);}

        footer{background:var(--white);border-top:1px solid var(--border);text-align:center;padding:12px;font-size:12px;color:var(--text3);}

        @media(max-width:640px){
            .page{padding:14px;}
            .header{padding:0 14px;}
            .tabs{padding:0 14px;}
            .detail-grid{grid-template-columns:1fr;}
            .brand-sub{display:none;}
            .stats-row{grid-template-columns:repeat(2,1fr);}
            .modal-body{padding:14px 16px;}
        }
    </style>
</head>
<body>
<main>

<div class="header">
    <div class="brand">
        <div class="brand-icon">üì¶</div>
        <div>
            <div class="brand-name">HMC Stock</div>
            <div class="brand-sub">Gestion multi-magasins</div>
        </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
        <div class="pill loading" id="statusPill">üîÑ Connexion...</div>
        <button class="btn-sm" onclick="loadData()">‚Üª Actualiser</button>
    </div>
</div>

<div class="tabs">
    <button class="tab active" onclick="switchTab('reception',this)">üì• R√©ception</button>
    <button class="tab" onclick="switchTab('mad',this)">üöö Mises √† dispo <span class="tab-badge" id="madBadge" style="display:none">!</span></button>
    <button class="tab" onclick="switchTab('stock',this)">üì¶ Stock</button>
    <button class="tab" onclick="switchTab('tle',this)">üöö TLE <span class="tab-badge" id="tleBadge" style="display:none">!</span></button>
    <button class="tab" onclick="switchTab('prets',this)">üîÑ Pr√™ts <span class="tab-badge" id="retardBadge" style="display:none">!</span></button>
    <button class="tab" onclick="switchTab('alertes',this)">üîî Alertes <span class="tab-badge" id="alertBadge" style="display:none">!</span></button>
    <button class="tab" onclick="switchTab('parametres',this)">‚öôÔ∏è Param√®tres</button>
</div>

<div class="page">

<!-- ‚ïê‚ïê‚ïê R√âCEPTION ‚ïê‚ïê‚ïê -->
<div id="reception" class="pane active">
    <div class="page-title">üì• R√©ception d'Article</div>
    <div class="card">
        <form id="receptionForm">
            <div class="form-grid">
                <div class="fg">
                    <label>Magasin *</label>
                    <select id="f_magasin" required onchange="onMagasinChange()">
                        <option value="">S√©lectionner...</option>
                        <option>Lattes</option><option>Ved√®ne</option>
                        <option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
                    </select>
                </div>
                <div class="fg">
                    <label>Type *</label>
                    <select id="f_type" required onchange="toggleFormFields()">
                        <option value="">S√©lectionner...</option>
                        <option value="Mise √† disposition">üöö Mise √† disposition</option>
                        <option value="Stock">üì¶ Stock</option>
                        <option value="Article de pr√™t">üîÑ Article de pr√™t</option>
                    </select>
                </div>
                <!-- Client : masqu√© pour Stock et Article de pr√™t -->
                <div class="fg" id="clientGroup">
                    <label>Nom du Client *</label>
                    <input id="f_client" type="text" placeholder="Nom du client">
                </div>
                <!-- Sous-type MAD : visible uniquement pour Mise √† disposition -->
                <div class="fg" id="madSubtypeGroup" style="display:none">
                    <label>Type *</label>
                    <select id="f_mad_subtype">
                        <option value="Commande">üì¶ Commande client</option>
                        <option value="SAV">üîß SAV</option>
                    </select>
                </div>
                <div class="fg" id="arGroup">
                    <label>N¬∞ AR</label>
                    <input id="f_ar" type="text" placeholder="Num√©ro AR">
                </div>
                <div class="fg">
                    <label>Article *</label>
                    <input id="f_article" type="text" required placeholder="Nom de l'article">
                </div>
                <div class="fg">
                    <label>R√©f√©rence *</label>
                    <input id="f_ref" type="text" required placeholder="R√©f√©rence">
                </div>
                <div class="fg" id="colisGroup">
                    <label>Nombre de Colis *</label>
                    <input id="f_colis" type="number" min="1" value="1">
                </div>
                <!-- Quantit√© : visible pour Stock et Article de pr√™t -->
                <div class="fg" id="qtyGroup" style="display:none">
                    <label id="qtyLabel">Quantit√© *</label>
                    <input id="f_qty" type="number" min="1" value="1">
                    <span class="hint" id="qtyHint"></span>
                </div>
                <!-- Prix de vente : visible pour Stock uniquement -->
                <div class="fg" id="priceGroup" style="display:none">
                    <label>Prix de vente unitaire (‚Ç¨)</label>
                    <input id="f_price" type="number" min="0" step="0.01" placeholder="Ex: 45.00">
                    <span class="hint">Optionnel - utile si l'article peut √™tre vendu</span>
                </div>
                <!-- Seuil alerte : visible pour Stock uniquement -->
                <div class="fg" id="seuilGroup" style="display:none">
                    <label>Seuil d'alerte (stock faible)</label>
                    <input id="f_seuil" type="number" min="0" value="5">
                    <span class="hint">Alerte si quantit√© ‚â§ ce nombre</span>
                </div>
                <div class="fg" id="emplacementGroup">
                    <label>Emplacement *</label>
                    <input id="f_emplacement_text" type="text" placeholder="Ex: Rayon A, √âtag√®re 3">
                    <select id="f_emplacement_select" style="display:none">
                        <option value="">S√©lectionner...</option>
                        <option>R√©serve</option>
                        <option>Bureau en haut</option>
                        <option>Accueil</option>
                    </select>
                </div>
                <div class="fg">
                    <label>Votre Pr√©nom *</label>
                    <input id="f_prenom" type="text" required placeholder="Votre pr√©nom">
                </div>
                <div class="fg full">
                    <label>Notes</label>
                    <textarea id="f_notes" rows="2" placeholder="Observations..."></textarea>
                </div>
            </div>
            <div class="btn-row">
                <button type="submit" class="btn btn-primary" id="submitBtn">‚úÖ G√©n√©rer le QR Code</button>
            </div>
        </form>
    </div>
    <div id="qrResult" style="display:none">
        <div class="card" style="text-align:center;padding:28px 20px;border:1.5px solid #c7d7fd;background:var(--blue-soft);">
            <div style="font-size:15px;font-weight:800;margin-bottom:4px;">‚úÖ Article enregistr√©</div>
            <p style="font-size:13px;color:var(--text3);margin-bottom:16px;">QR code pr√™t √† imprimer et coller sur le colis</p>
            <div id="qrcode" style="display:inline-block;background:white;padding:14px;border-radius:var(--r2);box-shadow:var(--shadow-md);margin-bottom:16px;"></div>
            <div id="qrInfos" style="margin-bottom:16px;font-size:13px;color:var(--text2);line-height:1.9;"></div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="printQR()">üñ®Ô∏è Imprimer l'√©tiquette</button>
                <button class="btn btn-outline" onclick="resetForm()">‚ûï Nouvel article</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê MISES √Ä DISPO ‚ïê‚ïê‚ïê -->
<div id="mad" class="pane">
    <div class="page-title">üöö Mises √† Disposition</div>
    <div class="stats-row" id="madStats"></div>
    <div class="filter-bar">
        <select id="m_mag" onchange="renderMAD()">
            <option value="">Tous les magasins</option>
            <option>Lattes</option><option>Ved√®ne</option><option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
        </select>
        <select id="m_stat" onchange="renderMAD()">
            <option value="">Tous les statuts</option>
            <option value="Stock">En stock</option>
            <option value="Sorti">Sorti</option>
            <option value="SAV">SAV</option>
        </select>
        <input id="m_search" placeholder="üîç Client, article, r√©f, AR..." oninput="renderMAD()" style="flex:1;min-width:180px;">
    </div>
    <div id="madList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê STOCK ‚ïê‚ïê‚ïê -->
<div id="stock" class="pane">
    <div class="page-title">üì¶ Gestion du Stock</div>
    <div class="stats-row" id="stockStats"></div>
    <div class="filter-bar">
        <select id="s_mag" onchange="renderStock()">
            <option value="">Tous les magasins</option>
            <option>Lattes</option><option>Ved√®ne</option><option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
        </select>
        <input id="s_search" placeholder="üîç Article, r√©f√©rence, emplacement..." oninput="renderStock()" style="flex:1;min-width:180px;">
    </div>
    <div id="stockList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê TLE - ARTICLES VENDUS ‚ïê‚ïê‚ïê -->
<div id="tle" class="pane">
    <div class="page-title">üöö Articles vendus ‚Äî TLE</div>
    <div class="stats-row" id="tleStats"></div>
    <div class="filter-bar">
        <select id="t_mag" onchange="renderTLE()">
            <option value="">Tous les magasins</option>
            <option>Lattes</option><option>Ved√®ne</option><option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
        </select>
        <input id="t_search" placeholder="üîç Article, r√©f√©rence..." oninput="renderTLE()" style="flex:1;min-width:180px;">
    </div>
    <div id="tleList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê PR√äTS ‚ïê‚ïê‚ïê -->
<div id="prets" class="pane">
    <div class="page-title">üîÑ Gestion des Pr√™ts</div>
    <div class="stats-row" id="pretsStats"></div>
    <div class="filter-bar">
        <select id="p_mag" onchange="renderPrets()">
            <option value="">Tous les magasins</option>
            <option>Lattes</option><option>Ved√®ne</option><option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
        </select>
        <input id="p_search" placeholder="üîç Article, client emprunteur..." oninput="renderPrets()" style="flex:1;min-width:180px;">
    </div>
    <div class="sub-tabs">
        <button class="sub-tab s-purple active" id="stab_dispo" onclick="setPretTab('dispo')">üü£ Disponibles</button>
        <button class="sub-tab active" id="stab_encours" onclick="setPretTab('encours')">üîµ En cours</button>
        <button class="sub-tab s-warn" id="stab_bientot" onclick="setPretTab('bientot')">üü° Bient√¥t</button>
        <button class="sub-tab s-danger" id="stab_retard" onclick="setPretTab('retard')">üî¥ En retard</button>
    </div>
    <div id="pretsList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê ALERTES ‚ïê‚ïê‚ïê -->
<div id="alertes" class="pane">
    <div class="page-title">üîî Alertes</div>
    <div class="filter-bar">
        <select id="a_mag" onchange="renderAlertes()">
            <option value="">Tous les magasins</option>
            <option>Lattes</option><option>Ved√®ne</option><option>Aix</option><option>N√Æmes</option><option>Vitrolles</option>
        </select>
    </div>
    <div id="alertList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê PARAM√àTRES ‚ïê‚ïê‚ïê -->
<div id="parametres" class="pane">
    <div class="page-title">‚öôÔ∏è Param√®tres des Alertes</div>
    <div class="card">
        <div class="settings-section">
            <h3>üìÖ Alertes pr√™ts ‚Äî D√©lais</h3>
            <div class="setting-row">
                <label>Alerte "Retour bient√¥t" √† partir de</label>
                <div class="si"><input type="number" id="param_bientot" min="1" max="30" value="3"><span>jours avant</span></div>
            </div>
            <div class="setting-row">
                <label>Alerte "Urgence" √† partir de</label>
                <div class="si"><input type="number" id="param_urgent" min="0" max="10" value="1"><span>jours avant (0 = le jour m√™me)</span></div>
            </div>
        </div>
        <div class="settings-section">
            <h3>üóëÔ∏è Nettoyage automatique</h3>
            <p style="font-size:13px;color:var(--text3);margin-bottom:12px;">Supprimez les anciens articles sortis ou retourn√©s pour all√©ger la base de donn√©es.</p>
            <div class="setting-row">
                <label>Archiver automatiquement les articles sortis depuis plus de</label>
                <div class="si"><input type="number" id="param_archive" min="30" max="365" value="90"><span>jours</span></div>
            </div>
            <p style="font-size:12px;color:var(--text3);margin-top:8px;">üí° Cela supprimera les articles avec statut "Sorti" ou pr√™ts "Retourn√©" dont la date de sortie/retour date de plus de X jours.</p>
            <div class="btn-row" style="margin-top:12px;">
                <button class="btn btn-danger" onclick="actArchiveOld()">üóëÔ∏è Nettoyer maintenant</button>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="saveParams()">üíæ Enregistrer ‚Äî synchronis√© sur tous les appareils</button>
            <button class="btn btn-outline" onclick="resetParams()">‚Ü∫ R√©initialiser</button>
        </div>
    </div>
    <div class="card">
        <div class="settings-section">
            <h3>üìã Seuils d'alerte personnalis√©s par article Stock</h3>
            <p style="font-size:13px;color:var(--text3);margin-bottom:14px;">D√©finissez un seuil individuel pour chaque article. Modifiable aussi lors de la cr√©ation ou dans la fiche article.</p>
            <div id="seuilsListe"></div>
        </div>
    </div>
</div>

</div><!-- /page -->
</main>

<!-- MODAL -->
<div class="overlay" id="overlay">
    <div class="modal">
        <div class="modal-top">
            <div>
                <div style="font-size:17px;font-weight:800;" id="mTitle">Article</div>
                <div style="font-size:12px;color:var(--text3);margin-top:2px;" id="mSub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="mBody"></div>
    </div>
</div>

<footer>¬© 2026 Florent Amendola ‚Äî HMC Stock ¬∑ Tous droits r√©serv√©s</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Configuration API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL = 'https://script.google.com/macros/s/AKfycbw4iOVF_nKgOsFhdXDdJRGziUPDKw-qAj4QLU3CadpeqBYVyTLiUxa9WM5bGFUDsFmAiA/exec';
const APP_URL = window.location.origin + window.location.pathname;

// ‚îÄ‚îÄ‚îÄ √âtat global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let articles = [];        // tous les articles (type=Mise √† dispo|Stock|Article de pr√™t)
let pretsActifs = [];     // pr√™ts individuels (sous-articles g√©n√©r√©s par actPreter)
let histoCache = {};
let currentPretTab = 'dispo';
let lastQRData = null;
let params = { alerteBientot:3, alerteUrgent:1, stockFaible:5, archiveJours:90 };
let seuilsPerso = {};
let _renderTimer = null;  // debounce

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
    loadParamsLocal();
    const artId = new URLSearchParams(window.location.search).get('article');
    loadData().then(() => { if (artId) openModal(artId); });
});

// ‚îÄ‚îÄ‚îÄ PARAMS (local + API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadParamsLocal() {
    try {
        const p = localStorage.getItem('hmc_params'); if(p) params={...params,...JSON.parse(p)};
        const s = localStorage.getItem('hmc_seuils'); if(s) seuilsPerso=JSON.parse(s);
    } catch(e){}
    applyParamsToForm();
}

function applyParamsToForm() {
    document.getElementById('param_bientot').value = params.alerteBientot;
    document.getElementById('param_urgent').value = params.alerteUrgent;
    if(document.getElementById('param_archive')) document.getElementById('param_archive').value = params.archiveJours;
}

async function loadParamsFromAPI() {
    const data = await apiCall({ action:'getParams' });
    if (data?.params) { try{ params={...params,...JSON.parse(data.params)}; }catch(e){} }
    if (data?.seuils) { try{ seuilsPerso={...seuilsPerso,...JSON.parse(data.seuils)}; }catch(e){} }
    applyParamsToForm();
}

async function saveParamsToAPI() {
    localStorage.setItem('hmc_params', JSON.stringify(params));
    localStorage.setItem('hmc_seuils', JSON.stringify(seuilsPerso));
    return apiCall({ action:'saveParams', params:JSON.stringify(params), seuils:JSON.stringify(seuilsPerso) });
}

function saveParams() {
    params.alerteBientot = parseInt(document.getElementById('param_bientot').value)||3;
    params.alerteUrgent  = parseInt(document.getElementById('param_urgent').value)||1;
    params.archiveJours  = parseInt(document.getElementById('param_archive')?.value)||90;
    saveParamsToAPI().then(()=>{ alert('‚úÖ Param√®tres enregistr√©s sur tous les appareils !'); renderAlertes(); });
}

function resetParams() {
    params={alerteBientot:3,alerteUrgent:1,stockFaible:5,archiveJours:90};
    saveParamsToAPI().then(()=>{ applyParamsToForm(); alert('‚úÖ R√©initialis√©'); });
}

function renderSeuilsListe() {
    const stocks = articles.filter(a=>a.type==='Stock');
    if (!stocks.length) { document.getElementById('seuilsListe').innerHTML='<p style="color:var(--text3);font-size:13px;">Aucun article en stock.</p>'; return; }
    document.getElementById('seuilsListe').innerHTML = stocks.map(a=>{
        const s = seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        return `<div class="setting-row">
            <div><div style="font-size:13px;font-weight:600;">${a.article}</div><div style="font-size:11px;color:var(--text3);">${a.reference} ¬∑ ${a.magasin}</div></div>
            <div class="si"><input type="number" min="0" value="${s}" style="width:58px;" onchange="setSeuil('${a.id}',this.value)"><span>unit√©s</span></div>
        </div>`;
    }).join('');
}

function setSeuil(id,val) {
    seuilsPerso[id]=parseInt(val)||0;
    saveParamsToAPI();
}

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function apiCall(p) {
    return new Promise(resolve=>{
        const cb='cb'+Date.now()+Math.random().toString(36).slice(2,6);
        let done=false;
        const clean=()=>{ done=true; delete window[cb]; document.getElementById(cb)?.remove(); };
        window[cb]=data=>{ clean(); resolve(data||{}); };
        const s=document.createElement('script');
        s.id=cb; s.src=`${API_URL}?${new URLSearchParams({...p,callback:cb})}`;
        s.onerror=()=>{ clean(); resolve({error:'Network error'}); };
        setTimeout(()=>{ if(!done){clean();resolve({error:'Timeout'});} },20000);
        document.body.appendChild(s);
    });
}

async function loadData() {
    setStatus('loading','üîÑ Chargement...');
    const [dataArticles, dataParams] = await Promise.all([
        apiCall({action:'getAllArticles',t:Date.now()}),
        apiCall({action:'getParams'})
    ]);
    if (dataArticles.error) { setStatus('err','‚ùå D√©connect√©'); return; }
    articles = parseArticles(Array.isArray(dataArticles)?dataArticles:[]);
    // Pr√™ts actifs = articles dont statut = 'Pr√™t' (cr√©√©s par actPreter)
    // OU articles dont type = 'Article de pr√™t' avec des sous-pr√™ts
    // Mod√®le : un "Article de pr√™t" parent a quantiteStock = disponible
    // Les pr√™ts individuels sont des articles type='Pr√™t individuel'
    pretsActifs = articles.filter(a=>a.type==='Pr√™t individuel');
    // Appliquer params depuis l'API
    if (dataParams?.params) try{params={...params,...JSON.parse(dataParams.params)};}catch(e){}
    if (dataParams?.seuils) try{seuilsPerso={...seuilsPerso,...JSON.parse(dataParams.seuils)};}catch(e){}
    applyParamsToForm();
    setStatus('ok',`‚úÖ ${articles.length} articles`);
    refreshBadges();
    refreshCurrentPane();
}

function parseArticles(data) {
    return data.map(r=>({
        id:r.ID||'', magasin:r.Magasin||'', type:r.Type||'',
        client:r.Client||'', numeroAR:r.NumeroAR||'',
        article:r.Article||'', reference:r.Reference||'',
        nombreColis:parseInt(r.NombreColis)||1,
        quantiteStock:(r.QuantiteStock!==''&&r.QuantiteStock!=null)?parseInt(r.QuantiteStock):null,
        quantiteInitiale:(r.QuantiteInitiale!==''&&r.QuantiteInitiale!=null)?parseInt(r.QuantiteInitiale):null,
        emplacement:r.Emplacement||'', kitchener:r.Kitchener||'',
        notes:r.Notes||'', statut:r.Statut||'Stock',
        dateReception:r.DateReception||'', datePret:r.DatePret||'',
        prenomEmprunteur:r.PrenomEmprunteur||'', parentId:r.ParentId||'',
        dateRetourPrevue:r.DateRetourPrevue||'', dateRetourReel:r.DateRetourReel||'',
        dateSortie:r.DateSortie||'', raisonSortie:r.RaisonSortie||'',
        // V6.1 nouveaux champs avec valeurs par d√©faut
        madSubtype:r.MADSubtype||'Commande',
        prixVente:r.PrixVente?parseFloat(r.PrixVente):null,
        statutMAD:r.StatutMAD||''
    }));
}

function setStatus(cls,msg){ const e=document.getElementById('statusPill'); e.className='pill '+cls; e.textContent=msg; }

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name,el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById(name).classList.add('active');
    refreshCurrentPane();
}

function refreshCurrentPane() {
    const id = document.querySelector('.pane.active')?.id;
    if (id==='mad') renderMAD();
    else if (id==='stock') renderStock();
    else if (id==='tle') renderTLE();
    else if (id==='prets') renderPrets();
    else if (id==='alertes') renderAlertes();
    else if (id==='parametres') renderSeuilsListe();
}

function refreshBadges() {
    const retards = pretsActifs.filter(p=>p.dateRetourPrevue&&new Date(p.dateRetourPrevue)<new Date()).length;
    const rb=document.getElementById('retardBadge'); rb.textContent=retards; rb.style.display=retards>0?'inline':'none';
    
    // Badge MAD : compter les SAV (madSubtype = "SAV")
    const madSAV=articles.filter(a=>a.type==='Mise √† disposition'&&a.madSubtype==='SAV').length;
    const mb=document.getElementById('madBadge'); mb.textContent=madSAV; mb.style.display=madSAV>0?'inline':'none';
    
    // Badge TLE : articles vendus en attente
    const tleEnAttente=articles.filter(a=>a.statut==='Vendu - Attente TLE').length;
    const tb=document.getElementById('tleBadge'); tb.textContent=tleEnAttente; tb.style.display=tleEnAttente>0?'inline':'none';
    
    const stockAlerts=articles.filter(a=>{
        if(a.type!=='Stock'||a.quantiteStock===null) return false;
        const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        return a.quantiteStock<=s;
    }).length;
    const ab=document.getElementById('alertBadge'); ab.textContent=retards+stockAlerts; ab.style.display=(retards+stockAlerts)>0?'inline':'none';
}

// ‚îÄ‚îÄ‚îÄ FORMULAIRE R√âCEPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onMagasinChange() {
    const mag=document.getElementById('f_magasin').value;
    const txt=document.getElementById('f_emplacement_text');
    const sel=document.getElementById('f_emplacement_select');
    if(mag==='Lattes'){txt.style.display='none';txt.required=false;sel.style.display='block';sel.required=true;}
    else{txt.style.display='block';txt.required=true;sel.style.display='none';sel.required=false;}
}

function getEmplacement(){
    return document.getElementById('f_magasin').value==='Lattes'
        ?document.getElementById('f_emplacement_select').value
        :document.getElementById('f_emplacement_text').value;
}

function toggleFormFields() {
    const t=document.getElementById('f_type').value;
    const isStock=t==='Stock', isPret=t==='Article de pr√™t', isMAD=t==='Mise √† disposition';
    
    // Client + AR + Sous-type MAD : seulement pour MAD
    document.getElementById('clientGroup').style.display=isMAD?'flex':'none';
    document.getElementById('f_client').required=isMAD;
    document.getElementById('arGroup').style.display=isMAD?'flex':'none';
    document.getElementById('madSubtypeGroup').style.display=isMAD?'flex':'none';
    
    // Colis : seulement pour MAD
    document.getElementById('colisGroup').style.display=isMAD?'flex':'none';
    document.getElementById('f_colis').required=isMAD;
    
    // Quantit√© : pour Stock et Article de pr√™t
    document.getElementById('qtyGroup').style.display=(isStock||isPret)?'flex':'none';
    document.getElementById('f_qty').required=isStock||isPret;
    document.getElementById('qtyLabel').textContent=isPret?'Quantit√© disponible √† pr√™ter *':'Quantit√© en Stock *';
    document.getElementById('qtyHint').textContent=isPret?'Nombre d\'articles disponibles (ex: 6 mitigeurs)':'';
    
    // Prix : seulement pour Stock
    document.getElementById('priceGroup').style.display=isStock?'flex':'none';
    
    // Seuil : seulement pour Stock
    document.getElementById('seuilGroup').style.display=isStock?'flex':'none';
    
    if(isMAD) document.getElementById('f_colis').value='1';
}

function resetForm() {
    document.getElementById('receptionForm').reset();
    document.getElementById('receptionForm').style.display='block';
    document.getElementById('qrResult').style.display='none';
    ['qtyGroup','seuilGroup','priceGroup','madSubtypeGroup'].forEach(id=>document.getElementById(id).style.display='none');
    ['clientGroup','arGroup','colisGroup'].forEach(id=>document.getElementById(id).style.display='flex');
    document.getElementById('f_client').required=true;
    document.getElementById('f_colis').required=true;
    document.getElementById('f_emplacement_text').style.display='block';
    document.getElementById('f_emplacement_select').style.display='none';
}

document.getElementById('receptionForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const btn=document.getElementById('submitBtn');
    btn.disabled=true; btn.textContent='‚è≥ Enregistrement...';
    const type=document.getElementById('f_type').value;
    const isStock=type==='Stock', isPret=type==='Article de pr√™t', isMAD=type==='Mise √† disposition';
    const id='ART-'+Date.now();
    const now=new Date().toISOString();
    const emplacement=getEmplacement();
    const article=document.getElementById('f_article').value;
    const reference=document.getElementById('f_ref').value;
    const qty=isStock||isPret?parseInt(document.getElementById('f_qty').value)||1:null;
    
    // V6.1 nouveaux champs
    const madSubtype=isMAD?document.getElementById('f_mad_subtype').value:'';
    const prixVente=isStock?(document.getElementById('f_price').value||''):'';
    const statutMAD=isMAD?'√Ä pr√©venir':'';

    const r=await apiCall({
        action:'addArticle', ID:id,
        Magasin:document.getElementById('f_magasin').value,
        Type:type,
        Client:isMAD?document.getElementById('f_client').value:'',
        NumeroAR:isMAD?document.getElementById('f_ar').value:'',
        Article:article, Reference:reference,
        NombreColis:isMAD?document.getElementById('f_colis').value:'1',
        QuantiteStock:qty!==null?qty:'',
        QuantiteInitiale:qty!==null?qty:'',
        Emplacement:emplacement,
        Kitchener:document.getElementById('f_prenom').value,
        Notes:document.getElementById('f_notes').value||'',
        Statut:'Stock', DateReception:now, Historique:'true',
        // V6.1 nouveaux champs
        MADSubtype:madSubtype,
        PrixVente:prixVente,
        StatutMAD:statutMAD
    });

    btn.disabled=false; btn.textContent='‚úÖ G√©n√©rer le QR Code';
    if(r.error){ alert('‚ùå Erreur : '+r.error); return; }

    if(isStock){
        const seuilVal=parseInt(document.getElementById('f_seuil').value)||params.stockFaible;
        seuilsPerso[id]=seuilVal;
        saveParamsToAPI();
    }

    lastQRData={id,article,reference,client:isMAD?document.getElementById('f_client').value:'',magasin:document.getElementById('f_magasin').value,type,colis:isMAD?document.getElementById('f_colis').value:1};

    const url=`${APP_URL}?article=${id}`;
    document.getElementById('qrcode').innerHTML='';
    new QRCode(document.getElementById('qrcode'),{text:url,width:190,height:190});
    document.getElementById('qrInfos').innerHTML=`
        <strong>${article}</strong><br>
        ${isMAD?`Client : <strong>${lastQRData.client}</strong><br>`:''}
        ${isPret?`<span style="color:var(--purple);font-weight:600;">üîÑ ${qty} disponible(s) √† pr√™ter</span><br>`:''}
        R√©f : ${reference} &nbsp;¬∑&nbsp; ${lastQRData.magasin}
    `;
    document.getElementById('receptionForm').style.display='none';
    document.getElementById('qrResult').style.display='block';
    setTimeout(()=>loadData(),1500);
});

// ‚îÄ‚îÄ‚îÄ IMPRESSION QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLabel(data) {
    const url=`${APP_URL}?article=${data.id}`;
    return`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>√âtiquette</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
    <style>
        @page{size:10cm 14cm;margin:0;}
        body{font-family:'Segoe UI',Arial,sans-serif;background:white;margin:0;padding:18px;width:10cm;box-sizing:border-box;}
        .top{border-bottom:2px solid #1e40af;padding-bottom:8px;margin-bottom:10px;}
        .brand{font-size:10px;font-weight:700;color:#1e40af;letter-spacing:1px;text-transform:uppercase;}
        .type{display:inline-block;background:#1e40af;color:white;font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;margin-top:3px;}
        .name{font-size:16px;font-weight:800;color:#111827;margin:10px 0 4px;line-height:1.2;}
        .info{font-size:11px;color:#374151;margin:3px 0;}
        .info strong{color:#111827;}
        #qr{text-align:center;margin:12px 0;}
        .id{font-size:8px;color:#9ca3af;font-family:monospace;text-align:center;}
        .footer{border-top:1px solid #e5e7eb;padding-top:7px;margin-top:8px;font-size:9px;color:#6b7280;text-align:center;}
    </style></head><body>
    <div class="top"><div class="brand">HMC ‚Äî Gestion de Stock</div><span class="type">${data.type}</span></div>
    <div class="name">${data.article}</div>
    ${data.client?`<div class="info">üë§ Client : <strong>${data.client}</strong></div>`:''}
    ${data.type==='Mise √† disposition'&&parseInt(data.colis)>1?`<div class="info">üì¶ Colis : <strong>${data.colis}</strong></div>`:''}
    <div class="info">üè∑Ô∏è R√©f : <strong>${data.reference}</strong></div>
    <div class="info">üè™ Magasin : <strong>${data.magasin}</strong></div>
    <div id="qr"></div>
    <div class="id">${data.id}</div>
    <div class="footer">Scannez avec l'appareil photo ¬∑ ¬© 2026 Florent Amendola</div>
    <script>new QRCode(document.getElementById('qr'),{text:'${url}',width:170,height:170});setTimeout(()=>window.print(),700);<\/script>
    </body></html>`;
}

function printQR() { if(!lastQRData)return; const w=window.open('','_blank','width=380,height=520'); w.document.write(buildLabel(lastQRData)); w.document.close(); }

function printArticleQR(id) {
    const a=articles.find(x=>x.id===id); if(!a)return;
    const data={id,article:a.article,reference:a.reference,client:a.client&&a.client!=='Stock interne'?a.client:'',magasin:a.magasin,type:a.type,colis:a.nombreColis};
    const w=window.open('','_blank','width=380,height=520'); w.document.write(buildLabel(data)); w.document.close();
}

// ‚îÄ‚îÄ‚îÄ MISES √Ä DISPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMAD() {
    const mag=document.getElementById('m_mag').value, stat=document.getElementById('m_stat').value;
    const q=document.getElementById('m_search').value.toLowerCase();
    const allF=articles.filter(a=>a.type==='Mise √† disposition'&&(!mag||a.magasin===mag));
    
    // V6.1 : Compter les SAV (madSubtype = "SAV")
    const savCount=allF.filter(a=>a.madSubtype==='SAV').length;
    
    document.getElementById('madStats').innerHTML=`
        <div class="stat-card blue"><div class="num">${allF.length}</div><div class="lbl">Total${mag?' '+mag:''}</div></div>
        <div class="stat-card green"><div class="num">${allF.filter(a=>a.statut==='Stock').length}</div><div class="lbl">En stock</div></div>
        <div class="stat-card orange"><div class="num">${allF.filter(a=>a.statut==='Sorti').length}</div><div class="lbl">Sortis</div></div>
        <div class="stat-card purple"><div class="num">${savCount}</div><div class="lbl">SAV</div></div>`;
    let list=allF.slice();
    if(stat) list=list.filter(a=>a.statut===stat);
    if(q) list=list.filter(a=>['article','client','reference','numeroAR','emplacement','kitchener'].some(k=>(a[k]||'').toLowerCase().includes(q)));
    if(!list.length){document.getElementById('madList').innerHTML='<div class="empty"><div class="ico">üì≠</div><p>Aucun article</p></div>';return;}
    const bMap={Stock:'b-stock',Pr√™t:'b-pret',Sorti:'b-sorti',SAV:'b-sav'};
    document.getElementById('madList').innerHTML=list.map(a=>{
        // V6.1 : Badges pour SAV et statutMAD
        const isSAV=a.madSubtype==='SAV';
        const badges=[];
        badges.push(`<span class="badge ${bMap[a.statut]||'b-stock'}">${a.statut}</span>`);
        if(isSAV)badges.push(`<span class="badge b-purple">üîß SAV</span>`);
        if(a.statutMAD==='√Ä pr√©venir')badges.push(`<span class="badge" style="background:var(--orange-soft);color:var(--orange);border:1px solid var(--orange-border)">üìû √Ä pr√©venir</span>`);
        if(a.statutMAD==='Client pr√©venu')badges.push(`<span class="badge b-dispo">‚úÖ Pr√©venu</span>`);
        
        return`<div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div>
                    <div class="item-title">${a.article}</div>
                    ${a.client&&a.client!=='Stock interne'?`<div class="item-client">üë§ ${a.client}</div>`:''}
                    <div class="item-ref">${a.reference}</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                    ${badges.join('')}
                </div>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                ${a.numeroAR?`<span class="meta">AR: <strong>${a.numeroAR}</strong></span>`:''}
                ${a.nombreColis>1?`<span class="meta">üì¶ <strong>${a.nombreColis} colis</strong></span>`:''}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ STOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStock() {
    const mag=document.getElementById('s_mag').value;
    const q=document.getElementById('s_search').value.toLowerCase();
    // IMPORTANT V6.1 : Exclure les articles vendus en attente TLE
    const allF=articles.filter(a=>
        a.type==='Stock' &&
        a.statut!=='Vendu - Attente TLE' &&
        a.statut!=='Sorti - Remis TLE' &&
        (!mag||a.magasin===mag)
    );
    const totalQty=allF.reduce((s,a)=>s+(a.quantiteStock||0),0);
    document.getElementById('stockStats').innerHTML=`
        <div class="stat-card green"><div class="num">${allF.filter(a=>a.statut==='Stock').length}</div><div class="lbl">R√©f√©rences${mag?' '+mag:''}</div></div>
        <div class="stat-card blue"><div class="num">${totalQty}</div><div class="lbl">Quantit√© totale</div></div>
        <div class="stat-card orange"><div class="num">${allF.filter(a=>{const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;return a.quantiteStock!==null&&a.quantiteStock>0&&a.quantiteStock<=s;}).length}</div><div class="lbl">Stocks faibles</div></div>
        <div class="stat-card red"><div class="num">${allF.filter(a=>a.quantiteStock===0).length}</div><div class="lbl">√âpuis√©s</div></div>`;
    let list=allF.slice();
    if(q) list=list.filter(a=>['article','reference','emplacement','notes'].some(k=>(a[k]||'').toLowerCase().includes(q)));
    if(!list.length){document.getElementById('stockList').innerHTML='<div class="empty"><div class="ico">üì¶</div><p>Aucun article</p></div>';return;}
    document.getElementById('stockList').innerHTML=list.map(a=>{
        const qty=a.quantiteStock, seuil=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;
        const qCls=qty===null?'':(qty===0?'empty':qty<=seuil?'low':'ok');
        return`<div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
                    <span class="badge ${a.statut==='Sorti'?'b-sorti':'b-stock'}">${a.statut==='Sorti'?'√âpuis√©':'En stock'}</span>
                    ${qty!==null?`<span class="qty-big ${qCls}">${qty}<span style="font-size:12px;font-weight:500;color:var(--text3)"> / ${a.quantiteInitiale}</span></span>`:''}
                </div>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ TLE - ARTICLES VENDUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTLE() {
    const mag=document.getElementById('t_mag').value;
    const q=document.getElementById('t_search').value.toLowerCase();
    
    const allVendus=articles.filter(a=>a.statut==='Vendu - Attente TLE');
    const filtered=allVendus.filter(a=>(!mag||a.magasin===mag)&&(!q||a.article.toLowerCase().includes(q)||a.reference.toLowerCase().includes(q)));
    
    const totalQty=filtered.reduce((s,a)=>s+(a.quantiteStock||0),0);
    const totalValeur=filtered.reduce((s,a)=>{
        const prix=a.prixVente||0;
        const qty=a.quantiteStock||0;
        return s+(prix*qty);
    },0);
    
    document.getElementById('tleStats').innerHTML=`
        <div class="stat-card orange"><div class="num">${filtered.length}</div><div class="lbl">Articles en attente${mag?' '+mag:''}</div></div>
        <div class="stat-card blue"><div class="num">${totalQty}</div><div class="lbl">Unit√©s totales</div></div>
        <div class="stat-card green"><div class="num">${totalValeur.toFixed(2)}‚Ç¨</div><div class="lbl">Valeur totale</div></div>`;
    
    if(!filtered.length){
        document.getElementById('tleList').innerHTML='<div class="empty"><div class="ico">‚úÖ</div><p>Aucun article en attente TLE</p></div>';
        return;
    }
    
    document.getElementById('tleList').innerHTML=filtered.map(a=>{
        const qty=a.quantiteStock||0;
        const prix=a.prixVente;
        const prixTotal=prix?(prix*qty).toFixed(2):'?';
        return`<div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div>
                    <div class="item-title">${a.article}</div>
                    <div class="item-ref">${a.reference}</div>
                </div>
                <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
                    <span class="badge b-pret">üöö Attente TLE</span>
                    <span style="font-size:14px;font-weight:700;color:var(--orange);">${qty} unit√©(s)</span>
                    ${prix?`<span style="font-size:13px;color:var(--text3);">${prix}‚Ç¨ √ó ${qty} = <strong style="color:var(--green)">${prixTotal}‚Ç¨</strong></span>`:''}
                </div>
            </div>
            <div class="item-meta">
                <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                <span class="meta">üìÖ Vendu le <strong>${a.dateReception?new Date(a.dateReception).toLocaleDateString('fr-FR'):'?'}</strong></span>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ PR√äTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Mod√®le de donn√©es :
// - articles type='Article de pr√™t' : catalogue (quantiteStock = dispo, quantiteInitiale = total)
// - articles type='Pr√™t individuel' : chaque pr√™t en cours, avec parentId = l'article parent
//   statut: 'En cours' ou 'Retourn√©'

function setPretTab(tab){
    currentPretTab=tab;
    document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('stab_'+tab).classList.add('active');
    renderPrets();
}

function renderPrets() {
    const mag=document.getElementById('p_mag').value;
    const q=(document.getElementById('p_search')?.value||'').toLowerCase();
    const now=new Date();

    // Articles de pr√™t (catalogue)
    const catalogue=articles.filter(a=>a.type==='Article de pr√™t'&&(!mag||a.magasin===mag));
    // Pr√™ts individuels actifs (statut = 'En cours')
    const encours=pretsActifs.filter(p=>p.statut==='En cours'&&(!mag||p.magasin===mag));
    const retards=encours.filter(p=>p.dateRetourPrevue&&new Date(p.dateRetourPrevue)<now);
    const bientot=encours.filter(p=>{if(!p.dateRetourPrevue)return false;const d=(new Date(p.dateRetourPrevue)-now)/86400000;return d>=0&&d<=params.alerteBientot;});
    const dispoArticles=catalogue.filter(a=>a.quantiteStock>0);

    document.getElementById('pretsStats').innerHTML=`
        <div class="stat-card purple"><div class="num">${dispoArticles.length}</div><div class="lbl">Articles disponibles${mag?' '+mag:''}</div></div>
        <div class="stat-card blue"><div class="num">${encours.length}</div><div class="lbl">Pr√™ts en cours</div></div>
        <div class="stat-card orange"><div class="num">${bientot.length}</div><div class="lbl">Retour bient√¥t</div></div>
        <div class="stat-card red"><div class="num">${retards.length}</div><div class="lbl">En retard</div></div>`;

    document.getElementById('stab_dispo').textContent=`üü£ Disponibles (${dispoArticles.length})`;
    document.getElementById('stab_dispo').classList.toggle('active',currentPretTab==='dispo');
    document.getElementById('stab_encours').textContent=`üîµ En cours (${encours.length})`;
    document.getElementById('stab_encours').classList.toggle('active',currentPretTab==='encours');
    document.getElementById('stab_bientot').textContent=`üü° Bient√¥t (${bientot.length})`;
    document.getElementById('stab_bientot').classList.toggle('active',currentPretTab==='bientot');
    document.getElementById('stab_retard').textContent=`üî¥ Retard (${retards.length})`;
    document.getElementById('stab_retard').classList.toggle('active',currentPretTab==='retard');

    let list=[];
    if(currentPretTab==='dispo') list=dispoArticles;
    else if(currentPretTab==='encours') list=encours;
    else if(currentPretTab==='bientot') list=bientot;
    else if(currentPretTab==='retard') list=retards;

    if(q) list=list.filter(a=>['article','client','prenomEmprunteur','reference'].some(k=>(a[k]||'').toLowerCase().includes(q)));
    if(!list.length){document.getElementById('pretsList').innerHTML=`<div class="empty"><div class="ico">${currentPretTab==='retard'?'‚úÖ':'üìã'}</div><p>${currentPretTab==='retard'?'Aucun retard !':'Aucun √©l√©ment'}</p></div>`;return;}

    if(currentPretTab==='dispo'){
        // Afficher les articles de pr√™t avec compteur dispo/total
        document.getElementById('pretsList').innerHTML=list.map(a=>{
            const pretsCet=pretsActifs.filter(p=>p.parentId===a.id&&p.statut==='En cours');
            return`<div class="article-item" onclick="openModal('${a.id}')">
                <div class="item-head">
                    <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                    <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
                        <span class="badge b-dispo">Disponible</span>
                        <span style="font-size:13px;font-weight:800;color:var(--green);">${a.quantiteStock} <span style="font-size:11px;font-weight:500;color:var(--text3)">dispo / ${a.quantiteInitiale}</span></span>
                    </div>
                </div>
                <div class="item-meta">
                    <span class="meta">üè™ <strong>${a.magasin}</strong></span>
                    <span class="meta">üìç <strong>${a.emplacement}</strong></span>
                    ${pretsCet.length>0?`<span class="meta">üîÑ <strong>${pretsCet.length} en pr√™t</strong></span>`:''}
                </div>
            </div>`;
        }).join('');
    } else {
        // Afficher les pr√™ts individuels
        document.getElementById('pretsList').innerHTML=list.map(p=>{
            const retard=p.dateRetourPrevue&&new Date(p.dateRetourPrevue)<now;
            const diff=p.dateRetourPrevue?Math.ceil((new Date(p.dateRetourPrevue)-now)/86400000):null;
            return`<div class="article-item" onclick="openModal('${p.id}')" style="${retard?'border-color:var(--red-border);':''}">
                <div class="item-head">
                    <div>
                        <div class="item-title">${p.article}</div>
                        <div class="item-client">üë§ ${p.prenomEmprunteur||'?'}</div>
                        <div class="item-ref">${p.reference}</div>
                    </div>
                    <span class="badge ${retard?'b-retard':'b-pret'}">${retard?`‚ö†Ô∏è +${Math.abs(diff)}j`:diff!==null?`‚Ü©Ô∏è J-${diff}`:'En pr√™t'}</span>
                </div>
                <div class="item-meta">
                    <span class="meta">üè™ <strong>${p.magasin}</strong></span>
                    <span class="meta">üìÖ Pr√™t√© le <strong>${p.datePret?new Date(p.datePret).toLocaleDateString('fr-FR'):'?'}</strong></span>
                    ${p.dateRetourPrevue?`<span class="meta">‚Ü©Ô∏è Retour <strong>${new Date(p.dateRetourPrevue).toLocaleDateString('fr-FR')}</strong></span>`:''}
                </div>
            </div>`;
        }).join('');
    }
}

// ‚îÄ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlertes() {
    const mag=document.getElementById('a_mag').value;
    const arts=mag?articles.filter(a=>a.magasin===mag):articles;
    const prets=mag?pretsActifs.filter(p=>p.magasin===mag):pretsActifs;
    let alertes=[];
    const now=new Date();

    prets.filter(p=>p.statut==='En cours'&&p.dateRetourPrevue&&new Date(p.dateRetourPrevue)<now)
        .forEach(p=>{const j=Math.floor((now-new Date(p.dateRetourPrevue))/86400000);alertes.push({type:'danger',t:`Pr√™t en retard ‚Äî ${p.article}`,m:`${p.magasin} ¬∑ ${p.prenomEmprunteur} ¬∑ ${j}j de retard`,id:p.id});});

    prets.filter(p=>{if(p.statut!=='En cours'||!p.dateRetourPrevue)return false;const d=(new Date(p.dateRetourPrevue)-now)/86400000;return d>=0&&d<=params.alerteBientot;})
        .forEach(p=>{const j=Math.ceil((new Date(p.dateRetourPrevue)-now)/86400000);alertes.push({type:'warning',t:`Retour bient√¥t ‚Äî ${p.article}`,m:`${p.magasin} ¬∑ ${p.prenomEmprunteur} ¬∑ dans ${j}j`,id:p.id});});

    arts.filter(a=>{if(a.type!=='Stock'||a.quantiteStock===null)return false;const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;return a.quantiteStock>0&&a.quantiteStock<=s;})
        .forEach(a=>{const s=seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible;alertes.push({type:'warning',t:`Stock faible ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ ${a.quantiteStock} unit√©(s) (seuil: ${s})`,id:a.id});});

    arts.filter(a=>a.type==='Stock'&&a.quantiteStock===0)
        .forEach(a=>alertes.push({type:'danger',t:`Stock √©puis√© ‚Äî ${a.article}`,m:`${a.magasin} ¬∑ √Ä r√©approvisionner`,id:a.id}));

    if(!alertes.length){document.getElementById('alertList').innerHTML='<div class="empty"><div class="ico">‚úÖ</div><p>Aucune alerte !</p></div>';return;}
    document.getElementById('alertList').innerHTML=alertes.map(al=>`
        <div class="alert-item ${al.type}" onclick="openModal('${al.id}')">
            <span style="font-size:18px;">${al.type==='danger'?'üî¥':'üü°'}</span>
            <div><div style="font-size:13px;font-weight:700;">${al.t}</div><div style="font-size:12px;color:var(--text3);margin-top:2px;">${al.m}</div></div>
        </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openModal(id) {
    const a=articles.find(x=>x.id===id)||pretsActifs.find(x=>x.id===id);
    if(!a){alert('Article non trouv√©');return;}
    document.getElementById('mTitle').textContent=a.article;
    document.getElementById('mSub').textContent=`${a.reference} ¬∑ ${a.magasin} ¬∑ ${a.type}`;
    document.getElementById('mBody').innerHTML='<div style="text-align:center;padding:28px;color:var(--text3)">‚è≥ Chargement...</div>';
    document.getElementById('overlay').classList.add('active');
    const histo=await loadHisto(id);
    renderModalContent(a,histo);
}

function renderModalContent(a, histo) {
    const isPretIndividuel=a.type==='Pr√™t individuel';
    const isArticlePret=a.type==='Article de pr√™t';
    const isStock=a.type==='Stock';
    const isMAD=a.type==='Mise √† disposition';

    const typeClass={'Mise √† disposition':'b-mad','Stock':'b-stock','Article de pr√™t':'b-purple','Pr√™t individuel':'b-pret'}[a.type]||'b-mad';
    const bClass={Stock:'b-stock',Pr√™t:'b-pret','En cours':'b-pret',Retourn√©:'b-sorti',Sorti:'b-sorti',SAV:'b-sav'}[a.statut]||'b-stock';

    let html=`
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:16px;">
        <span class="badge ${typeClass}">${a.type}</span>
        <span class="badge ${bClass}">${a.statut}</span>
    </div>`;

    // Compteur disponible pour Article de pr√™t
    if(isArticlePret){
        const pretsCet=pretsActifs.filter(p=>p.parentId===a.id&&p.statut==='En cours');
        const dispo=a.quantiteStock||0, total=a.quantiteInitiale||0;
        const cls=dispo===0?'empty':dispo<=2?'low':'ok';
        html+=`<div class="dispo-counter">
            <div><div class="dispo-num ${cls}">${dispo}</div></div>
            <div class="dispo-label"><strong>disponible(s) sur ${total}</strong>${pretsCet.length>0?`<br>${pretsCet.length} en cours de pr√™t`:''}</div>
        </div>`;
    }

    // Infos pr√™t individuel en cours
    if(isPretIndividuel){
        const retard=a.dateRetourPrevue&&new Date(a.dateRetourPrevue)<new Date();
        html+=`<div style="background:${retard?'var(--red-soft)':'var(--orange-soft)'};border:1.5px solid ${retard?'var(--red-border)':'var(--orange-border)'};border-radius:var(--r2);padding:13px;margin-bottom:14px;">
            <div style="font-weight:800;color:${retard?'var(--red)':'var(--orange)'}">üîÑ En pr√™t${retard?' ‚Äî ‚ö†Ô∏è EN RETARD':''}</div>
            <div style="font-size:13px;color:var(--text2);margin-top:5px;">
                Pr√™t√© √† <strong>${a.prenomEmprunteur}</strong> le <strong>${a.datePret?new Date(a.datePret).toLocaleDateString('fr-FR'):'?'}</strong><br>
                Retour pr√©vu le <strong>${a.dateRetourPrevue?new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR'):'?'}</strong>
            </div>
        </div>`;
    }

    // D√©tails
    html+=`<div class="detail-grid">
        <div class="detail-field"><div class="k">Magasin</div><div class="v">${a.magasin}</div></div>
        ${isMAD&&a.client?`<div class="detail-field"><div class="k">Client</div><div class="v" style="font-size:15px;font-weight:800;">${a.client}</div></div>`:''}
        <div class="detail-field"><div class="k">R√©f√©rence</div><div class="v">${a.reference}</div></div>
        <div class="detail-field"><div class="k">Emplacement</div><div class="v">${a.emplacement}</div></div>
        ${a.numeroAR?`<div class="detail-field"><div class="k">N¬∞ AR</div><div class="v">${a.numeroAR}</div></div>`:''}
        ${a.quantiteStock!==null&&!isPretIndividuel?`<div class="detail-field"><div class="k">Quantit√©</div><div class="v" style="font-size:17px;font-weight:800;color:${a.quantiteStock===0?'var(--red)':a.quantiteStock<=(seuilsPerso[a.id]!==undefined?seuilsPerso[a.id]:params.stockFaible)?'var(--orange)':'var(--green)'}">${a.quantiteStock} <span style="font-size:12px;font-weight:400;color:var(--text3)">/ ${a.quantiteInitiale}</span></div></div>`:''}
        ${a.nombreColis>1&&isMAD?`<div class="detail-field"><div class="k">Colis</div><div class="v">${a.nombreColis}</div></div>`:''}
        ${!isPretIndividuel?`<div class="detail-field"><div class="k">R√©ceptionn√© par</div><div class="v">${a.kitchener}</div></div>`:''}
        ${!isPretIndividuel?`<div class="detail-field"><div class="k">Date r√©ception</div><div class="v">${a.dateReception?new Date(a.dateReception).toLocaleDateString('fr-FR'):'?'}</div></div>`:''}
        ${a.notes?`<div class="detail-field full"><div class="k">Notes</div><div class="v">${a.notes}</div></div>`:''}
    </div>`;

    // Bouton QR
    if(!isPretIndividuel){
        html+=`<div style="background:var(--blue-soft);border:1.5px solid #c7d7fd;border-radius:var(--r2);padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <span style="font-size:12px;font-weight:600;color:var(--blue);">üî≥ √âtiquette QR</span>
            <button class="btn btn-primary" style="padding:7px 14px;font-size:12px;" onclick="printArticleQR('${a.id}')">üñ®Ô∏è Imprimer</button>
        </div>`;
    }

    // Actions
    html+=`<div class="prenom-bar"><label>üë§ Votre pr√©nom</label><input type="text" id="actPrenom" placeholder="Obligatoire pour toute action"></div>
    <div class="btn-row">`;

    if(isMAD&&a.statut==='Stock'){
        // V6.1 : Bouton "Pr√©venir client" si statutMAD = "√Ä pr√©venir"
        if(a.statutMAD==='√Ä pr√©venir'){
            html+=`<button class="btn btn-warning" onclick="actPrevenirClient('${a.id}')">üìû Pr√©venir client</button>`;
        }
        html+=`<button class="btn btn-success" onclick="actSortir('${a.id}')">üì§ Sortir</button>
               <button class="btn btn-outline" onclick="actEmplacement('${a.id}')">üìç Emplacement</button>`;
    }
    if(isStock&&a.statut==='Stock'){
        // V6.1 : Bouton "Vendre" si quantit√© > 0
        if(a.quantiteStock>0){
            html+=`<button class="btn btn-warning" onclick="actVendre('${a.id}')">üí∞ Vendre</button>`;
        }
        html+=`<button class="btn btn-primary" onclick="actSortirQte('${a.id}')">üì¶ Sortir quantit√©</button>
               <button class="btn btn-teal" onclick="actAjouterQte('${a.id}')">‚ûï Ajouter stock</button>
               <button class="btn btn-outline" onclick="actEmplacement('${a.id}')">üìç Emplacement</button>
               <button class="btn btn-outline" onclick="actSetSeuil('${a.id}')">‚öôÔ∏è Seuil alerte</button>`;
    }
    if(isArticlePret&&a.statut==='Stock'){
        const dispo=a.quantiteStock||0;
        if(dispo>0) html+=`<button class="btn btn-warning" onclick="actPreter('${a.id}')">üîÑ Pr√™ter</button>`;
        html+=`<button class="btn btn-teal" onclick="actAjouterQte('${a.id}')">‚ûï Ajouter au stock pr√™t</button>
               <button class="btn btn-outline" onclick="actEmplacement('${a.id}')">üìç Emplacement</button>`;
    }
    if(isPretIndividuel&&a.statut==='En cours'){
        html+=`<button class="btn btn-success" onclick="actRetourPret('${a.id}')">‚Ü©Ô∏è Retour de pr√™t</button>
               <button class="btn btn-warning" onclick="actModifierDateRetour('${a.id}')">üìÖ Modifier retour</button>`;
    }
    // V6.1 : Bouton "Remis √† TLE" pour articles vendus
    if(a.statut==='Vendu - Attente TLE'){
        html+=`<button class="btn btn-success" onclick="actRemisTLE('${a.id}')">‚úÖ Remis √† TLE</button>`;
    }
    html+=`</div>`;

    // Pr√™ts individuels en cours pour Article de pr√™t
    if(isArticlePret){
        const pretsCet=pretsActifs.filter(p=>p.parentId===a.id&&p.statut==='En cours');
        html+=`<div class="divider"></div><div class="section-lbl">üîÑ Pr√™ts en cours (${pretsCet.length})</div>`;
        if(!pretsCet.length) html+=`<div style="color:var(--text3);font-size:13px;text-align:center;padding:12px;">Aucun pr√™t en cours pour cet article</div>`;
        else html+=pretsCet.map(p=>{
            const retard=p.dateRetourPrevue&&new Date(p.dateRetourPrevue)<new Date();
            const diff=p.dateRetourPrevue?Math.ceil((new Date(p.dateRetourPrevue)-new Date())/86400000):null;
            return`<div class="loan-item ${retard?'retard':diff!==null&&diff<=params.alerteBientot?'bientot':''}">
                <div class="loan-head">
                    <span class="loan-client">üë§ ${p.prenomEmprunteur}</span>
                    <span class="badge ${retard?'b-retard':'b-pret'}">${retard?`+${Math.abs(diff)}j retard`:diff!==null?`J-${diff}`:'En pr√™t'}</span>
                </div>
                <div class="loan-meta">
                    <span>üìÖ Pr√™t√© le <strong>${p.datePret?new Date(p.datePret).toLocaleDateString('fr-FR'):'?'}</strong></span>
                    ${p.dateRetourPrevue?`<span>‚Ü©Ô∏è Retour pr√©vu le <strong>${new Date(p.dateRetourPrevue).toLocaleDateString('fr-FR')}</strong></span>`:''}
                </div>
                <div class="btn-row" style="margin-top:8px;">
                    <button class="btn btn-success" style="padding:7px 12px;font-size:12px;" onclick="actRetourPretDirect('${p.id}','${a.id}')">‚Ü©Ô∏è Retour</button>
                    <button class="btn btn-outline" style="padding:7px 12px;font-size:12px;" onclick="actModifierDateRetour('${p.id}')">üìÖ Modifier date</button>
                </div>
            </div>`;
        }).join('');
    }

    // Modifier
    html+=`<div class="divider"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div class="section-lbl">‚úèÔ∏è Modifier l'article</div>
        <button class="btn btn-outline" style="padding:6px 12px;font-size:12px;" onclick="toggleEdit('${a.id}')">Modifier</button>
    </div>
    <div id="editSection_${a.id}" style="display:none;">
        <div class="edit-form">
            <div class="form-grid">
                <div class="fg"><label>Article</label><input id="e_article" value="${a.article}"></div>
                <div class="fg"><label>R√©f√©rence</label><input id="e_reference" value="${a.reference}"></div>
                <div class="fg"><label>Emplacement</label><input id="e_emplacement" value="${a.emplacement}"></div>
                <div class="fg">
                    <label>Cat√©gorie</label>
                    <select id="e_type">
                        <option value="Mise √† disposition" ${a.type==='Mise √† disposition'?'selected':''}>üöö Mise √† disposition</option>
                        <option value="Stock" ${a.type==='Stock'?'selected':''}>üì¶ Stock</option>
                        <option value="Article de pr√™t" ${a.type==='Article de pr√™t'?'selected':''}>üîÑ Article de pr√™t</option>
                    </select>
                </div>
                ${isMAD?`<div class="fg"><label>Client</label><input id="e_client" value="${a.client||''}"></div>`:''}
                ${a.numeroAR?`<div class="fg"><label>N¬∞ AR</label><input id="e_ar" value="${a.numeroAR}"></div>`:''}
                ${a.quantiteStock!==null?`<div class="fg"><label>Quantit√©</label><input id="e_qty" type="number" value="${a.quantiteStock}"></div>`:''}
                ${isMAD&&a.nombreColis>0?`<div class="fg"><label>Nb Colis</label><input id="e_colis" type="number" value="${a.nombreColis}"></div>`:''}
                <div class="fg full"><label>Notes</label><textarea id="e_notes" rows="2">${a.notes||''}</textarea></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="actSaveEdit('${a.id}')">üíæ Enregistrer</button>
                <button class="btn btn-outline" onclick="toggleEdit('${a.id}')">Annuler</button>
            </div>
        </div>
    </div>`;

    // Historique
    html+=`<div class="divider"></div><div class="section-lbl">üìú Historique</div>`;
    if(!histo.length) html+=`<div style="text-align:center;padding:16px;color:var(--text3);font-size:13px;">Aucun historique</div>`;
    else html+=histo.map(h=>`<div class="histo">
        <div class="histo-date">${h.date?new Date(h.date).toLocaleString('fr-FR'):'?'}</div>
        <div class="histo-action">${h.action} ‚Äî ${h.utilisateur}</div>
        ${h.details?`<div class="histo-detail">${h.details}</div>`:''}
    </div>`).join('');

    document.getElementById('mBody').innerHTML=html;
}

function toggleEdit(id){const el=document.getElementById('editSection_'+id);el.style.display=el.style.display==='none'?'block':'none';}
function closeModal(){document.getElementById('overlay').classList.remove('active');}

// ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getPrenom(){const v=(document.getElementById('actPrenom')?.value||'').trim();if(!v){alert('‚ö†Ô∏è Entrez votre pr√©nom');return null;}return v;}

async function actSortir(id){
    const p=getPrenom();if(!p)return;
    const raison=prompt('Raison de la sortie :');if(!raison)return;
    const a=articles.find(x=>x.id===id);
    a.statut='Sorti';a.dateSortie=new Date().toISOString();a.raisonSortie=raison;
    await doUpdate(a);doHisto(id,'Sortie',p,`Raison: ${raison}`);
    closeModal();alert('‚úÖ Article sorti');loadData();
}

async function actSortirQte(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    const s=prompt(`Quantit√© √† sortir (disponible: ${a.quantiteStock}) :`);if(!s)return;
    const qte=parseInt(s);
    if(isNaN(qte)||qte<=0){alert('Quantit√© invalide');return;}
    if(qte>a.quantiteStock){alert(`Stock insuffisant ‚Äî disponible: ${a.quantiteStock}`);return;}
    a.quantiteStock-=qte;
    if(a.quantiteStock===0)a.statut='Sorti';
    await doUpdate(a);doHisto(id,'Sortie stock',p,`${qte} unit√©(s) ‚Äî Reste: ${a.quantiteStock}`);
    closeModal();alert(`‚úÖ ${qte} unit√©(s) sortie(s) ‚Äî Reste: ${a.quantiteStock}`);loadData();
}

async function actAjouterQte(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    const libelle=a.type==='Article de pr√™t'?'articles pr√™tables':'unit√©s en stock';
    const s=prompt(`Quantit√© √† ajouter (actuel: ${a.quantiteStock||0} ${libelle}) :`);if(!s)return;
    const qte=parseInt(s);
    if(isNaN(qte)||qte<=0){alert('Quantit√© invalide');return;}
    const oldQty=a.quantiteStock||0;
    a.quantiteStock=oldQty+qte;
    a.quantiteInitiale=Math.max(a.quantiteInitiale||0,a.quantiteStock);
    if(a.statut==='Sorti')a.statut='Stock';
    await doUpdate(a);
    doHisto(id,'Ajout stock',p,`+${qte} unit√©s ¬∑ Nouveau total: ${a.quantiteStock}`);
    closeModal();alert(`‚úÖ Mis √† jour : ${a.quantiteStock} ${libelle}`);loadData();
}

async function actPreter(id){
    // id = l'article de pr√™t parent
    const p=getPrenom();if(!p)return;
    const parent=articles.find(x=>x.id===id);
    if(!parent||parent.quantiteStock<=0){alert('Aucune unit√© disponible');return;}

    let qte=1;
    if(parent.quantiteStock>1){
        const s=prompt(`Combien d'unit√©s pr√™ter ? (disponible: ${parent.quantiteStock}) :`,'1');
        if(!s)return;
        qte=parseInt(s);
        if(isNaN(qte)||qte<=0){alert('Quantit√© invalide');return;}
        if(qte>parent.quantiteStock){alert(`Seulement ${parent.quantiteStock} disponible(s)`);return;}
    }

    const emp=prompt('Pr√©nom de l\'emprunteur :');if(!emp)return;
    const dateStr=prompt('Date de retour pr√©vue (JJ/MM/AAAA) :');if(!dateStr)return;
    const [j,m,y]=dateStr.split('/');
    if(!j||!m||!y){alert('Format invalide. Utilisez JJ/MM/AAAA');return;}

    // Cr√©er un article "Pr√™t individuel" pour chaque unit√© pr√™t√©e
    // (ou un seul avec quantit√©, selon besoin ‚Äî ici on fait un pr√™t = une ligne pour tra√ßabilit√©)
    for(let i=0;i<qte;i++){
        const pretId='PRET-'+Date.now()+'-'+i;
        const now=new Date().toISOString();
        await apiCall({
            action:'addArticle', ID:pretId,
            Magasin:parent.magasin, Type:'Pr√™t individuel',
            Client:'', NumeroAR:'',
            Article:parent.article, Reference:parent.reference,
            NombreColis:'1', QuantiteStock:'', QuantiteInitiale:'',
            Emplacement:parent.emplacement, Kitchener:p,
            Notes:'', Statut:'En cours',
            DateReception:now, DatePret:now,
            PrenomEmprunteur:emp,
            DateRetourPrevue:new Date(y,m-1,j).toISOString(),
            ParentId:id, Historique:'false'
        });
    }
    // D√©duire du stock parent
    parent.quantiteStock-=qte;
    await doUpdate(parent);
    doHisto(id,'Pr√™t',p,`${qte} unit√©(s) √† ${emp} ‚Äî Retour: ${dateStr} ‚Äî Reste dispo: ${parent.quantiteStock}`);
    closeModal();alert(`‚úÖ ${qte} unit√©(s) pr√™t√©e(s) √† ${emp}`);loadData();
}

async function actRetourPret(id){
    // id = le pr√™t individuel
    const p=getPrenom();if(!p)return;
    const pret=pretsActifs.find(x=>x.id===id);if(!pret)return;
    pret.statut='Retourn√©';pret.dateRetourReel=new Date().toISOString();
    await doUpdate(pret);
    // Remettre dans le stock du parent
    const parent=articles.find(x=>x.id===pret.parentId);
    if(parent){parent.quantiteStock=(parent.quantiteStock||0)+1;await doUpdate(parent);}
    doHisto(pret.parentId||id,'Retour pr√™t',p,`Retourn√© par ${pret.prenomEmprunteur}`);
    closeModal();alert('‚úÖ Retour enregistr√© ‚Äî article remis disponible');loadData();
}

async function actRetourPretDirect(pretId,parentId){
    // Retour depuis la liste dans la fiche article de pr√™t
    const p=(document.getElementById('actPrenom')?.value||'').trim();
    if(!p){alert('‚ö†Ô∏è Entrez votre pr√©nom');return;}
    const pret=pretsActifs.find(x=>x.id===pretId);if(!pret)return;
    pret.statut='Retourn√©';pret.dateRetourReel=new Date().toISOString();
    await doUpdate(pret);
    const parent=articles.find(x=>x.id===parentId);
    if(parent){parent.quantiteStock=(parent.quantiteStock||0)+1;await doUpdate(parent);}
    doHisto(parentId,'Retour pr√™t',p,`Retourn√© par ${pret.prenomEmprunteur}`);
    alert('‚úÖ Retour enregistr√©');loadData().then(()=>openModal(parentId));
}

async function actModifierDateRetour(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id)||pretsActifs.find(x=>x.id===id);
    const actuelle=a.dateRetourPrevue?new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR'):'?';
    const dateStr=prompt(`Nouvelle date de retour (actuelle: ${actuelle})\nFormat: JJ/MM/AAAA :`);
    if(!dateStr)return;
    const[j,m,y]=dateStr.split('/');
    if(!j||!m||!y){alert('Format invalide');return;}
    const ancien=actuelle;
    a.dateRetourPrevue=new Date(y,m-1,j).toISOString();
    await doUpdate(a);doHisto(id,'Modification date retour',p,`${ancien} ‚Üí ${dateStr}`);
    closeModal();alert('‚úÖ Date modifi√©e');loadData();
}

async function actEmplacement(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    const n=prompt(`Nouvel emplacement (actuel: ${a.emplacement}) :`);if(!n)return;
    const ancien=a.emplacement;a.emplacement=n;
    await doUpdate(a);doHisto(id,'Changement emplacement',p,`${ancien} ‚Üí ${n}`);
    closeModal();alert('‚úÖ Emplacement mis √† jour');loadData();
}

// V6.1 ‚îÄ‚îÄ‚îÄ NOUVELLE ACTION : VENDRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function actVendre(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    
    const qStr=prompt(`Quantit√© √† vendre (disponible: ${a.quantiteStock}) :`);
    if(!qStr)return;
    const qte=parseInt(qStr);
    if(isNaN(qte)||qte<=0||qte>a.quantiteStock){alert('Quantit√© invalide ou stock insuffisant');return;}
    
    const prixInfo=a.prixVente?` √† ${a.prixVente}‚Ç¨/unit√© (total: ${(qte*a.prixVente).toFixed(2)}‚Ç¨)`:'';
    const conf=confirm(`Vendre ${qte} unit√©(s)${prixInfo} ?\n\nL'article ira dans l'onglet TLE en attente de r√©cup√©ration.`);
    if(!conf)return;
    
    // Cr√©er article vendu
    const venteId='VENTE-'+Date.now();
    await apiCall({
        action:'addArticle', ID:venteId,
        Type:'Stock', Statut:'Vendu - Attente TLE',
        Article:a.article, Reference:a.reference,
        Magasin:a.magasin, Emplacement:a.emplacement,
        QuantiteStock:qte, QuantiteInitiale:qte,
        PrixVente:a.prixVente||'', ParentId:id,
        Kitchener:p, DateReception:new Date().toISOString(),
        Notes:`Vendu le ${new Date().toLocaleDateString('fr-FR')}`,
        Client:'', NumeroAR:'', NombreColis:'', DatePret:'',
        PrenomEmprunteur:'', DateRetourPrevue:'', DateRetourReel:'',
        DateSortie:'', RaisonSortie:'', MADSubtype:'', StatutMAD:''
    });
    
    // D√©duire du stock parent
    a.quantiteStock-=qte;
    if(a.quantiteStock===0)a.statut='Sorti';
    await doUpdate(a);
    
    const prixDetail=a.prixVente?` √† ${a.prixVente}‚Ç¨ = ${(qte*a.prixVente).toFixed(2)}‚Ç¨`:'';
    doHisto(id,'Vente',p,`${qte} unit√©(s) vendues${prixDetail} ‚Äî En attente TLE`);
    
    closeModal();alert(`‚úÖ ${qte} unit√©(s) vendues ‚Äî Article dans l'onglet TLE`);loadData();
}

// V6.1 ‚îÄ‚îÄ‚îÄ NOUVELLE ACTION : REMIS √Ä TLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function actRemisTLE(id){
    const p=getPrenom();if(!p)return;
    const conf=confirm('Confirmer la remise √† TLE ?\n\nL\'article sera marqu√© comme "Sorti - Remis TLE" et dispara√Ætra de l\'onglet TLE.');
    if(!conf)return;
    
    const a=articles.find(x=>x.id===id);
    a.statut='Sorti - Remis TLE';
    a.dateSortie=new Date().toISOString();
    a.raisonSortie='Remis √† TLE';
    
    await doUpdate(a);
    doHisto(id,'Remis √† TLE',p,`${a.quantiteStock} unit√©(s) r√©cup√©r√©es par TLE`);
    
    closeModal();alert('‚úÖ Article remis √† TLE');loadData();
}

// V6.1 ‚îÄ‚îÄ‚îÄ NOUVELLE ACTION : PR√âVENIR CLIENT ‚îÄ‚îÄ
async function actPrevenirClient(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    
    a.statutMAD='Client pr√©venu';
    await doUpdate(a);
    doHisto(id,'Client pr√©venu',p,'Client/Poseur contact√©');
    
    closeModal();alert('‚úÖ Client marqu√© comme pr√©venu');loadData();
}

function actSetSeuil(id){
    const a=articles.find(x=>x.id===id);
    const actuel=seuilsPerso[id]!==undefined?seuilsPerso[id]:params.stockFaible;
    const val=prompt(`Seuil d'alerte pour "${a.article}" (actuel: ${actuel}) :`);
    if(val===null)return;
    const n=parseInt(val);if(isNaN(n)||n<0){alert('Valeur invalide');return;}
    seuilsPerso[id]=n;saveParamsToAPI();
    alert(`‚úÖ Seuil d√©fini √† ${n} unit√©s`);refreshBadges();
}

async function actSaveEdit(id){
    const p=getPrenom();if(!p)return;
    const a=articles.find(x=>x.id===id);
    const changes=[];
    const get=(elId,fb)=>{const el=document.getElementById(elId);return el?el.value.trim():fb;};
    const newArt=get('e_article',a.article),newRef=get('e_reference',a.reference),newEmp=get('e_emplacement',a.emplacement);
    const newType=document.getElementById('e_type')?.value||a.type;
    const newClient=get('e_client',a.client),newAR=get('e_ar',a.numeroAR),newNotes=get('e_notes',a.notes);
    const newQtyEl=document.getElementById('e_qty'),newQty=newQtyEl?parseInt(newQtyEl.value):a.quantiteStock;
    const newColisEl=document.getElementById('e_colis'),newColis=newColisEl?parseInt(newColisEl.value):a.nombreColis;
    
    if(newArt!==a.article)changes.push(`Article: "${a.article}"‚Üí"${newArt}"`);
    if(newRef!==a.reference)changes.push(`R√©f: ${a.reference}‚Üí${newRef}`);
    if(newEmp!==a.emplacement)changes.push(`Empl: ${a.emplacement}‚Üí${newEmp}`);
    if(newType!==a.type)changes.push(`Cat√©gorie: ${a.type}‚Üí${newType}`);
    if(newQtyEl&&newQty!==a.quantiteStock)changes.push(`Qt√©: ${a.quantiteStock}‚Üí${newQty}`);
    
    // Gestion du changement de type
    const oldType=a.type;
    a.type=newType;
    
    // Si on passe vers "Article de pr√™t" et qu'il n'y avait pas de quantit√©
    if(newType==='Article de pr√™t' && oldType!=='Article de pr√™t' && oldType!=='Stock'){
        // Demander la quantit√© √† pr√™ter
        const qStr=prompt('Cet article devient un article de pr√™t.\nCombien d\'unit√©s disponibles √† pr√™ter ?','1');
        if(!qStr){alert('Changement annul√©');return;}
        const q=parseInt(qStr);
        if(isNaN(q)||q<=0){alert('Quantit√© invalide');return;}
        a.quantiteStock=q;
        a.quantiteInitiale=q;
        changes.push(`Quantit√© de pr√™t d√©finie: ${q}`);
    }
    
    // Si on passe de Stock vers Article de pr√™t : garder la quantit√©
    if(newType==='Article de pr√™t' && oldType==='Stock'){
        // La quantit√© existe d√©j√†, on la garde
        if(!a.quantiteStock) a.quantiteStock=1;
        if(!a.quantiteInitiale) a.quantiteInitiale=a.quantiteStock;
    }
    
    // Si on passe vers Stock et pas de quantit√©
    if(newType==='Stock' && oldType!=='Stock' && oldType!=='Article de pr√™t'){
        const qStr=prompt('Cet article devient un stock.\nQuantit√© en stock :','1');
        if(!qStr){alert('Changement annul√©');return;}
        const q=parseInt(qStr);
        if(isNaN(q)||q<0){alert('Quantit√© invalide');return;}
        a.quantiteStock=q;
        a.quantiteInitiale=q;
        changes.push(`Quantit√© stock d√©finie: ${q}`);
    }
    
    // Si on passe vers Mise √† disposition : retirer les quantit√©s
    if(newType==='Mise √† disposition'){
        a.quantiteStock=null;
        a.quantiteInitiale=null;
    }
    
    a.article=newArt;a.reference=newRef;a.emplacement=newEmp;
    a.client=newClient||a.client;a.numeroAR=newAR||a.numeroAR;a.notes=newNotes;
    if(newQtyEl && (newType==='Stock' || newType==='Article de pr√™t')) a.quantiteStock=newQty;
    if(newColisEl && newType==='Mise √† disposition') a.nombreColis=newColis;
    
    await doUpdate(a);
    if(changes.length)doHisto(id,'Modification',p,changes.join(' ¬∑ '));
    closeModal();alert('‚úÖ Article modifi√©');loadData();
}

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doUpdate(a){
    return apiCall({
        action:'updateArticle', ID:a.id, Magasin:a.magasin, Type:a.type,
        Client:a.client||'', NumeroAR:a.numeroAR||'', Article:a.article,
        Reference:a.reference, NombreColis:a.nombreColis||1,
        QuantiteStock:a.quantiteStock!==null?a.quantiteStock:'',
        QuantiteInitiale:a.quantiteInitiale!==null?a.quantiteInitiale:'',
        Emplacement:a.emplacement, Kitchener:a.kitchener||'', Notes:a.notes||'',
        Statut:a.statut, DateReception:a.dateReception||'',
        DatePret:a.datePret||'', PrenomEmprunteur:a.prenomEmprunteur||'',
        DateRetourPrevue:a.dateRetourPrevue||'', DateRetourReel:a.dateRetourReel||'',
        DateSortie:a.dateSortie||'', RaisonSortie:a.raisonSortie||'',
        ParentId:a.parentId||'',
        // V6.1 nouveaux champs
        MADSubtype:a.madSubtype||'',
        PrixVente:a.prixVente||'',
        StatutMAD:a.statutMAD||''
    });
}

function doHisto(id,action,user,details=''){
    delete histoCache[id];
    apiCall({action:'addHistorique',ArticleID:id,Action:action,Date:new Date().toISOString(),Utilisateur:user,Details:details});
}

async function loadHisto(id){
    if(histoCache[id])return histoCache[id];
    const data=await apiCall({action:'getHistorique',articleId:id});
    histoCache[id]=Array.isArray(data)?data:[];
    return histoCache[id];
}

// ‚îÄ‚îÄ‚îÄ NETTOYAGE / ARCHIVAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function actArchiveOld() {
    const jours = params.archiveJours || 90;
    const conf = confirm(`‚ö†Ô∏è Vous allez supprimer tous les articles avec statut "Sorti" ou pr√™ts "Retourn√©" de plus de ${jours} jours.\n\nCette action est irr√©versible. Continuer ?`);
    if(!conf) return;
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - jours);
    
    // Trouver les articles √† archiver
    const toArchive = articles.filter(a => {
        // Articles sortis
        if(a.statut === 'Sorti' && a.dateSortie) {
            return new Date(a.dateSortie) < cutoffDate;
        }
        // Pr√™ts retourn√©s
        if(a.type === 'Pr√™t individuel' && a.statut === 'Retourn√©' && a.dateRetourReel) {
            return new Date(a.dateRetourReel) < cutoffDate;
        }
        return false;
    });
    
    if(toArchive.length === 0) {
        alert('‚úÖ Aucun article √† nettoyer ‚Äî base de donn√©es d√©j√† propre !');
        return;
    }
    
    const conf2 = confirm(`${toArchive.length} article(s) seront supprim√©s.\n\nConfirmer la suppression ?`);
    if(!conf2) return;
    
    // Appeler l'API pour archiver
    const result = await apiCall({
        action: 'archiveArticles',
        ids: JSON.stringify(toArchive.map(a => a.id))
    });
    
    if(result.error) {
        alert('‚ùå Erreur : ' + result.error);
    } else {
        alert(`‚úÖ ${result.deleted || toArchive.length} article(s) supprim√©(s) avec succ√®s !`);
        loadData();
    }
}

// Auto-refresh toutes les 90s
setInterval(()=>loadData(),90000);
</script>
</body>
</html>
