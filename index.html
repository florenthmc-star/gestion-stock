<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMC â€” Gestion de Stock</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #f5f7fa;
            --bg2: #eef1f6;
            --white: #ffffff;
            --border: #e2e7ef;
            --border2: #d0d7e3;
            --blue: #3b6ef8;
            --blue-dark: #2952d9;
            --blue-soft: #eff3fe;
            --green: #16a34a;
            --green-soft: #f0fdf4;
            --green-border: #bbf7d0;
            --orange: #d97706;
            --orange-soft: #fffbeb;
            --orange-border: #fde68a;
            --red: #dc2626;
            --red-soft: #fef2f2;
            --red-border: #fecaca;
            --purple: #7c3aed;
            --purple-soft: #f5f3ff;
            --text: #111827;
            --text2: #374151;
            --text3: #6b7280;
            --text4: #9ca3af;
            --r: 12px;
            --r2: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,.10), 0 2px 4px rgba(0,0,0,.06);
            --shadow-lg: 0 10px 30px rgba(0,0,0,.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-icon {
            width: 36px; height: 36px;
            background: var(--blue); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: white;
        }
        .brand-name { font-size: 17px; font-weight: 800; color: var(--text); }
        .brand-sub { font-size: 12px; color: var(--text3); margin-top: 1px; }

        .header-right { display: flex; align-items: center; gap: 10px; }

        .pill {
            padding: 5px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .pill.ok { background: var(--green-soft); color: var(--green); border: 1px solid var(--green-border); }
        .pill.loading { background: var(--orange-soft); color: var(--orange); border: 1px solid var(--orange-border); }
        .pill.err { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }

        .btn-sm {
            padding: 7px 14px; border-radius: var(--r2);
            font-size: 13px; font-weight: 600;
            border: 1px solid var(--border2); background: var(--white);
            color: var(--text2); cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all .15s;
        }
        .btn-sm:hover { background: var(--bg); border-color: var(--blue); color: var(--blue); }

        /* â”€â”€ TABS â”€â”€ */
        .tabs {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 0 28px;
            display: flex; gap: 2px;
            overflow-x: auto;
        }

        .tab {
            padding: 0 18px; height: 48px;
            font-size: 14px; font-weight: 600; color: var(--text3);
            border: none; background: none; cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all .2s; white-space: nowrap;
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex; align-items: center; gap: 7px;
        }
        .tab:hover { color: var(--text2); background: var(--bg); }
        .tab.active { color: var(--blue); border-bottom-color: var(--blue); }

        .tab-badge {
            background: var(--red); color: white;
            padding: 1px 6px; border-radius: 10px;
            font-size: 10px; font-weight: 700;
        }

        /* â”€â”€ LAYOUT â”€â”€ */
        .page { max-width: 1100px; margin: 0 auto; padding: 28px 24px; }
        .pane { display: none; }
        .pane.active { display: block; }

        .page-title {
            font-size: 22px; font-weight: 800; color: var(--text);
            margin-bottom: 24px; display: flex; align-items: center; gap: 10px;
        }

        /* â”€â”€ STATS â”€â”€ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px; margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--r); padding: 20px 18px;
            box-shadow: var(--shadow);
        }
        .stat-card .num {
            font-size: 2em; font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1; margin-bottom: 6px;
        }
        .stat-card .lbl { font-size: 12px; font-weight: 600; color: var(--text3); }
        .stat-card.blue .num { color: var(--blue); }
        .stat-card.green .num { color: var(--green); }
        .stat-card.orange .num { color: var(--orange); }
        .stat-card.red .num { color: var(--red); }
        .stat-card.purple .num { color: var(--purple); }

        /* â”€â”€ CARD â”€â”€ */
        .card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--r); padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 16px;
        }
        .card-title {
            font-size: 15px; font-weight: 700; color: var(--text);
            margin-bottom: 20px; display: flex; align-items: center; gap: 8px;
        }

        /* â”€â”€ FORM â”€â”€ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        .fg { display: flex; flex-direction: column; gap: 6px; }
        .fg.full { grid-column: 1 / -1; }
        .fg label {
            font-size: 12px; font-weight: 700; color: var(--text3);
            text-transform: uppercase; letter-spacing: .4px;
        }
        .fg input, .fg select, .fg textarea {
            background: var(--bg); border: 1.5px solid var(--border);
            border-radius: var(--r2); padding: 11px 14px;
            color: var(--text); font-size: 14px; font-weight: 500;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: border-color .2s, box-shadow .2s;
        }
        .fg input:focus, .fg select:focus, .fg textarea:focus {
            outline: none; border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(59,110,248,.12);
            background: var(--white);
        }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn {
            padding: 11px 20px; border-radius: var(--r2);
            font-size: 14px; font-weight: 700; cursor: pointer; border: none;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all .2s; display: inline-flex; align-items: center; gap: 7px;
        }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .btn-primary { background: var(--blue); color: white; box-shadow: 0 2px 8px rgba(59,110,248,.3); }
        .btn-primary:hover:not(:disabled) { background: var(--blue-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,110,248,.4); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover { opacity: .9; }
        .btn-warning { background: var(--orange); color: white; }
        .btn-warning:hover { opacity: .9; }
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { opacity: .9; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-purple:hover { opacity: .9; }
        .btn-outline {
            background: white; color: var(--text2);
            border: 1.5px solid var(--border2);
        }
        .btn-outline:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-soft); }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }

        /* â”€â”€ FILTER BAR â”€â”€ */
        .filter-bar {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--r); padding: 16px 20px;
            display: flex; gap: 12px; flex-wrap: wrap;
            align-items: flex-end; margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        .filter-bar select, .filter-bar input {
            background: var(--bg); border: 1.5px solid var(--border);
            border-radius: var(--r2); padding: 9px 14px;
            color: var(--text); font-size: 13px; font-weight: 500;
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-width: 150px;
        }
        .filter-bar select:focus, .filter-bar input:focus {
            outline: none; border-color: var(--blue);
        }

        /* â”€â”€ ARTICLE ITEMS â”€â”€ */
        .article-item {
            background: var(--white); border: 1.5px solid var(--border);
            border-radius: var(--r); padding: 18px 20px;
            margin-bottom: 10px; cursor: pointer;
            transition: all .18s; box-shadow: var(--shadow);
        }
        .article-item:hover { border-color: var(--blue); box-shadow: var(--shadow-md); transform: translateY(-1px); }

        .item-head {
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 12px; margin-bottom: 10px;
        }
        .item-title { font-size: 15px; font-weight: 700; color: var(--text); }
        .item-ref { font-size: 12px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

        .item-meta { display: flex; flex-wrap: wrap; gap: 14px; }
        .meta { font-size: 12px; color: var(--text3); display: flex; align-items: center; gap: 4px; }
        .meta strong { color: var(--text2); font-weight: 600; }

        /* â”€â”€ BADGES â”€â”€ */
        .badge {
            padding: 4px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700; white-space: nowrap;
        }
        .b-stock { background: var(--green-soft); color: var(--green); border: 1px solid var(--green-border); }
        .b-navette { background: var(--blue-soft); color: var(--blue); border: 1px solid #c7d7fd; }
        .b-pret { background: var(--orange-soft); color: var(--orange); border: 1px solid var(--orange-border); }
        .b-sorti { background: var(--bg2); color: var(--text3); border: 1px solid var(--border2); }
        .b-sav { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }
        .b-retard { background: var(--red); color: white; }
        .b-purple { background: var(--purple-soft); color: var(--purple); border: 1px solid #ddd6fe; }

        /* â”€â”€ QR â”€â”€ */
        .qr-box {
            text-align: center; padding: 32px 24px;
            background: linear-gradient(135deg, var(--blue-soft), #f0f4ff);
            border: 1.5px solid #c7d7fd; border-radius: var(--r);
            margin-top: 20px;
        }
        #qrcode {
            display: inline-block; background: white; padding: 16px;
            border-radius: var(--r2); margin: 16px 0;
            box-shadow: var(--shadow-md);
        }

        /* â”€â”€ MODAL â”€â”€ */
        .overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(17,24,39,.4); z-index: 200;
            align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(4px);
        }
        .overlay.active { display: flex; }

        .modal {
            background: var(--white); border-radius: 16px;
            padding: 0; max-width: 620px; width: 100%;
            max-height: 92vh; overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-top {
            padding: 24px 28px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: flex-start;
            position: sticky; top: 0; background: white; z-index: 2;
        }

        .modal-close {
            width: 30px; height: 30px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg);
            color: var(--text3); font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all .15s;
        }
        .modal-close:hover { background: var(--red-soft); color: var(--red); border-color: var(--red-border); }

        .modal-body { padding: 24px 28px; }

        /* â”€â”€ DETAIL GRID â”€â”€ */
        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; margin-bottom: 20px;
        }
        .detail-field {
            background: var(--bg); border-radius: var(--r2);
            padding: 12px 14px; border: 1px solid var(--border);
        }
        .detail-field .k { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; }
        .detail-field .v { font-size: 14px; font-weight: 600; color: var(--text); }
        .detail-field.full { grid-column: 1 / -1; }

        /* â”€â”€ HISTORIQUE â”€â”€ */
        .histo {
            padding: 13px 15px;
            border-left: 3px solid var(--blue);
            background: var(--bg);
            border-radius: 0 var(--r2) var(--r2) 0;
            margin-bottom: 8px;
        }
        .histo-date { font-size: 11px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
        .histo-action { font-size: 13px; font-weight: 700; color: var(--text); margin: 3px 0; }
        .histo-detail { font-size: 12px; color: var(--text3); }

        /* â”€â”€ ALERTS â”€â”€ */
        .alert-item {
            padding: 14px 18px; border-radius: var(--r2);
            margin-bottom: 10px; cursor: pointer;
            transition: all .15s; display: flex; gap: 12px; align-items: flex-start;
        }
        .alert-item:hover { transform: translateX(3px); }
        .alert-item.danger { background: var(--red-soft); border: 1.5px solid var(--red-border); }
        .alert-item.warning { background: var(--orange-soft); border: 1.5px solid var(--orange-border); }

        /* â”€â”€ PRENOM BAR â”€â”€ */
        .prenom-bar {
            background: var(--blue-soft); border: 1.5px solid #c7d7fd;
            border-radius: var(--r2); padding: 14px 16px;
            display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
        }
        .prenom-bar label { font-size: 13px; font-weight: 700; color: var(--blue); white-space: nowrap; }
        .prenom-bar input {
            flex: 1; background: white; border: 1.5px solid #c7d7fd;
            border-radius: var(--r2); padding: 9px 14px;
            color: var(--text); font-size: 14px; font-weight: 500;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .prenom-bar input:focus { outline: none; border-color: var(--blue); }

        /* â”€â”€ DIVIDER â”€â”€ */
        .divider { height: 1px; background: var(--border); margin: 20px 0; }

        /* â”€â”€ SECTION HEADER â”€â”€ */
        .section-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
        }
        .section-header h3 { font-size: 14px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .4px; }

        /* â”€â”€ EMPTY â”€â”€ */
        .empty { text-align: center; padding: 48px 20px; color: var(--text3); }
        .empty .ico { font-size: 40px; margin-bottom: 12px; }
        .empty p { font-size: 14px; }

        /* â”€â”€ QTY â”€â”€ */
        .qty-display {
            display: inline-flex; align-items: baseline; gap: 4px;
        }
        .qty-big { font-size: 22px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .qty-big.ok { color: var(--green); }
        .qty-big.low { color: var(--orange); }
        .qty-big.empty { color: var(--red); }
        .qty-of { font-size: 12px; color: var(--text3); }

        /* â”€â”€ SUB TABS (PrÃªts) â”€â”€ */
        .sub-tabs {
            display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .sub-tab {
            padding: 8px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: 1.5px solid var(--border); background: var(--white);
            color: var(--text3); font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all .15s;
        }
        .sub-tab:hover { border-color: var(--blue); color: var(--blue); }
        .sub-tab.active { background: var(--blue); color: white; border-color: var(--blue); }
        .sub-tab.warn.active { background: var(--orange); border-color: var(--orange); }
        .sub-tab.danger.active { background: var(--red); border-color: var(--red); }
        .sub-tab.purple.active { background: var(--purple); border-color: var(--purple); }

        @media (max-width: 640px) {
            .page { padding: 16px; }
            .header { padding: 0 16px; }
            .tabs { padding: 0 16px; }
            .detail-grid { grid-template-columns: 1fr; }
            .brand-sub { display: none; }
            .stats-row { grid-template-columns: repeat(2,1fr); }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="brand">
        <div class="brand-icon">ğŸ“¦</div>
        <div>
            <div class="brand-name">HMC Stock</div>
            <div class="brand-sub">Gestion multi-magasins</div>
        </div>
    </div>
    <div class="header-right">
        <div class="pill loading" id="statusPill">ğŸ”„ Connexion...</div>
        <button class="btn-sm" onclick="loadData()">â†» Actualiser</button>
    </div>
</div>

<!-- TABS -->
<div class="tabs">
    <button class="tab active" onclick="switchTab('reception',this)">ğŸ“¥ RÃ©ception</button>
    <button class="tab" onclick="switchTab('navettes',this)">ğŸšš Navettes</button>
    <button class="tab" onclick="switchTab('stock',this)">ğŸ“¦ Stock</button>
    <button class="tab" onclick="switchTab('prets',this)">ğŸ”„ PrÃªts <span class="tab-badge" id="retardBadge" style="display:none">0</span></button>
    <button class="tab" onclick="switchTab('alertes',this)">ğŸ”” Alertes <span class="tab-badge" id="alertBadge" style="display:none">0</span></button>
</div>

<!-- PAGES -->
<div class="page">

    <!-- â•â•â• RÃ‰CEPTION â•â•â• -->
    <div id="reception" class="pane active">
        <div class="page-title">ğŸ“¥ RÃ©ception d'Article</div>
        <div class="card">
            <form id="receptionForm">
                <div class="form-grid">
                    <div class="fg">
                        <label>Magasin *</label>
                        <select id="f_magasin" required>
                            <option value="">SÃ©lectionner...</option>
                            <option>Lattes</option><option>VedÃ¨ne</option>
                            <option>Aix</option><option>NÃ®mes</option><option>Vitrolles</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Type *</label>
                        <select id="f_type" required onchange="toggleQty()">
                            <option value="">SÃ©lectionner...</option>
                            <option value="Navette">ğŸšš Navette (commande client)</option>
                            <option value="Stock">ğŸ“¦ Stock (consommables)</option>
                            <option value="PrÃªt">ğŸ”„ Article PrÃªt</option>
                            <option value="SAV">ğŸ”§ SAV</option>
                        </select>
                    </div>
                    <div class="fg">
                        <label>Nom du Client *</label>
                        <input id="f_client" type="text" required placeholder="Nom du client">
                    </div>
                    <div class="fg">
                        <label>NÂ° AR</label>
                        <input id="f_ar" type="text" placeholder="NumÃ©ro AR">
                    </div>
                    <div class="fg">
                        <label>Article *</label>
                        <input id="f_article" type="text" required placeholder="Nom de l'article">
                    </div>
                    <div class="fg">
                        <label>RÃ©fÃ©rence *</label>
                        <input id="f_ref" type="text" required placeholder="RÃ©fÃ©rence">
                    </div>
                    <div class="fg">
                        <label>Nombre de Colis *</label>
                        <input id="f_colis" type="number" min="1" value="1" required>
                    </div>
                    <div class="fg" id="qtyGroup" style="display:none">
                        <label>QuantitÃ© en Stock *</label>
                        <input id="f_qty" type="number" min="1" value="1">
                    </div>
                    <div class="fg">
                        <label>Emplacement *</label>
                        <input id="f_emplacement" type="text" required placeholder="Ex: Rayon A, Ã‰tagÃ¨re 3">
                    </div>
                    <div class="fg">
                        <label>Votre PrÃ©nom *</label>
                        <input id="f_prenom" type="text" required placeholder="Votre prÃ©nom">
                    </div>
                    <div class="fg full">
                        <label>Notes</label>
                        <textarea id="f_notes" rows="2" placeholder="Observations..."></textarea>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit" class="btn btn-primary" id="submitBtn">âœ… GÃ©nÃ©rer le QR Code</button>
                </div>
            </form>
        </div>

        <div id="qrResult" style="display:none">
            <div class="qr-box">
                <div style="font-size:16px;font-weight:800;color:var(--text)">âœ… QR Code gÃ©nÃ©rÃ© !</div>
                <p style="font-size:13px;color:var(--text3);margin-top:6px;">Scannez avec l'appareil photo pour accÃ©der directement Ã  l'article</p>
                <div id="qrcode"></div>
                <div style="display:flex;gap:10px;justify-content:center">
                    <button class="btn btn-primary" onclick="printQR()">ğŸ–¨ï¸ Imprimer</button>
                    <button class="btn btn-outline" onclick="resetForm()">â• Nouvel article</button>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â• NAVETTES â•â•â• -->
    <div id="navettes" class="pane">
        <div class="page-title">ğŸšš Suivi des Navettes</div>
        <div class="stats-row" id="navStats"></div>
        <div class="filter-bar">
            <select id="n_mag" onchange="renderNavettes()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>VedÃ¨ne</option>
                <option>Aix</option><option>NÃ®mes</option><option>Vitrolles</option>
            </select>
            <select id="n_stat" onchange="renderNavettes()">
                <option value="">Tous les statuts</option>
                <option value="Stock">En stock</option>
                <option value="Sorti">Sorti</option>
                <option value="SAV">SAV</option>
            </select>
            <input id="n_search" placeholder="ğŸ” Rechercher client, article..." oninput="renderNavettes()" style="flex:1;min-width:200px;">
        </div>
        <div id="navetteList"></div>
    </div>

    <!-- â•â•â• STOCK â•â•â• -->
    <div id="stock" class="pane">
        <div class="page-title">ğŸ“¦ Gestion du Stock</div>
        <div class="stats-row" id="stockStats"></div>
        <div class="filter-bar">
            <select id="s_mag" onchange="renderStock()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>VedÃ¨ne</option>
                <option>Aix</option><option>NÃ®mes</option><option>Vitrolles</option>
            </select>
            <input id="s_search" placeholder="ğŸ” Rechercher article, rÃ©fÃ©rence..." oninput="renderStock()" style="flex:1;min-width:200px;">
        </div>
        <div id="stockList"></div>
    </div>

    <!-- â•â•â• PRÃŠTS â•â•â• -->
    <div id="prets" class="pane">
        <div class="page-title">ğŸ”„ Gestion des PrÃªts</div>
        <div class="stats-row" id="pretsStats"></div>

        <div class="filter-bar">
            <select id="p_mag" onchange="renderPrets()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>VedÃ¨ne</option>
                <option>Aix</option><option>NÃ®mes</option><option>Vitrolles</option>
            </select>
        </div>

        <!-- Sous-onglets -->
        <div class="sub-tabs">
            <button class="sub-tab purple active" id="stab_dispo" onclick="setPretTab('dispo')">ğŸŸ£ Disponibles Ã  prÃªter</button>
            <button class="sub-tab active" id="stab_encours" onclick="setPretTab('encours')">ğŸ”µ En cours de prÃªt</button>
            <button class="sub-tab warn" id="stab_bientot" onclick="setPretTab('bientot')">ğŸŸ¡ Retour bientÃ´t</button>
            <button class="sub-tab danger" id="stab_retard" onclick="setPretTab('retard')">ğŸ”´ En retard</button>
        </div>

        <div id="pretsList"></div>
    </div>

    <!-- â•â•â• ALERTES â•â•â• -->
    <div id="alertes" class="pane">
        <div class="page-title">ğŸ”” Alertes</div>
        <div class="filter-bar">
            <select id="a_mag" onchange="renderAlertes()">
                <option value="">Tous les magasins</option>
                <option>Lattes</option><option>VedÃ¨ne</option>
                <option>Aix</option><option>NÃ®mes</option><option>Vitrolles</option>
            </select>
        </div>
        <div id="alertList"></div>
    </div>

</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
    <div class="modal">
        <div class="modal-top">
            <div>
                <div style="font-size:18px;font-weight:800;color:var(--text)" id="mTitle">Article</div>
                <div style="font-size:12px;color:var(--text3);margin-top:3px" id="mSub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="mBody"></div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸  REMPLACEZ VOTRE_URL_ICI  âš ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://script.google.com/macros/s/AKfycbw4iOVF_nKgOsFhdXDdJRGziUPDKw-qAj4QLU3CadpeqBYVyTLiUxa9WM5bGFUDsFmAiA/exec';
const APP_URL = window.location.origin + window.location.pathname;

let articles = [];
let histoCache = {};
let currentPretTab = 'dispo';

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
    if (API_URL === 'VOTRE_URL_ICI') {
        alert('âš ï¸ Configurez votre URL Google Apps Script dans le code.');
        return;
    }
    const p = new URLSearchParams(window.location.search).get('article');
    if (p) loadData().then(() => openModal(p));
    else loadData();
});

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function apiCall(params) {
    return new Promise((resolve) => {
        const cb = 'cb' + Date.now() + Math.random().toString(36).slice(2);
        let done = false;

        const cleanup = () => {
            done = true;
            delete window[cb];
            const s = document.getElementById(cb);
            if (s) s.remove();
        };

        window[cb] = (data) => { cleanup(); resolve(data || {}); };

        const qs = new URLSearchParams({ ...params, callback: cb }).toString();
        const s = document.createElement('script');
        s.id = cb;
        s.src = `${API_URL}?${qs}`;
        s.onerror = () => { cleanup(); resolve({ error: 'Network error' }); };

        // timeout 20s
        setTimeout(() => {
            if (!done) { cleanup(); resolve({ error: 'Timeout' }); }
        }, 20000);

        document.body.appendChild(s);
    });
}

function loadData() {
    setStatus('loading', 'ğŸ”„ Chargement...');
    return new Promise(async (resolve, reject) => {
        const data = await apiCall({ action: 'getAllArticles', t: Date.now() });
        if (data.error) {
            setStatus('err', 'âŒ DÃ©connectÃ©');
            reject();
            return;
        }
        articles = parseArticles(Array.isArray(data) ? data : []);
        setStatus('ok', `âœ… ${articles.length} articles`);
        refreshBadges();
        refreshCurrentPane();
        resolve();
    });
}

function parseArticles(data) {
    return data.map(r => ({
        id: r.ID || '', magasin: r.Magasin || '', type: r.Type || '',
        client: r.Client || '', numeroAR: r.NumeroAR || '',
        article: r.Article || '', reference: r.Reference || '',
        nombreColis: parseInt(r.NombreColis) || 1,
        quantiteStock: (r.QuantiteStock !== null && r.QuantiteStock !== '') ? parseInt(r.QuantiteStock) : null,
        quantiteInitiale: (r.QuantiteInitiale !== null && r.QuantiteInitiale !== '') ? parseInt(r.QuantiteInitiale) : null,
        emplacement: r.Emplacement || '', kitchener: r.Kitchener || '',
        notes: r.Notes || '', statut: r.Statut || 'Stock',
        dateReception: r.DateReception || '', datePret: r.DatePret || '',
        prenomEmprunteur: r.PrenomEmprunteur || '',
        dateRetourPrevue: r.DateRetourPrevue || '',
        dateRetourReel: r.DateRetourReel || '',
        dateSortie: r.DateSortie || '', raisonSortie: r.RaisonSortie || ''
    }));
}

function setStatus(cls, msg) {
    const el = document.getElementById('statusPill');
    el.className = 'pill ' + cls;
    el.textContent = msg;
}

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById(name).classList.add('active');
    refreshCurrentPane();
}

function refreshCurrentPane() {
    const active = document.querySelector('.pane.active');
    if (!active) return;
    const id = active.id;
    if (id === 'navettes') renderNavettes();
    if (id === 'stock') renderStock();
    if (id === 'prets') renderPrets();
    if (id === 'alertes') renderAlertes();
}

function refreshBadges() {
    const retards = articles.filter(a => a.statut === 'PrÃªt' && a.dateRetourPrevue && new Date(a.dateRetourPrevue) < new Date()).length;
    const el = document.getElementById('retardBadge');
    el.textContent = retards; el.style.display = retards > 0 ? 'inline' : 'none';

    const alertes = articles.filter(a =>
        (a.statut === 'PrÃªt' && a.dateRetourPrevue && new Date(a.dateRetourPrevue) < new Date()) ||
        (a.type === 'Stock' && a.quantiteStock !== null && a.quantiteStock <= 0)
    ).length;
    const el2 = document.getElementById('alertBadge');
    el2.textContent = alertes; el2.style.display = alertes > 0 ? 'inline' : 'none';
}

// â”€â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleQty() {
    const t = document.getElementById('f_type').value;
    const g = document.getElementById('qtyGroup');
    g.style.display = t === 'Stock' ? 'flex' : 'none';
    document.getElementById('f_qty').required = t === 'Stock';
}

document.getElementById('receptionForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = 'â³ Enregistrement...';

    const type = document.getElementById('f_type').value;
    const id = 'ART-' + Date.now();
    const now = new Date().toISOString();

    const params = {
        action: 'addArticle', ID: id,
        Magasin: document.getElementById('f_magasin').value,
        Type: type,
        Client: document.getElementById('f_client').value,
        NumeroAR: document.getElementById('f_ar').value || '',
        Article: document.getElementById('f_article').value,
        Reference: document.getElementById('f_ref').value,
        NombreColis: document.getElementById('f_colis').value,
        QuantiteStock: type === 'Stock' ? document.getElementById('f_qty').value : '',
        QuantiteInitiale: type === 'Stock' ? document.getElementById('f_qty').value : '',
        Emplacement: document.getElementById('f_emplacement').value,
        Kitchener: document.getElementById('f_prenom').value,
        Notes: document.getElementById('f_notes').value || '',
        Statut: 'Stock',
        DateReception: now,
        Historique: 'true'
    };

    const r = await apiCall(params);

    btn.disabled = false; btn.textContent = 'âœ… GÃ©nÃ©rer le QR Code';

    if (r.error) {
        alert('âŒ Erreur lors de la sauvegarde : ' + r.error + '\n\nVÃ©rifiez votre URL Google Apps Script.');
        return;
    }

    // QR code avec URL directe
    const url = `${APP_URL}?article=${id}`;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: url, width: 220, height: 220 });
    document.getElementById('receptionForm').style.display = 'none';
    document.getElementById('qrResult').style.display = 'block';
    setTimeout(() => loadData(), 2000);
});

function resetForm() {
    document.getElementById('receptionForm').reset();
    document.getElementById('receptionForm').style.display = 'block';
    document.getElementById('qrResult').style.display = 'none';
    document.getElementById('qtyGroup').style.display = 'none';
}

function printQR() {
    const w = window.open('', '', 'width=400,height=500');
    w.document.write('<html><body style="text-align:center;padding:40px;font-family:sans-serif;">');
    w.document.write(document.getElementById('qrResult').innerHTML);
    w.document.write('</body></html>');
    w.document.close(); w.print();
}

// â”€â”€â”€ NAVETTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNavettes() {
    const mag = document.getElementById('n_mag').value;
    const stat = document.getElementById('n_stat').value;
    const q = document.getElementById('n_search').value.toLowerCase();

    let list = articles.filter(a => a.type === 'Navette');
    if (mag) list = list.filter(a => a.magasin === mag);
    if (stat) list = list.filter(a => a.statut === stat);
    if (q) list = list.filter(a =>
        a.article.toLowerCase().includes(q) ||
        a.client.toLowerCase().includes(q) ||
        a.reference.toLowerCase().includes(q)
    );

    const all = articles.filter(a => a.type === 'Navette');
    document.getElementById('navStats').innerHTML = `
        <div class="stat-card blue"><div class="num">${all.length}</div><div class="lbl">Total</div></div>
        <div class="stat-card green"><div class="num">${all.filter(a=>a.statut==='Stock').length}</div><div class="lbl">En stock</div></div>
        <div class="stat-card orange"><div class="num">${all.filter(a=>a.statut==='Sorti').length}</div><div class="lbl">Sortis</div></div>
        <div class="stat-card red"><div class="num">${all.filter(a=>a.statut==='SAV').length}</div><div class="lbl">SAV</div></div>
    `;

    renderList(list, 'navetteList');
}

// â”€â”€â”€ STOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStock() {
    const mag = document.getElementById('s_mag').value;
    const q = document.getElementById('s_search').value.toLowerCase();

    let list = articles.filter(a => a.type === 'Stock');
    if (mag) list = list.filter(a => a.magasin === mag);
    if (q) list = list.filter(a =>
        a.article.toLowerCase().includes(q) ||
        a.reference.toLowerCase().includes(q)
    );

    const all = articles.filter(a => a.type === 'Stock');
    const totalQty = all.reduce((s, a) => s + (a.quantiteStock || 0), 0);

    document.getElementById('stockStats').innerHTML = `
        <div class="stat-card green"><div class="num">${all.filter(a=>a.statut==='Stock').length}</div><div class="lbl">RÃ©fÃ©rences</div></div>
        <div class="stat-card blue"><div class="num">${totalQty}</div><div class="lbl">QuantitÃ© totale</div></div>
        <div class="stat-card orange"><div class="num">${all.filter(a=>a.quantiteStock!==null&&a.quantiteStock>0&&a.quantiteStock<5).length}</div><div class="lbl">Stocks faibles</div></div>
        <div class="stat-card red"><div class="num">${all.filter(a=>a.quantiteStock===0).length}</div><div class="lbl">Ã‰puisÃ©s</div></div>
    `;

    if (!list.length) {
        document.getElementById('stockList').innerHTML = '<div class="empty"><div class="ico">ğŸ“¦</div><p>Aucun article en stock</p></div>';
        return;
    }

    document.getElementById('stockList').innerHTML = list.map(a => {
        const qty = a.quantiteStock;
        const qCls = qty === null ? '' : (qty === 0 ? 'empty' : qty < 5 ? 'low' : 'ok');
        const statBadge = a.statut === 'Sorti' ? 'b-sorti' : 'b-stock';
        const statLabel = a.statut === 'Sorti' ? 'Ã‰puisÃ©' : 'En stock';
        return `
        <div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div>
                    <div class="item-title">${a.article}</div>
                    <div class="item-ref">${a.reference}</div>
                </div>
                <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                    <span class="badge ${statBadge}">${statLabel}</span>
                    ${qty !== null ? `<div class="qty-display"><span class="qty-big ${qCls}">${qty}</span><span class="qty-of">/ ${a.quantiteInitiale}</span></div>` : ''}
                </div>
            </div>
            <div class="item-meta">
                <span class="meta">ğŸª <strong>${a.magasin}</strong></span>
                <span class="meta">ğŸ“ <strong>${a.emplacement}</strong></span>
                <span class="meta">ğŸ‘¤ <strong>${a.client}</strong></span>
            </div>
        </div>`;
    }).join('');
}

// â”€â”€â”€ PRÃŠTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPretTab(tab) {
    currentPretTab = tab;
    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
    const el = document.getElementById('stab_' + tab);
    if (el) el.classList.add('active');
    renderPrets();
}

function renderPrets() {
    const mag = document.getElementById('p_mag').value;

    const allPretType = articles.filter(a => a.type === 'PrÃªt' || a.type === 'Navette' || a.type === 'Stock');
    const dispo = articles.filter(a => a.statut === 'Stock' && a.type === 'PrÃªt');
    const encours = articles.filter(a => a.statut === 'PrÃªt');
    const retards = encours.filter(a => a.dateRetourPrevue && new Date(a.dateRetourPrevue) < new Date());
    const bientot = encours.filter(a => {
        if (!a.dateRetourPrevue) return false;
        const d = (new Date(a.dateRetourPrevue) - new Date()) / 86400000;
        return d >= 0 && d <= 3;
    });

    document.getElementById('pretsStats').innerHTML = `
        <div class="stat-card purple"><div class="num">${dispo.length}</div><div class="lbl">Disponibles</div></div>
        <div class="stat-card blue"><div class="num">${encours.length}</div><div class="lbl">En cours</div></div>
        <div class="stat-card orange"><div class="num">${bientot.length}</div><div class="lbl">Retour bientÃ´t</div></div>
        <div class="stat-card red"><div class="num">${retards.length}</div><div class="lbl">En retard</div></div>
    `;

    // Mise Ã  jour labels des sub-tabs
    document.getElementById('stab_dispo').textContent = `ğŸŸ£ Disponibles (${dispo.length})`;
    document.getElementById('stab_encours').textContent = `ğŸ”µ En cours (${encours.length})`;
    document.getElementById('stab_bientot').textContent = `ğŸŸ¡ Retour bientÃ´t (${bientot.length})`;
    document.getElementById('stab_retard').textContent = `ğŸ”´ En retard (${retards.length})`;
    // Restaurer la classe active
    document.getElementById('stab_' + currentPretTab).classList.add('active');

    let list = [];
    if (currentPretTab === 'dispo') list = dispo;
    else if (currentPretTab === 'encours') list = encours;
    else if (currentPretTab === 'bientot') list = bientot;
    else if (currentPretTab === 'retard') list = retards;

    if (mag) list = list.filter(a => a.magasin === mag);

    if (!list.length) {
        const msgs = {
            dispo: 'ğŸ“¦ Aucun article disponible au prÃªt',
            encours: 'ğŸ”„ Aucun prÃªt en cours',
            bientot: 'âœ… Aucun retour imminent',
            retard: 'âœ… Aucun retard !'
        };
        document.getElementById('pretsList').innerHTML = `<div class="empty"><div class="ico">${currentPretTab==='retard'?'âœ…':'ğŸ“‹'}</div><p>${msgs[currentPretTab]}</p></div>`;
        return;
    }

    document.getElementById('pretsList').innerHTML = list.map(a => {
        if (currentPretTab === 'dispo') {
            return `
            <div class="article-item" onclick="openModal('${a.id}')">
                <div class="item-head">
                    <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                    <span class="badge b-purple">Disponible</span>
                </div>
                <div class="item-meta">
                    <span class="meta">ğŸª <strong>${a.magasin}</strong></span>
                    <span class="meta">ğŸ“ <strong>${a.emplacement}</strong></span>
                    <span class="meta">ğŸ‘¤ <strong>${a.client}</strong></span>
                </div>
            </div>`;
        }

        const retard = a.dateRetourPrevue && new Date(a.dateRetourPrevue) < new Date();
        const diff = a.dateRetourPrevue ? Math.ceil((new Date(a.dateRetourPrevue) - new Date()) / 86400000) : null;
        return `
        <div class="article-item" onclick="openModal('${a.id}')" style="${retard ? 'border-color:var(--red-border);background:var(--red-soft)' : ''}">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <span class="badge ${retard ? 'b-retard' : 'b-pret'}">
                    ${retard ? `âš ï¸ +${Math.abs(diff)}j de retard` : diff !== null ? `â†©ï¸ J-${diff}` : 'En prÃªt'}
                </span>
            </div>
            <div class="item-meta">
                <span class="meta">ğŸª <strong>${a.magasin}</strong></span>
                <span class="meta">ğŸ‘¤ PrÃªtÃ© Ã  <strong>${a.prenomEmprunteur}</strong></span>
                <span class="meta">ğŸ“… Le <strong>${a.datePret ? new Date(a.datePret).toLocaleDateString('fr-FR') : '?'}</strong></span>
                ${a.dateRetourPrevue ? `<span class="meta">â†©ï¸ Retour <strong>${new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR')}</strong></span>` : ''}
                <span class="meta">ğŸ“¦ Client: <strong>${a.client}</strong></span>
            </div>
        </div>`;
    }).join('');
}

// â”€â”€â”€ ALERTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAlertes() {
    const mag = document.getElementById('a_mag').value;
    const list = mag ? articles.filter(a => a.magasin === mag) : articles;
    let alertes = [];

    list.filter(a => a.statut === 'PrÃªt' && a.dateRetourPrevue && new Date(a.dateRetourPrevue) < new Date())
        .forEach(a => {
            const j = Math.floor((new Date() - new Date(a.dateRetourPrevue)) / 86400000);
            alertes.push({ type: 'danger', t: `PrÃªt en retard â€” ${a.article}`, m: `${a.magasin} Â· PrÃªtÃ© Ã  ${a.prenomEmprunteur} Â· ${j} jour(s) de retard`, id: a.id });
        });

    list.filter(a => { if (a.statut !== 'PrÃªt' || !a.dateRetourPrevue) return false; const d = (new Date(a.dateRetourPrevue)-new Date())/86400000; return d>=0&&d<=3; })
        .forEach(a => {
            const j = Math.ceil((new Date(a.dateRetourPrevue)-new Date())/86400000);
            alertes.push({ type: 'warning', t: `Retour bientÃ´t â€” ${a.article}`, m: `${a.magasin} Â· ${a.prenomEmprunteur} Â· dans ${j} jour(s)`, id: a.id });
        });

    list.filter(a => a.type==='Stock' && a.quantiteStock!==null && a.quantiteStock>0 && a.quantiteStock<5)
        .forEach(a => alertes.push({ type: 'warning', t: `Stock faible â€” ${a.article}`, m: `${a.magasin} Â· ${a.quantiteStock} unitÃ©(s) restante(s)`, id: a.id }));

    list.filter(a => a.type==='Stock' && a.quantiteStock===0)
        .forEach(a => alertes.push({ type: 'danger', t: `Stock Ã©puisÃ© â€” ${a.article}`, m: `${a.magasin} Â· Ã€ rÃ©approvisionner`, id: a.id }));

    if (!alertes.length) {
        document.getElementById('alertList').innerHTML = '<div class="empty"><div class="ico">âœ…</div><p>Aucune alerte â€” tout est en ordre !</p></div>';
        return;
    }

    document.getElementById('alertList').innerHTML = alertes.map(al => `
        <div class="alert-item ${al.type}" onclick="openModal('${al.id}')">
            <span style="font-size:20px">${al.type==='danger'?'ğŸ”´':'ğŸŸ¡'}</span>
            <div>
                <div style="font-size:14px;font-weight:700;color:var(--text)">${al.t}</div>
                <div style="font-size:12px;color:var(--text3);margin-top:3px">${al.m}</div>
            </div>
        </div>`).join('');
}

// â”€â”€â”€ LISTE GÃ‰NÃ‰RIQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(list, containerId) {
    if (!list.length) {
        document.getElementById(containerId).innerHTML = '<div class="empty"><div class="ico">ğŸ“­</div><p>Aucun article</p></div>';
        return;
    }
    document.getElementById(containerId).innerHTML = list.map(a => {
        const bClass = { Stock: 'b-stock', PrÃªt: 'b-pret', Sorti: 'b-sorti', SAV: 'b-sav' }[a.statut] || 'b-stock';
        return `
        <div class="article-item" onclick="openModal('${a.id}')">
            <div class="item-head">
                <div><div class="item-title">${a.article}</div><div class="item-ref">${a.reference}</div></div>
                <span class="badge ${bClass}">${a.statut}</span>
            </div>
            <div class="item-meta">
                <span class="meta">ğŸª <strong>${a.magasin}</strong></span>
                <span class="meta">ğŸ‘¤ <strong>${a.client}</strong></span>
                <span class="meta">ğŸ“ <strong>${a.emplacement}</strong></span>
                ${a.numeroAR ? `<span class="meta">AR: <strong>${a.numeroAR}</strong></span>` : ''}
                ${a.nombreColis > 1 ? `<span class="meta">ğŸ“¦ <strong>${a.nombreColis} colis</strong></span>` : ''}
            </div>
        </div>`;
    }).join('');
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openModal(id) {
    const a = articles.find(x => x.id === id);
    if (!a) { alert('Article non trouvÃ©'); return; }

    document.getElementById('mTitle').textContent = a.article;
    document.getElementById('mSub').textContent = `${a.reference} Â· ${a.magasin} Â· ${a.type}`;
    document.getElementById('mBody').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3)">â³ Chargement...</div>';
    document.getElementById('overlay').classList.add('active');

    const histo = await loadHisto(id);

    const bClass = { Stock: 'b-stock', PrÃªt: 'b-pret', Sorti: 'b-sorti', SAV: 'b-sav' }[a.statut] || 'b-stock';
    const typeClass = { Navette: 'b-navette', Stock: 'b-stock', PrÃªt: 'b-purple', SAV: 'b-sav' }[a.type] || 'b-navette';

    let html = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
            <span class="badge ${typeClass}">${a.type}</span>
            <span class="badge ${bClass}">${a.statut}</span>
        </div>
        <div class="detail-grid">
            <div class="detail-field"><div class="k">Magasin</div><div class="v">${a.magasin}</div></div>
            <div class="detail-field"><div class="k">Client</div><div class="v">${a.client}</div></div>
            <div class="detail-field"><div class="k">RÃ©fÃ©rence</div><div class="v">${a.reference}</div></div>
            <div class="detail-field"><div class="k">Emplacement</div><div class="v">${a.emplacement}</div></div>
            ${a.numeroAR ? `<div class="detail-field"><div class="k">NÂ° AR</div><div class="v">${a.numeroAR}</div></div>` : ''}
            ${a.quantiteStock !== null ? `<div class="detail-field"><div class="k">QuantitÃ©</div><div class="v">${a.quantiteStock} / ${a.quantiteInitiale}</div></div>` : ''}
            <div class="detail-field"><div class="k">RÃ©ceptionnÃ© par</div><div class="v">${a.kitchener}</div></div>
            <div class="detail-field"><div class="k">Date rÃ©ception</div><div class="v">${a.dateReception ? new Date(a.dateReception).toLocaleDateString('fr-FR') : '?'}</div></div>
            ${a.notes ? `<div class="detail-field full"><div class="k">Notes</div><div class="v">${a.notes}</div></div>` : ''}
        </div>`;

    if (a.statut === 'PrÃªt') {
        html += `
        <div style="background:var(--orange-soft);border:1.5px solid var(--orange-border);border-radius:var(--r2);padding:14px;margin-bottom:16px;">
            <div style="font-weight:700;color:var(--orange)">ğŸ”„ En prÃªt</div>
            <div style="font-size:13px;color:var(--text2);margin-top:6px;">
                PrÃªtÃ© Ã  <strong>${a.prenomEmprunteur}</strong> depuis le <strong>${a.datePret ? new Date(a.datePret).toLocaleDateString('fr-FR') : '?'}</strong><br>
                Retour prÃ©vu le <strong>${a.dateRetourPrevue ? new Date(a.dateRetourPrevue).toLocaleDateString('fr-FR') : '?'}</strong>
            </div>
        </div>`;
    }

    // PrÃ©nom bar + actions
    html += `
    <div class="prenom-bar">
        <label>ğŸ‘¤ Votre prÃ©nom</label>
        <input type="text" id="actPrenom" placeholder="Obligatoire pour toute action">
    </div>
    <div class="btn-row">`;

    if (a.statut === 'Stock') {
        html += `
        <button class="btn btn-success" onclick="actSortir('${a.id}')">ğŸ“¤ Sortir</button>
        <button class="btn btn-warning" onclick="actPreter('${a.id}')">ğŸ”„ PrÃªter</button>
        <button class="btn btn-outline" onclick="actEmplacement('${a.id}')">ğŸ“ Emplacement</button>`;
        if (a.type === 'Stock') {
            html += `
        <button class="btn btn-primary" onclick="actSortirQte('${a.id}')">ğŸ“¦ Sortir quantitÃ©</button>
        <button class="btn btn-purple" onclick="actAjouterQte('${a.id}')">â• Ajouter stock</button>`;
        }
    }
    if (a.statut === 'PrÃªt') {
        html += `<button class="btn btn-success" onclick="actRetour('${a.id}')">â†©ï¸ Retour de prÃªt</button>`;
    }
    html += `</div>`;

    // Historique
    html += `<div class="divider"></div>
    <div style="font-size:13px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px;">ğŸ“œ Historique</div>`;

    if (!histo.length) {
        html += '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px;">Aucun historique disponible</div>';
    } else {
        html += histo.map(h => `
        <div class="histo">
            <div class="histo-date">${h.date ? new Date(h.date).toLocaleString('fr-FR') : '?'}</div>
            <div class="histo-action">${h.action} â€” ${h.utilisateur}</div>
            ${h.details ? `<div class="histo-detail">${h.details}</div>` : ''}
        </div>`).join('');
    }

    document.getElementById('mBody').innerHTML = html;
}

function closeModal() {
    document.getElementById('overlay').classList.remove('active');
}

// â”€â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPrenom() {
    const v = (document.getElementById('actPrenom')?.value || '').trim();
    if (!v) { alert('âš ï¸ Entrez votre prÃ©nom avant d\'effectuer cette action'); return null; }
    return v;
}

async function actSortir(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const raison = prompt('Raison de la sortie (TLE, Poseur, Client...) :');
    if (!raison) return;
    const a = articles.find(x => x.id === id);
    a.statut = 'Sorti'; a.dateSortie = new Date().toISOString(); a.raisonSortie = raison;
    await doUpdate(a);
    doHisto(id, 'Sortie', prenom, `Raison: ${raison}`);
    closeModal(); alert('âœ… Article sorti'); loadData();
}

async function actSortirQte(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const s = prompt(`QuantitÃ© Ã  sortir (stock actuel : ${a.quantiteStock}) :`);
    if (!s) return;
    const qte = parseInt(s);
    if (isNaN(qte) || qte <= 0) { alert('QuantitÃ© invalide'); return; }
    if (qte > a.quantiteStock) { alert(`Stock insuffisant â€” disponible : ${a.quantiteStock}`); return; }
    a.quantiteStock -= qte;
    if (a.quantiteStock === 0) a.statut = 'Sorti';
    await doUpdate(a);
    doHisto(id, 'Sortie stock', prenom, `${qte} unitÃ©(s) sortie(s) â€” Reste : ${a.quantiteStock}`);
    closeModal(); alert(`âœ… ${qte} unitÃ©(s) sortie(s) â€” Reste : ${a.quantiteStock}`); loadData();
}

async function actAjouterQte(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const s = prompt(`QuantitÃ© Ã  ajouter (stock actuel : ${a.quantiteStock || 0}) :`);
    if (!s) return;
    const qte = parseInt(s);
    if (isNaN(qte) || qte <= 0) { alert('QuantitÃ© invalide'); return; }
    a.quantiteStock = (a.quantiteStock || 0) + qte;
    a.quantiteInitiale = Math.max(a.quantiteInitiale || 0, a.quantiteStock);
    if (a.statut === 'Sorti') a.statut = 'Stock';
    await doUpdate(a);
    doHisto(id, 'Ajout stock', prenom, `+${qte} unitÃ©(s) â€” Nouveau stock : ${a.quantiteStock}`);
    closeModal(); alert(`âœ… Stock mis Ã  jour : ${a.quantiteStock} unitÃ©(s)`); loadData();
}

async function actPreter(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const emp = prompt('PrÃ©nom de l\'emprunteur :');
    if (!emp) return;
    const dateStr = prompt('Date de retour prÃ©vue (JJ/MM/AAAA) :');
    if (!dateStr) return;
    const [j, m, y] = dateStr.split('/');
    const a = articles.find(x => x.id === id);
    a.statut = 'PrÃªt'; a.datePret = new Date().toISOString();
    a.prenomEmprunteur = emp;
    a.dateRetourPrevue = new Date(y, m-1, j).toISOString();
    await doUpdate(a);
    doHisto(id, 'PrÃªt', prenom, `Ã€ ${emp} â€” Retour le ${dateStr}`);
    closeModal(); alert('âœ… PrÃªt enregistrÃ©'); loadData();
}

async function actRetour(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const emp = a.prenomEmprunteur;
    a.statut = 'Stock'; a.dateRetourReel = new Date().toISOString();
    await doUpdate(a);
    doHisto(id, 'Retour prÃªt', prenom, `RetournÃ© par ${emp}`);
    closeModal(); alert('âœ… Retour enregistrÃ©'); loadData();
}

async function actEmplacement(id) {
    const prenom = getPrenom(); if (!prenom) return;
    const a = articles.find(x => x.id === id);
    const n = prompt(`Nouvel emplacement (actuel : ${a.emplacement}) :`);
    if (!n) return;
    const ancien = a.emplacement; a.emplacement = n;
    await doUpdate(a);
    doHisto(id, 'Changement emplacement', prenom, `${ancien} â†’ ${n}`);
    closeModal(); alert('âœ… Emplacement mis Ã  jour'); loadData();
}

async function doUpdate(a) {
    return apiCall({
        action: 'updateArticle',
        ID: a.id, Magasin: a.magasin, Type: a.type, Client: a.client,
        NumeroAR: a.numeroAR || '', Article: a.article, Reference: a.reference,
        NombreColis: a.nombreColis,
        QuantiteStock: a.quantiteStock !== null ? a.quantiteStock : '',
        QuantiteInitiale: a.quantiteInitiale !== null ? a.quantiteInitiale : '',
        Emplacement: a.emplacement, Kitchener: a.kitchener, Notes: a.notes || '',
        Statut: a.statut, DateReception: a.dateReception,
        DatePret: a.datePret || '', PrenomEmprunteur: a.prenomEmprunteur || '',
        DateRetourPrevue: a.dateRetourPrevue || '', DateRetourReel: a.dateRetourReel || '',
        DateSortie: a.dateSortie || '', RaisonSortie: a.raisonSortie || ''
    });
}

function doHisto(id, action, user, details = '') {
    delete histoCache[id];
    apiCall({ action: 'addHistorique', ArticleID: id, Action: action,
        Date: new Date().toISOString(), Utilisateur: user, Details: details });
}

async function loadHisto(id) {
    if (histoCache[id]) return histoCache[id];
    const data = await apiCall({ action: 'getHistorique', articleId: id });
    histoCache[id] = Array.isArray(data) ? data : [];
    return histoCache[id];
}

// Actualisation auto
setInterval(() => loadData(), 60000);
</script>
</body>
</html>
